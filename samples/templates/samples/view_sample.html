<!DOCTYPE html>
<html>
<head>
    <title>View Samples</title>
    <!-- Include necessary CSS/JS similar to create_sample.html -->
</head>
<body>

    <div class="table-responsive">
        <table id="samplesTable" border="1">
            <thead>
                <tr>
                    <th class="col-select">Select</th>
                    <th class="col-opportunity">Opp Number</th>
                    <th class="col-customer">Customer</th>
                    <th class="col-rsm">RSM</th>
                    <th class="col-date">Date Received</th>
                    <th class="col-description">Description</th>
                    <th class="col-id">ID</th>
                    <th class="col-location">Location</th>
                    <th class="col-pictures">Pictures</th>
                    <th class="col-documentation">Documentation</th>
                </tr>
                <tr>
                    <th class="col-select"></th>
                    <th class="col-opportunity"><div class="filter-wrapper"><input type="text" id="opportunityFilter" placeholder="Filter Opportunity" class="filter-input" onkeyup="filterTable()"></div></th>
                    <th class="col-customer"><div class="filter-wrapper"><input type="text" id="customerFilter" placeholder="Filter Customer" class="filter-input" onkeyup="filterTable()"></div></th>
                    <th class="col-rsm"><div class="filter-wrapper"><input type="text" id="rsmFilter" placeholder="Filter RSM" class="filter-input" onkeyup="filterTable()"></div></th>
                    <th class="col-date"><div class="filter-wrapper"><input type="text" id="dateFilter" placeholder="Filter Date" class="filter-input" onkeyup="filterTable()"></div></th>
                    <th class="col-description"><div class="filter-wrapper"><input type="text" id="descriptionFilter" placeholder="Filter Description" class="filter-input" onkeyup="filterTable()"></div></th>
                    <th class="col-id"><div class="filter-wrapper"><input type="text" id="idFilter" placeholder="Filter ID" class="filter-input" onkeyup="filterTable()"></div></th>
                    <th class="col-location"><div class="filter-wrapper"><input type="text" id="locationFilter" placeholder="Filter Location" class="filter-input" onkeyup="filterTable()"></div></th>
                    <th class="col-pictures"></th>
                    <th class="col-documentation"></th>
                </tr>
            </thead>
            <tbody id="viewSamplesBody">
                <!-- Will be filled via JavaScript -->
            </tbody>
        </table>
    </div>

    <!-- Full-Size Image Modal -->
    <!-- <div id="fullSizeModal" class="modal" style="display: none;" onclick="closeFullSizeModal(event)"> -->
        <!-- The content will be dynamically generated in JavaScript -->
    <!-- </div> -->

    <script type="text/javascript">
        document.addEventListener("DOMContentLoaded", function() {
            // Now this is valid JSON, not a Python representation:
            const sampleArray = {{ samples|safe }};

            // Group samples by 'opportunity_number'
            const groupedSamples = {};
            sampleArray.forEach(sample => {
                const oppNum = sample.opportunity_number;
                if (!groupedSamples[oppNum]) {
                    groupedSamples[oppNum] = [];
                }
                groupedSamples[oppNum].push(sample);
            });

            const tableBody = document.getElementById('viewSamplesBody');
            tableBody.innerHTML = ''; // Clear any existing rows

            Object.keys(groupedSamples).forEach(oppNum => {
                const group = groupedSamples[oppNum];

                if (group.length === 1) {
                    // If only one entry, display it as a single row
                    const sample = group[0];
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="col-select">
                            <input type="checkbox" name="select_checkbox" value="${sample.unique_id}" disabled>
                        </td>
                        <td>${sample.opportunity_number}</td>
                        <td>${sample.customer}</td>
                        <td>${sample.rsm}</td>
                        <td>${sample.date_received}</td>
                        <td>${sample.description}</td>
                        <td>${sample.unique_id}</td>
                        <td>${sample.storage_location}</td>
                        <td>
                            <button type="button" onclick="readOnlyViewImages('${sample.unique_id}')">View</button>
                        </td>
                        <td>
                            <a href="https://jlsautomation.sharepoint.com/sites/TestEngineering/Test%20Engineering/${sample.opportunity_number}" target="_blank">Documentation</a>
                        </td>
                    `;
                    tableBody.appendChild(row);
                } else {
                    // Create a group row
                    const sanitizedOppNum = oppNum.replace(/\s+/g, '_').replace(/[^a-zA-Z0-9_-]/g, '');
                    const groupRow = document.createElement('tr');
                    groupRow.classList.add('group-row');
                    groupRow.setAttribute('data-opp-num', sanitizedOppNum);
                    groupRow.innerHTML = `
                        <td class="col-select">
                            <button type="button" class="expand-button" data-opp-num="${sanitizedOppNum}">+</button>
                        </td>
                        <td class="col-opportunity">${oppNum}</td>
                        <td class="col-customer">${group[0].customer}</td>
                        <td class="col-rsm">${group[0].rsm}</td>
                        <td colspan="6">(${group.length} entries)</td>
                    `;
                    tableBody.appendChild(groupRow);

                    // Add a row for each sample in the group, initially hidden
                    group.forEach(sample => {
                        const sampleRow = document.createElement('tr');
                        sampleRow.classList.add(`group-${sanitizedOppNum}`, 'grouped-row');
                        sampleRow.style.display = 'none';
                        sampleRow.innerHTML = `
                            <td class="col-select">
                                <input type="checkbox" name="select_checkbox" value="${sample.unique_id}" disabled>
                            </td>
                            <td>${sample.opportunity_number}</td>
                            <td>${sample.customer}</td>
                            <td>${sample.rsm}</td>
                            <td>${sample.date_received}</td>
                            <td>${sample.description}</td>
                            <td>${sample.unique_id}</td>
                            <td>${sample.storage_location}</td>
                            <td>
                                <button type="button" onclick="readOnlyViewImages('${sample.unique_id}')">View</button>
                            </td>
                            <td>
                                <a href="https://jlsautomation.sharepoint.com/sites/TestEngineering/Test%20Engineering/${sample.opportunity_number}" target="_blank">Documentation</a>
                            </td>
                        `;
                        tableBody.appendChild(sampleRow);
                    });
                }
            });

            // Expand/Collapse logic
            document.querySelectorAll('.expand-button').forEach(button => {
                button.addEventListener('click', function() {
                    const oppNum = this.getAttribute('data-opp-num');
                    const groupedRows = document.querySelectorAll(`.group-${oppNum}`);
                    const isExpanded = this.textContent === '-';

                    if (isExpanded) {
                        // Collapse
                        this.textContent = '+';
                        groupedRows.forEach(row => {
                            row.style.display = 'none';
                        });
                    } else {
                        // Expand
                        this.textContent = '-';
                        groupedRows.forEach(row => {
                            row.style.display = '';
                        });
                    }
                });
            });
        });

        function displayThumbnails(imageDataArray) {
            const thumbnailsContainer = document.getElementById('thumbnailsContainer');
            thumbnailsContainer.innerHTML = '';

            imageDataArray.forEach((imageData, index) => {
                const wrapper = document.createElement('div');
                wrapper.classList.add('thumbnail-wrapper');

                const link = document.createElement('a');
                link.href = imageData.full_size_url || imageData.url;
                link.target = '_blank';

                link.addEventListener('click', function(event) {
                    event.preventDefault();
                    if (imageData.full_size_url) {
                        viewFullSizeImage(index);
                    } else {
                        alert('The full-size image is still being processed. Please try again shortly.');
                    }
                });

                const img = document.createElement('img');
                img.src = imageData.url;

                link.appendChild(img);
                wrapper.appendChild(link);
                thumbnailsContainer.appendChild(wrapper);
            });
        }

        function viewFullSizeImage(index) {
            const imageDataArray = window.currentImageDataArray;
            const imageData = imageDataArray[index];
            const fullSizeImageUrl = imageData.full_size_url;
            const filename = imageData.filename;
            const fullSizeModal = document.getElementById('fullSizeModal');
            if (fullSizeModal) {
                fullSizeModal.innerHTML = `
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header full-size-modal-header">
                                <h2>${filename}</h2>
                                <span class="close" onclick="closeFullSizeModal()">&times;</span>
                            </div>
                            <div class="modal-body">
                                <img src="${fullSizeImageUrl}" alt="${filename}">
                            </div>
                        </div>
                    </div>
                `;
                fullSizeModal.style.display = 'flex';
            }
        }

        function closeFullSizeModal(event) {
            if (event) {
                const modalContent = document.querySelector('#fullSizeModal .modal-content');
                if (modalContent && modalContent.contains(event.target)) {
                    return;
                }
            }
            const fullSizeModal = document.getElementById('fullSizeModal');
            if (fullSizeModal) {
                fullSizeModal.style.display = 'none';
                fullSizeModal.innerHTML = '';
            }
        }

        window.filterTable = function() {
            const idFilter = document.getElementById('idFilter').value.toLowerCase();
            const dateFilter = document.getElementById('dateFilter').value.toLowerCase();
            const customerFilter = document.getElementById('customerFilter').value.toLowerCase();
            const rsmFilter = document.getElementById('rsmFilter').value.toLowerCase();
            const opportunityFilter = document.getElementById('opportunityFilter').value.toLowerCase();
            const descriptionFilter = document.getElementById('descriptionFilter').value.toLowerCase();
            const locationFilter = document.getElementById('locationFilter').value.toLowerCase();

            const table = document.getElementById('samplesTable');
            const tr = table.getElementsByTagName('tr');

            for (let i = 2; i < tr.length; i++) {
                const row = tr[i];
                const tdOpportunity = row.getElementsByTagName('td')[0];
                const tdCustomer = row.getElementsByTagName('td')[1];
                const tdRsm = row.getElementsByTagName('td')[2];
                const tdDate = row.getElementsByTagName('td')[3];
                const tdDescription = row.getElementsByTagName('td')[4];
                const tdId = row.getElementsByTagName('td')[5];
                const tdLocation = row.getElementsByTagName('td')[6];

                if (tdId && tdDate && tdCustomer && tdRsm && tdOpportunity && tdDescription && tdLocation) {
                    const idValue = tdId.textContent || tdId.innerText;
                    const dateValue = tdDate.textContent || tdDate.innerText;
                    const customerValue = tdCustomer.textContent || tdCustomer.innerText;
                    const rsmValue = tdRsm.textContent || tdRsm.innerText;
                    const opportunityValue = tdOpportunity.textContent || tdOpportunity.innerText;
                    const descriptionValue = tdDescription.textContent || tdDescription.innerText;
                    const locationValue = tdLocation.textContent || tdLocation.innerText;

                    if (
                        idValue.toLowerCase().indexOf(idFilter) > -1 &&
                        dateValue.toLowerCase().indexOf(dateFilter) > -1 &&
                        customerValue.toLowerCase().indexOf(customerFilter) > -1 &&
                        rsmValue.toLowerCase().indexOf(rsmFilter) > -1 &&
                        opportunityValue.toLowerCase().indexOf(opportunityFilter) > -1 &&
                        descriptionValue.toLowerCase().indexOf(descriptionFilter) > -1 &&
                        locationValue.toLowerCase().indexOf(locationFilter) > -1
                    ) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                }
            }
        };
    </script>

    <script>
    function readOnlyViewImages(sampleId) {
        // Clear existing thumbnails
        document.getElementById('readOnlyThumbnailsContainer').innerHTML = '';
        // Show the modal
        document.getElementById('readOnlyViewModal').style.display = 'block';

        // Fetch images for this sample
        fetch("/get_sample_images?sample_id=" + sampleId)
          .then(response => response.json())
          .then(data => {
              if (data.status === 'success') {
                  // Store images in a global array so we can do full-size viewing
                  window.readOnlyImageDataArray = data.images;
                  displayReadOnlyThumbnails(data.images);
              } else {
                  console.error("Error fetching images:", data.error);
              }
          })
          .catch(error => console.error("Error:", error));
    }

    function displayReadOnlyThumbnails(imageDataArray) {
        const container = document.getElementById('readOnlyThumbnailsContainer');
        container.innerHTML = '';
        window.currentImageDataArray = imageDataArray; // reuse for full-size viewing

        imageDataArray.forEach((imageData, index) => {
            const wrapper = document.createElement('div');
            wrapper.classList.add('thumbnail-wrapper');

            // A link to the image or a click handler to open full-size
            const link = document.createElement('a');
            link.href = imageData.full_size_url || imageData.url;
            link.target = '_blank';
            link.addEventListener('click', function(event) {
                event.preventDefault();
                if (imageData.full_size_url) {
                    // Reuse or replicate your full-size viewing function
                    viewFullSizeImage(index);
                } else {
                    alert('Still processing full-size image. Please try again.');
                }
            });

            const img = document.createElement('img');
            img.src = imageData.url;
            link.appendChild(img);
            wrapper.appendChild(link);

            // No delete button here, because read-only
            container.appendChild(wrapper);
        });
    }

    function closeReadOnlyModal() {
        document.getElementById('readOnlyViewModal').style.display = 'none';
    }
    </script>

<!-- A "Read-Only" modal for viewing images -->
<div id="readOnlyViewModal" class="modal" style="display: none;">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h2>View Images</h2>
                <span class="close" onclick="closeReadOnlyModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div id="readOnlyThumbnailsContainer"></div>
            </div>
            <div class="modal-footer">
                <button type="button" onclick="closeReadOnlyModal()">Done</button>
            </div>
        </div>
    </div>
</div>
</body>
</html>
    <style>
        body {
            background-color: #FFFFFF;
            color: #000000;
            font-family: Arial, sans-serif;
            width: 100%;
            margin: 0;
            padding: 0;
        }

        .table-responsive {
            width: 100%;
            overflow-x: auto;
        }

        #samplesTable {
            margin-top: 20px;
            width: 100%;
            border-collapse: collapse;
        }

        #samplesTable th, #samplesTable td {
            border: 1px solid #DDD;
            padding: 6px;
            text-align: center;
            word-wrap: break-word;
            background-color: #FFFFFF;
            color: #000000;
        }

        #samplesTable th {
            background-color: #EAF2F8;
            color: #000000;
        }

        .filter-input {
            border: 1px solid #CCC;
            padding: 5px;
            background-color: #FFFFFF;
            color: #000000;
        }

        .filter-input:focus {
            border-color: #002B5C;
            box-shadow: 0 0 5px rgba(0, 43, 92, 0.5);
        }

        .filter-wrapper {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .filter-wrapper input {
            width: 100%;
            min-width: 40px;
            max-width: 100%;
            box-sizing: border-box;
        }

        .col-id { width: 40px; text-align: center; }
        .col-date { width: 120px; white-space: nowrap; }
        .col-customer { width: 300px; }
        .col-rsm { width: 120px; }
        .col-opportunity { width: 80px; }
        .col-description { width: auto; }
        .col-location { width: 150px; }
        .col-pictures { width: 100px; vertical-align: middle; }
        .col-documentation { width: 130px; vertical-align: middle; text-align: center; }
        /* Match the group-row styling from create_sample.html */
        .group-row {
            background-color: #e6e6e6;
            font-weight: bold;
        }

        /* Match the expand-button styling */
        .group-row button.expand-button {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
        }

        /* Indent the grouped rows for better visual hierarchy */
        .grouped-row td {
            padding-left: 20px;
        }
        /* Match the "upload/view" modal look from create_sample.html */

        .modal {
            display: none;              /* Hide by default */
            position: fixed !important; /* Overlay the entire page */
            z-index: 9999 !important;   /* Ensure on top of everything */
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;             /* Scroll if needed */
            background-color: rgba(0,0,0,0.5);
        }

        .modal-dialog {
            position: relative;
            margin: 5% auto;
            max-width: 600px; /* or match create_sample.html */
            width: 80%;
            background-color: #fff;   /* Match up with .modal-content if you like */
            border-radius: 8px;
            overflow: hidden;
        }
            display: block;       /* ensures block layout */
            width: 100%;          /* fill parent width */
            background-color: #fff;
            border-radius: 8px;
            overflow: hidden;
            animation: fadeIn 0.3s ease;
        }

        .modal-header {
            padding: 10px;
            background-color: var(--company-color);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 20px;
        }

        .modal-header .close {
            color: white;
            font-size: 22px;
            font-weight: bold;
            cursor: pointer;
        }

        .modal-body {
            padding: 15px;
            background-color: #f8f9fa;
        }

        .modal-footer {
            padding: 10px 15px;
            background-color: #f8f9fa;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .modal-footer button {
            background-color: var(--company-color);
            border: none;
            padding: 8px 16px;
            color: white;
            border-radius: 5px;
            font-size: 14px;
            cursor: pointer;
        }

        .modal-footer button:hover {
            background-color: #001F40;
        }

        /* Copy the fade-in animation if not present */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to   { opacity: 1; transform: translateY(0); }
        }
    </style>
