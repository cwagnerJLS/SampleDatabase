<!DOCTYPE html>
<html>
<head>
    {% load static %}
    <title>Test Lab Samples</title>
    <!-- Include jQuery and other libraries -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.1.0-rc.0/css/select2.min.css" rel="stylesheet" />
    <link rel="icon" href="{% static 'favicon.ico' %}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.1.0-rc.0/js/select2.min.js"></script>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <style>
        /* CSS styles */
        .form-container {
            display: flex;
            flex-wrap: wrap;
            align-items: flex-start;
            gap: 20px;
            margin-bottom: 20px;
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 10px;
            background-color: #f9f9f9;
        }
        label {
            margin-right: 10px;
            font-weight: bold;
        }
        select, input[type="text"] {
            min-width: 200px;
            flex: 1;
            padding: 5px;
            border-radius: 5px;
            border: 1px solid #ccc;
        }
        .button-container {
            display: flex;
            flex-wrap: nowrap;
            gap: 15px;
            margin-top: 20px;
            justify-content: center;
            width: 100%;
        }
        .button-container button {
            min-width: 120px;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #007bff;
            background-color: #007bff;
            color: white;
            font-weight: bold;
            cursor: pointer;
        }
        .button-container button:hover {
            background-color: #0056b3;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            padding-top: 60px;
        }
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 50%;
            max-width: 300px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            align-self: flex-end;
            margin-bottom: 10px;
            cursor: pointer;
        }
        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
        }
        .modal label {
            display: block;
            margin-top: 10px;
            font-weight: bold;
        }
        .modal input {
            width: calc(100% - 22px);
            padding: 10px;
            margin-top: 5px;
            margin-bottom: 20px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        .modal-content button {
            width: 130px; /* Set to the width you want for modal buttons */
            padding: 10px;
            border: none;
            background-color: #007bff;
            color: white;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 0 10px;
        }
        .modal-content button:hover {
            background-color: #0056b3;
        }
        #samplesTable {
            margin-top: 20px;
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
        }
        #samplesTable th, #samplesTable td {
            border: 1px solid #ddd;
            padding: 6px;
            text-align: center;
            word-wrap: break-word;
        }
        #samplesTable th {
            background-color: #f2f2f2;
        }
        .filter-wrapper {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .filter-wrapper input {
            width: 100%;
            min-width: 40px;
            max-width: 100%;
            box-sizing: border-box;
        }
        .selected-row {
            background-color: lightcyan;
        }
        .col-select {
            width: 40px;
        }
        .col-id { width: 40px; text-align: center; }
        .col-date { width: 80px; }
        .col-customer { width: 300px; }
        .col-rsm { width: 120px; }
        .col-opportunity { width: 80px; } /* Adjusted width */
        .col-description { width: auto; }
        .col-location { width: 150px; }
        .col-location select {
            min-width: 135px;
            width: 140px;
        }
        .col-pictures {
            width: 130px; /* Adjusted width to match button */
        }
        .button-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr); /* Two equal columns */
            gap: 10px; /* Space between buttons */
            justify-content: center; /* Center the grid within the container */
            margin-bottom: 20px;
        }
        .button-grid .toggle-button {
            width: 130px; /* Ensure consistent width */
            padding: 10px;
            height: 34px;
            background-color: white;
            border: 2px solid grey;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
        }
        .button-grid .toggle-button.toggled {
            background-color: grey;
            border-color: grey;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            padding-top: 60px;
        }
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 50%;
            max-width: 300px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            align-self: flex-end;
            margin-bottom: 10px;
            cursor: pointer;
        }
        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
        }
    </style>
</head>
<body>
    <!-- Include CSRF token for JavaScript -->
    <script type="text/javascript">
        const csrftoken = '{{ csrf_token }}';
    </script>

    <!-- Add this modal structure at the end of your body tag -->
    <div id="uploadModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeUploadModal()">&times;</span>
            <div class="button-container">
                <input type="file" id="fileInput" multiple>
                <button type="button" onclick="uploadPicture()">Upload</button>
                <button type="button" onclick="closeUploadModal()">Cancel</button>
            </div>
        </div>
    </div>
    <form method="POST" id="sampleForm">
        <!-- Include CSRF token in the form -->
        <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
        <div class="form-container">
            <label for="customer">Customer:</label>
            <select id="customer" name="customer" onchange="filterOptions()">
                <option value="">Select a Customer</option>
                {% for customer in unique_customers %}
                <option value="{{ customer }}">{{ customer }}</option>
                {% endfor %}
            </select>

            <label for="rsm">RSM:</label>
            <select id="rsm" name="rsm" onchange="filterOptions()">
                <option value="">Select an RSM</option>
                {% for rsm in unique_rsms %}
                <option value="{{ rsm }}">{{ rsm }}</option>
                {% endfor %}
            </select>

            <label for="opportunity_number">Opportunity #:</label>
            <select id="opportunity_number" name="opportunity_number" class="opportunity-dropdown" onchange="populateFieldsFromOpportunity()">
                <option value="">Select an Opportunity</option>
            </select>

            <label for="description">Description:</label>
            <input type="text" id="description" name="description" readonly>
        </div>

        <div class="button-container">
            <button type="button" onclick="validateAndShowModal()">Add Sample</button>
            <button type="button" onclick="resetFilters()">Reset</button>
            <button type="button" id="print-all-button">Print</button>
            <button type="button" id="delete-all-button">Delete</button>
        </div>
    </form>

    <!-- The Table for displaying samples -->
    <table id="samplesTable" border="1">
        <thead>
            <tr>
                <th class="col-select">Select</th>
                <th class="col-id">ID</th>
                <th class="col-date">Date Received</th>
                <th class="col-customer">Customer</th>
                <th class="col-rsm">RSM</th>
                <th class="col-opportunity">Opp Number</th>
                <th class="col-description">Description</th>
                <th class="col-location">Location</th>
                <th class="col-pictures">Pictures</th> <!-- New Pictures column -->
            </tr>
            <tr>
                <th class="col-select">
                    <input type="checkbox" id="select-all-select"> <!-- "Select All" Checkbox for the "Select" column -->
                </th>
                <th class="col-id"><div class="filter-wrapper"><input type="text" id="idFilter" placeholder="Filter ID" class="filter-input" onkeyup="filterTable()"></div></th>
                <th class="col-date"><div class="filter-wrapper"><input type="text" id="dateFilter" placeholder="Filter Date" class="filter-input" onkeyup="filterTable()"></div></th>
                <th class="col-customer"><div class="filter-wrapper"><input type="text" id="customerFilter" placeholder="Filter Customer" class="filter-input" onkeyup="filterTable()"></div></th>
                <th class="col-rsm"><div class="filter-wrapper"><input type="text" id="rsmFilter" placeholder="Filter RSM" class="filter-input" onkeyup="filterTable()"></div></th>
                <th class="col-opportunity"><div class="filter-wrapper"><input type="text" id="opportunityFilter" placeholder="Filter Opportunity" class="filter-input" onkeyup="filterTable()"></div></th>
                <th class="col-description"><div class="filter-wrapper"><input type="text" id="descriptionFilter" placeholder="Filter Description" class="filter-input" onkeyup="filterTable()"></div></th>
                <th class="col-location"><div class="filter-wrapper"><input type="text" id="locationFilter" placeholder="Filter Location" class="filter-input" onkeyup="filterTable()"></div></th>
            </tr>
        </thead>
        <tbody>
            {% for sample in samples %}
            {% if sample.date_received and sample.customer and sample.rsm and sample.opportunity_number and sample.description %}
            <tr>
                <td class="col-select">
                    <input type="checkbox" name="select_checkbox" value="{{ sample.unique_id }}">
                </td>
                <td class="col-id">{{ sample.unique_id }}</td>
                <td class="col-date">{{ sample.date_received }}</td>
                <td class="col-customer">{{ sample.customer }}</td>
                <td class="col-rsm">{{ sample.rsm }}</td>
                <td class="col-opportunity">{{ sample.opportunity_number }}</td>
                <td class="col-description">{{ sample.description }}</td>
                <td class="col-location">
                    <select data-sample-id="{{ sample.unique_id }}" onchange="updateSampleLocation({{ sample.unique_id }}, this.value)">
                        <option value="" {% if not sample.storage_location %}selected{% endif %}>Choose a location</option>
                        <option value="Test Lab Fridge" {% if sample.storage_location == 'Test Lab Fridge' %}selected{% endif %}>Test Lab Fridge</option>
                        <option value="Test Lab Freezer" {% if sample.storage_location == 'Test Lab Freezer' %}selected{% endif %}>Test Lab Freezer</option>
                        <option value="Walk-in Fridge" {% if sample.storage_location == 'Walk-in Fridge' %}selected{% endif %}>Walk-in Fridge</option>
                        <option value="Walk-in Freezer" {% if sample.storage_location == 'Walk-in Freezer' %}selected{% endif %}>Walk-in Freezer</option>
                        <option value="Dry Food Storage" {% if sample.storage_location == 'Dry Food Storage' %}selected{% endif %}>Dry Food Storage</option>
                        <option value="Empty Case Storage" {% if sample.storage_location == 'Empty Case Storage' %}selected{% endif %}>Empty Case Storage</option>
                    </select>
                </td>
                <td class="col-pictures">
                    <button type="button" onclick="handlePictureUploadView({{ sample.unique_id }})">Upload/View</button>
                </td>
            </tr>
            {% endif %}
            {% endfor %}
        </tbody>
    </table>

    <!-- The Modal for Adding Samples -->
    <div id="myModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <label for="date_received">Date Received:</label>
            <input type="text" id="date_received" name="date_received">
            <label for="quantity">Quantity:</label>
            <input type="number" id="quantity" name="quantity" min="1">
            <div style="display: flex; justify-content: space-between;">
                <button type="button" onclick="submitForm()">Submit</button>
                <button type="button" onclick="closeModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- JavaScript code -->
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            // Initialize variables
            const csrftoken = '{{ csrf_token }}';
            const selectAllSelectCheckbox = document.getElementById('select-all-select');
            const excelData = JSON.parse('{{ excel_data|escapejs }}');
            const samples = JSON.parse('{{ samples|escapejs }}');
            const todayDate = new Date().toISOString().split('T')[0];
            let isPopulating = false; // Flag to prevent recursive triggering

            // Initialize datepicker
            $("#date_received").datepicker({ dateFormat: 'yy-mm-dd' }).val(todayDate);

            // Initialize Select2 for dropdowns with search capability
            $('#customer, #rsm, #opportunity_number').select2({
                width: 'resolve',
                matcher: matchCustom
            });

            // Custom matcher function for multi-keyword search
            function matchCustom(params, data) {
                if ($.trim(params.term) === '') {
                    return data;
                }
                const terms = params.term.toLowerCase().split(' ');
                const original = data.text.toLowerCase();
                const matches = terms.every(term => original.includes(term));

                if (matches) {
                    return data;
                }
                return null;
            }

            // Event listener for the print button
            document.getElementById('print-all-button').addEventListener('click', function() {
                submitPrint();  // Directly call submitPrint
            });

            // Submit Print function
            window.submitPrint = function() {
                const selectedCheckboxes = document.querySelectorAll('input[name="select_checkbox"]:checked');
                const idsToPrint = Array.from(selectedCheckboxes).map(checkbox => checkbox.value);

                if (idsToPrint.length === 0) {
                    alert('No entries selected for printing.');
                    return;
                }

                const confirmPrint = confirm(`You have selected ${idsToPrint.length} entries to print. Do you want to proceed?`);

                if (confirmPrint) {
                    console.log('Gathering data for selected entries...');

                    fetch("{% url 'handle_print_request' %}", {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrftoken
                        },
                        body: JSON.stringify({'ids': idsToPrint}),
                        credentials: 'same-origin'  // Include cookies in the request
                    })
                    .then(response => {
                        if (!response.ok) {
                            return response.json().then(err => { throw err; });
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.status === 'success') {
                            console.log('Labels to print:', data.labels);

                            data.labels.forEach(label => {
                                console.log(`Label ID: ${label.id}`);
                                console.log(`QR Code: data:image/png;base64,${label.qr_code}`);
                            });

                            // Here you would send this data to your printer
                        } else {
                            console.error('Error generating labels:', data.error);
                            alert(`Error: ${data.error}`);
                        }
                    })
                    .catch(error => {
                        console.error('Fetch Error:', error);
                        alert('An unexpected error occurred. Please try again.');
                    });
                } else {
                    console.log('Print operation was canceled.');
                }
            };

            // Delete selected entries
            document.getElementById('delete-all-button').addEventListener('click', function() {
                const selectedCheckboxes = document.querySelectorAll('input[name="select_checkbox"]:checked');
                const idsToDelete = Array.from(selectedCheckboxes).map(checkbox => checkbox.value);

                if (idsToDelete.length === 0) {
                    alert('No entries selected for deletion.');
                    return;
                }

                if (confirm('Are you sure you want to delete the selected entries?')) {
                    const formData = new FormData();
                    formData.append('csrfmiddlewaretoken', csrftoken);
                    formData.append('ids', JSON.stringify(idsToDelete));

                    fetch("{% url 'delete_samples' %}", {
                        method: 'POST',
                        body: formData,
                        credentials: 'same-origin'  // Include cookies
                    }).then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            selectedCheckboxes.forEach(checkbox => {
                                const row = checkbox.closest('tr');
                                row.parentNode.removeChild(row); // Remove the row from the table
                            });
                            selectAllSelectCheckbox.checked = false; // Clear the "Select All" checkbox
                            console.log('Entries deleted successfully.');
                        } else {
                            console.error('Error deleting entries:', data.error);
                        }
                    });
                }
            });

            // Highlight selected rows using event delegation
            document.querySelector('#samplesTable tbody').addEventListener('change', function(event) {
                if (event.target.name === 'select_checkbox') {
                    const row = event.target.closest('tr');
                    if (event.target.checked) {
                        row.classList.add('selected-row');
                    } else {
                        row.classList.remove('selected-row');
                    }
                }
            });

            // Select All functionality with row highlighting
            selectAllSelectCheckbox.addEventListener('change', function() {
                const visibleRows = document.querySelectorAll('#samplesTable tbody tr:not([style*="display: none"])');
                visibleRows.forEach(function(row) {
                    const checkbox = row.querySelector('input[name="select_checkbox"]');
                    if (checkbox) {
                        checkbox.checked = this.checked;
                        if (this.checked) {
                            row.classList.add('selected-row');
                        } else {
                            row.classList.remove('selected-row');
                        }
                    }
                }, this);
            });

            // Update Sample Location function
            window.updateSampleLocation = function(sampleId, location) {
                // Get all selected checkboxes
                const selectedCheckboxes = document.querySelectorAll('input[name="select_checkbox"]:checked');

                // If there are selected checkboxes, update all of them
                if (selectedCheckboxes.length > 0) {
                    const idsToUpdate = Array.from(selectedCheckboxes).map(checkbox => checkbox.value);

                    const formData = new FormData();
                    formData.append('csrfmiddlewaretoken', csrftoken);
                    formData.append('ids', JSON.stringify(idsToUpdate));
                    formData.append('location', location);

                    fetch("{% url 'update_sample_location' %}", {
                        method: 'POST',
                        body: formData,
                        credentials: 'same-origin'  // Include cookies
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            console.log('Sample locations updated successfully for selected samples.');

                            // Update the dropdowns in real-time
                            idsToUpdate.forEach(id => {
                                const dropdown = document.querySelector(`select[data-sample-id="${id}"]`);
                                if (dropdown) {
                                    dropdown.value = location;
                                }
                            });
                        } else {
                            console.error('Error updating sample locations:', data.error);
                        }
                    })
                    .catch(error => {
                        console.error('Fetch error:', error);
                    });
                } else {
                    // If no checkboxes are selected, update only the single sample whose dropdown was changed
                    const formData = new FormData();
                    formData.append('csrfmiddlewaretoken', csrftoken);
                    formData.append('sample_id', sampleId);
                    formData.append('location', location);

                    fetch("{% url 'update_sample_location' %}", {
                        method: 'POST',
                        body: formData,
                        credentials: 'same-origin'  // Include cookies
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            console.log(`Sample location updated successfully for sample ID: ${sampleId}.`);

                            // Update the dropdown in real-time
                            const dropdown = document.querySelector(`select[data-sample-id="${sampleId}"]`);
                            if (dropdown) {
                                dropdown.value = location;
                            }
                        } else {
                            console.error(`Error updating sample location for sample ID: ${sampleId}:`, data.error);
                        }
                    })
                    .catch(error => {
                        console.error('Fetch error:', error);
                    });
                }
            };

            // Submit Form function
            window.submitForm = function() {
                const dateReceived = document.getElementById('date_received').value;
                const quantity = document.getElementById('quantity').value;

                if (quantity === "") {
                    alert("Please enter the quantity.");
                } else {
                    const customer = document.getElementById('customer').value;
                    const rsm = document.getElementById('rsm').value;
                    const opportunityNumber = document.getElementById('opportunity_number').value;
                    const description = document.getElementById('description').value;
                    const location = "Choose a location"; // Default location

                    const formData = new FormData();
                    formData.append('csrfmiddlewaretoken', csrftoken);
                    formData.append('date_received', dateReceived);
                    formData.append('customer', customer);
                    formData.append('rsm', rsm);
                    formData.append('opportunity_number', opportunityNumber);
                    formData.append('description', description);
                    formData.append('location', location);
                    formData.append('quantity', quantity);

                    fetch("{% url 'create_sample' %}", {
                        method: 'POST',
                        body: formData,
                        credentials: 'same-origin'  // Include cookies
                    }).then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            data.created_samples.forEach(sample => {
                                const newRow = document.createElement('tr');
                                newRow.innerHTML = `
                                    <td class="col-select">
                                        <input type="checkbox" name="select_checkbox" value="${sample.unique_id}">
                                    </td>
                                    <td class="col-id">${sample.unique_id}</td>
                                    <td class="col-date">${sample.date_received}</td>
                                    <td class="col-customer">${sample.customer}</td>
                                    <td class="col-rsm">${sample.rsm}</td>
                                    <td class="col-opportunity">${sample.opportunity_number}</td>
                                    <td class="col-description">${sample.description}</td>
                                    <td class="col-location">
                                        <select data-sample-id="${sample.unique_id}" onchange="updateSampleLocation(${sample.unique_id}, this.value)">
                                            <option value="Choose a location" ${sample.location === "Choose a location" ? "selected" : ""}>Choose a location</option>
                                            <option value="Test Lab Fridge">Test Lab Fridge</option>
                                            <option value="Test Lab Freezer">Test Lab Freezer</option>
                                            <option value="Walk-in Fridge">Walk-in Fridge</option>
                                            <option value="Walk-in Freezer">Walk-in Freezer</option>
                                            <option value="Dry Food Storage">Dry Food Storage</option>
                                            <option value="Empty Case Storage">Empty Case Storage</option>
                                        </select>
                                    </td>
                                    <td class="col-pictures">
                                        <button type="button" onclick="handlePictureUploadView({{ sample.unique_id }})">Upload/View</button>
                                    </td>
                                `;
                                document.querySelector('#samplesTable tbody').appendChild(newRow);
                            });
                            console.log('Sample saved successfully.');
                        } else {
                            console.error('Error saving sample:', data.error);
                        }
                    });

                    closeModal();
                    resetForm();
                }
            };

            // Filter Options function
            window.filterOptions = function() {
                if (isPopulating) return;
                const customer = document.getElementById('customer').value;
                const rsm = document.getElementById('rsm').value;

                const filteredData = excelData.filter(record =>
                    (customer === "" || record['Customer'] === customer) &&
                    (rsm === "" || record['RSM'] === rsm)
                );

                updateSelectOptions(document.getElementById('customer'), 'Customer', filteredData, customer);
                updateSelectOptions(document.getElementById('rsm'), 'RSM', filteredData, rsm);
                updateSelectOptions(document.getElementById('opportunity_number'), 'Opportunity #', filteredData);
            };

            // Populate Fields from Opportunity function
            window.populateFieldsFromOpportunity = function() {
                const opportunityNumber = document.getElementById('opportunity_number').value;
                const selectedData = excelData.find(record => record['Opportunity #'] === parseInt(opportunityNumber));

                if (selectedData) {
                    isPopulating = true; // Set flag to true
                    $('#customer').val(selectedData['Customer']).trigger('change.select2');
                    $('#rsm').val(selectedData['RSM']).trigger('change.select2');
                    document.getElementById('description').value = selectedData['Description'];
                    isPopulating = false; // Reset flag to false
                } else {
                    document.getElementById('description').value = '';
                }
            };

            // Validate and Show Modal function
            window.validateAndShowModal = function() {
                const customer = document.getElementById('customer').value;
                const rsm = document.getElementById('rsm').value;
                const opportunityNumber = document.getElementById('opportunity_number').value;

                if (customer === "" || rsm === "" || opportunityNumber === "") {
                    alert("Please complete all selections before adding a sample.");
                } else {
                    document.getElementById('myModal').style.display = "block";
                }
            };

            // Clear Database function (if needed)
            window.clearDatabase = function() {
                const formData = new FormData();
                formData.append('csrfmiddlewaretoken', csrftoken);
                formData.append('clear_db', 'true');

                fetch("{% url 'create_sample' %}", {
                    method: 'POST',
                    body: formData,
                    credentials: 'same-origin'
                }).then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        document.querySelector('#samplesTable tbody').innerHTML = '';
                        console.log('Database cleared successfully.');
                    } else {
                        console.error('Error clearing database:', data.error);
                    }
                });
            };

            // Close Modal function
            window.closeModal = function() {
                document.getElementById('myModal').style.display = "none";
            };

            // Reset Filters function
            window.resetFilters = function() {
                // Reset dropdown filters
                document.getElementById('customer').value = "";
                document.getElementById('rsm').value = "";
                document.getElementById('opportunity_number').value = "";
                document.getElementById('description').value = "";

                // Update dropdown options to default
                updateSelectOptions(document.getElementById('customer'), 'Customer', excelData);
                updateSelectOptions(document.getElementById('rsm'), 'RSM', excelData);
                updateSelectOptions(document.getElementById('opportunity_number'), 'Opportunity #', excelData);

                // Reset Select2 elements
                $('#customer, #rsm, #opportunity_number').val(null).trigger('change.select2');

                // Clear text filters in the table
                document.getElementById('idFilter').value = "";
                document.getElementById('dateFilter').value = "";
                document.getElementById('customerFilter').value = "";
                document.getElementById('rsmFilter').value = "";
                document.getElementById('opportunityFilter').value = "";
                document.getElementById('descriptionFilter').value = "";
                document.getElementById('locationFilter').value = "";

                // Uncheck all checkboxes in the table and remove highlighting
                const checkboxes = document.querySelectorAll('input[name="select_checkbox"]');
                checkboxes.forEach(checkbox => {
                    checkbox.checked = false;
                    const row = checkbox.closest('tr');
                    row.classList.remove('selected-row');
                });

                // Clear the "Select All" checkbox
                const selectAllCheckbox = document.getElementById('select-all-select');
                if (selectAllCheckbox) {
                    selectAllCheckbox.checked = false;
                }

                // Reapply filters to clear the table
                filterTable();
            };

            // Update Select Options function
            function updateSelectOptions(selectElement, key, filteredData, currentValue = "") {
                const uniqueValues = [...new Set(filteredData.map(record => record[key]))];
                uniqueValues.sort((a, b) => {
                    if (key === 'Opportunity #') {
                        return a - b;
                    }
                    return a.localeCompare(b);
                });

                selectElement.innerHTML = '<option value="">Select an option</option>';
                uniqueValues.forEach(value => {
                    if (value) {
                        const option = document.createElement('option');
                        option.value = value;
                        option.textContent = value;
                        if (value === currentValue) {
                            option.selected = true;
                        }
                        selectElement.appendChild(option);
                    }
                });

                // Reinitialize Select2 after updating options
                $(selectElement).select2({
                    width: 'resolve',
                    matcher: matchCustom
                });
            }

            // Filter Table function
            window.filterTable = function() {
                const idFilter = document.getElementById('idFilter').value.toLowerCase();
                const dateFilter = document.getElementById('dateFilter').value.toLowerCase();
                const customerFilter = document.getElementById('customerFilter').value.toLowerCase();
                const rsmFilter = document.getElementById('rsmFilter').value.toLowerCase();
                const opportunityFilter = document.getElementById('opportunityFilter').value.toLowerCase();
                const descriptionFilter = document.getElementById('descriptionFilter').value.toLowerCase();
                const locationFilter = document.getElementById('locationFilter').value.toLowerCase();

                const table = document.getElementById('samplesTable');
                const tr = table.getElementsByTagName('tr');

                for (let i = 2; i < tr.length; i++) { // Start from 2 to skip header rows
                    const tdId = tr[i].getElementsByTagName('td')[1];
                    const tdDate = tr[i].getElementsByTagName('td')[2];
                    const tdCustomer = tr[i].getElementsByTagName('td')[3];
                    const tdRsm = tr[i].getElementsByTagName('td')[4];
                    const tdOpportunity = tr[i].getElementsByTagName('td')[5];
                    const tdDescription = tr[i].getElementsByTagName('td')[6];
                    const tdLocation = tr[i].getElementsByTagName('td')[7];

                    if (tdId && tdDate && tdCustomer && tdRsm && tdOpportunity && tdDescription && tdLocation) {
                        const idValue = tdId.textContent || tdId.innerText;
                        const dateValue = tdDate.textContent || tdDate.innerText;
                        const customerValue = tdCustomer.textContent || tdCustomer.innerText;
                        const rsmValue = tdRsm.textContent || tdRsm.innerText;
                        const opportunityValue = tdOpportunity.textContent || tdOpportunity.innerText;
                        const descriptionValue = tdDescription.textContent || tdDescription.innerText;
                        const locationValue = tdLocation.textContent || tdLocation.innerText;

                        if (
                            idValue.toLowerCase().indexOf(idFilter) > -1 &&
                            dateValue.toLowerCase().indexOf(dateFilter) > -1 &&
                            customerValue.toLowerCase().indexOf(customerFilter) > -1 &&
                            rsmValue.toLowerCase().indexOf(rsmFilter) > -1 &&
                            opportunityValue.toLowerCase().indexOf(opportunityFilter) > -1 &&
                            descriptionValue.toLowerCase().indexOf(descriptionFilter) > -1 &&
                            locationValue.toLowerCase().indexOf(locationFilter) > -1
                        ) {
                            tr[i].style.display = '';
                        } else {
                            tr[i].style.display = 'none';
                        }
                    }
                }
            };

            // Reset Form function
            window.resetForm = function() {
                document.getElementById('sampleForm').reset(); // Resets all form fields
                // If you're using Select2, reset it as well
                $('#customer, #rsm, #opportunity_number').val(null).trigger('change.select2');
                document.getElementById('description').value = ''; // Clear the description field
            };

            // Close Print Modal function (if needed)
            window.closePrintModal = function() {
                document.getElementById('printModal').style.display = "none";
            };

            // Initialize dropdowns with all options
            updateSelectOptions(document.getElementById('customer'), 'Customer', excelData);
            updateSelectOptions(document.getElementById('rsm'), 'RSM', excelData);
            updateSelectOptions(document.getElementById('opportunity_number'), 'Opportunity #', excelData);

            // Load existing samples into the table
            samples.forEach(sample => {
                const newRow = document.createElement('tr');
                newRow.innerHTML = `
                    <td class="col-select">
                        <input type="checkbox" name="select_checkbox" value="${sample.unique_id}">
                    </td>
                    <td class="col-id">${sample.unique_id}</td>
                    <td class="col-date">${sample.date_received}</td>
                    <td class="col-customer">${sample.customer}</td>
                    <td class="col-rsm">${sample.rsm}</td>
                    <td class="col-opportunity">${sample.opportunity_number}</td>
                    <td class="col-description">${sample.description}</td>
                    <td class="col-location">
                        <select data-sample-id="${sample.unique_id}" onchange="updateSampleLocation(${sample.unique_id}, this.value)">
                            <option value="Choose a location" ${sample.storage_location === "Choose a location" ? "selected" : ""}>Choose a location</option>
                            <option value="Test Lab Fridge" ${sample.storage_location === "Test Lab Fridge" ? "selected" : ""}>Test Lab Fridge</option>
                            <option value="Test Lab Freezer" ${sample.storage_location === "Test Lab Freezer" ? "selected" : ""}>Test Lab Freezer</option>
                            <option value="Walk-in Fridge" ${sample.storage_location === "Walk-in Fridge" ? "selected" : ""}>Walk-in Fridge</option>
                            <option value="Walk-in Freezer" ${sample.storage_location === "Walk-in Freezer" ? "selected" : ""}>Walk-in Freezer</option>
                            <option value="Dry Food Storage" ${sample.storage_location === "Dry Food Storage" ? "selected" : ""}>Dry Food Storage</option>
                            <option value="Empty Case Storage" ${sample.storage_location === "Empty Case Storage" ? "selected" : ""}>Empty Case Storage</option>

                        </select>
                    </td>
                    <td class="col-pictures">
                        <button type="button" onclick="handlePictureUploadView(${sample.unique_id})">Upload/View</button>
                    </td>
                `;
                document.querySelector('#samplesTable tbody').appendChild(newRow);
            });
        });

        function handlePictureUploadView(sampleId) {
            // Open the modal
            document.getElementById('uploadModal').style.display = 'block';
        }

        function closeUploadModal() {
            // Close the modal
            document.getElementById('uploadModal').style.display = 'none';
        }

        function uploadPicture() {
            // Implement the logic to handle picture upload
            const fileInput = document.getElementById('fileInput');
            const files = fileInput.files;

            if (files.length === 0) {
                alert('Please select a file to upload.');
                return;
            }

            const formData = new FormData();
            for (let i = 0; i < files.length; i++) {
                formData.append('files', files[i]);
            }

            fetch("{% url 'upload_files' %}", {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': csrftoken
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert('Files uploaded successfully.');
                    closeUploadModal();
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An unexpected error occurred.');
            });
        }

        function handlePictureUploadView(sampleId) {
            // Open the modal
            document.getElementById('uploadModal').style.display = 'block';
        }
    </script>
</body>
</html>
