<!DOCTYPE html>
<html>
<head>
    {% load static %}
    <title>Test Lab Samples</title>
    <link rel="icon" type="image/x-icon" href="{% static 'favicon.ico' %}">
    <!-- Include jQuery and other libraries -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.1.0-rc.0/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.1.0-rc.0/js/select2.min.js"></script>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <style>
        body {
            background-color: #FFFFFF;
            color: #000000;
            font-family: Arial, sans-serif;
            width: 100%;
            margin: 0;
            padding: 0;
        }

        @media (max-width: 600px) {
            /* Hide the 'Description' column */
            #samplesTable th.col-description,
            #samplesTable td.col-description {
                display: none !important;  /* Add !important */
            }

            /* Allow the table to adjust its layout */
            #samplesTable {
                table-layout: auto;  /* Add this line */
            }

            /* Adjust other columns to use available space */
            #samplesTable th,
            #samplesTable td {
                width: auto;
            }
        }

        .table-responsive {
            width: 100%;
            overflow-x: auto;
        }

        /* Thumbnail delete button styling */
        .thumbnail-wrapper .delete-button {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: rgba(220, 53, 69, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            font-weight: bold;
            width: 25px;
            height: 25px;
            padding: 0;
            text-align: center;
            line-height: 25px;
            font-size: 16px;
            cursor: pointer;
            z-index: 1;
        }

        /* Documentation buttons styling */
        .doc-buttons {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 2px;
            width: 100%;
        }

        .doc-buttons .download-button,
        .doc-buttons .upload-button {
            margin: 0;
        }

        .doc-buttons .download-button:hover,
        .doc-buttons .upload-button:hover {
            background-color: #001F40;
        }

        /* Navigation Buttons */
        .modal-body .prev-button,
        .modal-body .next-button {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            font-size: 24px;
            font-weight: bold;
            padding: 0;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            user-select: none;
            z-index: 2;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0;
        }

        .modal-body .prev-button {
            left: 10px;
        }

        .modal-body .next-button {
            right: 10px;
        }

        .modal-body img {
            max-width: 100%;
            max-height: 80vh;
            display: block;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }

        /* Ensure that navigation buttons appear over the image */
        .modal-body {
            position: relative;
            overflow: hidden;
        }

        /* Full-size modal specific styles */
        #fullSizeModal .modal-dialog {
            max-height: 90vh;
            margin: auto;
            display: flex;
            align-items: center;
            flex-direction: column;
            max-width: 90vw;
            height: auto;
        }

        #fullSizeModal .modal-content {
            position: relative;
            display: flex;
            flex-direction: column;
            width: auto;
            height: auto;
            max-width: 90vw;
            max-height: 90vh;
            overflow: hidden;
        }

        /* Ensure the modal header displays the filename properly */
        #fullSizeModal .modal-header h2 {
            margin: 0;
            font-size: 18px;
            max-width: 80%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* Modal Overlay */
        #fullSizeModal {
            display: flex;
            align-items: center;         /* Center vertically */
            justify-content: center;     /* Center horizontally */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: auto;              /* Allow scrolling if content exceeds viewport */
            z-index: 9999;
            background-color: rgba(0, 0, 0, 0.5);
        }


        /* Modal Header */
        #fullSizeModal .modal-header {
            flex-shrink: 0;
            padding: 10px;
            background-color: var(--company-color);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Modal Body */
        #fullSizeModal .modal-body {
            flex: none;                   /* Prevent flex resizing */
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;                  /* Prevent scrolling inside modal body */
            padding: 0;
            max-height: 100%;                  /* Ensure the body doesn't exceed parent height */
        }

        /* Image Styling */
        #fullSizeModal .modal-body img {
            width: auto;
            height: auto;
            max-width: 90vw;              /* Constrain image width */
            max-height: 90vh;             /* Constrain image height */
        }

        @media (max-width: 600px) {
            .form-container {
                padding: 10px;
            }

            .input-group {
                min-width: 100%;    /* Make input groups take full width on small screens */
            }
        }
        /* Lower the quantity field slightly */
        .add-sample-modal .modal-form-group.quantity-group {
            margin-top: 10px; /* Adjust this value to move the field further down or up */
        }
        #samplesTable tr.selected-row td {
            background-color: #d4f5d4 !important; /* Lighter green color */
        }

        /* Apply light blue background to the filtering row */
        #samplesTable thead tr:nth-child(2) th {
            background-color: #EAF2F8; /* Lighter blue background */
        }
        :root {
            --company-color: #002B5C; /* Pantone 289C */
        }
        .form-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            margin: 0 20px 20px 20px;
            padding: 20px;
            max-width: none;
            border: 2px solid var(--company-color);
            border-radius: 10px;
            background-color: #EAF2F8;
            color: #000000;
        }

        .input-group {
            flex: 1 1 200px;       /* Grow and shrink with a basis of 200px */
            min-width: 200px;      /* Ensure a minimum width */
            display: flex;
            flex-direction: column;
        }

        .input-group label {
            margin-bottom: 5px;
            font-weight: bold;
        }

        /* Base input and select styles */
        select, 
        input[type="text"],
        input[type="number"] {
            padding: 5px;
            border-radius: 5px;
            border: 1px solid #CCC;
            background-color: #FFFFFF;
            color: #000000;
            box-sizing: border-box;
        }

        /* Input group specific styles */
        .input-group select,
        .input-group input[type="text"] {
            width: 100%;
            min-width: 200px;
            flex: 1;
        }

        /* Modal-specific label styles */
        .add-sample-modal label {
            margin-right: 0;
            margin-bottom: 5px;
            font-size: 14px;
        }
        input[type="text"]:focus,
        select:focus,
        input[type="number"]:focus,
        textarea:focus {
            border-color: var(--company-color);
            outline: none;
            box-shadow: 0 0 5px rgba(0, 43, 92, 0.5); /* Optional shadow effect */
        }

        .group-row button.expand-button {
            color: var(--company-color);
        }

        .button-container {
            display: flex;
            flex-wrap: wrap;          /* Allow buttons to wrap to the next line if necessary */
            gap: 15px;
            margin-top: 20px;
            justify-content: center;  /* Center the buttons horizontally */
            width: 100%;
            /* Make it sticky */
            position: sticky;
            top: 0;
            z-index: 1000;
            background-color: #FFFFFF;
            padding: 10px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0);
            transition: box-shadow 0.3s ease;
        }
        
        /* Add shadow when scrolled */
        .button-container.scrolled {
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        
        /* Sticky header container for cloned table headers */
        .sticky-header-container {
            position: sticky;
            top: 54px; /* Position below button container (adjust based on actual button height) */
            z-index: 999;
            background-color: #FFFFFF;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-bottom: 2px solid #ddd;
            overflow-x: auto; /* Allow horizontal scroll if needed */
            overflow-y: hidden;
            width: 100%;
            box-sizing: border-box;
        }
        
        /* Cloned table should inherit all styles from original */
        #clonedTableWrapper {
            width: 100%;
        }
        
        /* Ensure cloned table headers have correct styling */
        #clonedHeaderTable th {
            background-color: #EAF2F8 !important; /* Force the light blue background */
            color: #000000 !important;
            border: 1px solid #DDD !important;
        }
        

        .button-container button {
            flex: 1 1 120px;          /* Make buttons flexible with a minimum width */
            max-width: 200px;         /* Optional: set a maximum width */
            background-color: var(--company-color);
            border: 1px solid var(--company-color);
            padding: 10px;
            border-radius: 5px;
            color: white;
            font-weight: bold;
            cursor: pointer;
        }
        .button-container button:hover {
            background-color: #001F40; /* Slightly darker shade on hover */
        }
        /* Modal Overlay */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;  /* Higher than sticky containers (1000) */
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5); /* Darker overlay for better focus */
        }

        /* Modal Dialog */
        /* Styles for Add Sample Modal */
        .add-sample-modal .modal-dialog {
            position: relative;
            margin: 5% auto;
            max-width: 400px;
            width: 80%;
        }

        /* Styles for Upload/View Modal */
        body .upload-modal .modal-dialog {
            position: relative;
            margin: 5% auto;
            width: auto;           /* Allow the width to adjust automatically */
            min-width: 600px;      /* Set the desired minimum width */
            max-width: 90%;        /* Set the maximum width (90% of viewport) */
        }

        /* Loading placeholder styles */
        .thumbnail-placeholder {
            width: 120px;
            height: 120px;
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: 5px;
            overflow: hidden;
            display: inline-block;
            position: relative;
            margin: 5px;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .thumbnail-placeholder::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 30px;
            height: 30px;
            border: 3px solid #ddd;
            border-top-color: #999;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }

        /* General modal content (non-fullsize) */
        .modal:not(#fullSizeModal) .modal-content {
            display: block;
            width: 100%;
            background-color: #fff;
            border-radius: 8px;
            overflow: hidden;
            animation: fadeIn 0.3s ease;
        }

        /* Modal Header */
        .modal-header {
            padding: 10px;
            background-color: var(--company-color);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 20px;
        }

        /* Close Button */
        .modal-header .close {
            color: white;
            font-size: 22px;
            font-weight: bold;
            cursor: pointer;
        }

        /* Modal Body */
        .modal-body {
            padding: 15px;
            background-color: #f8f9fa;
        }

        /* Thumbnails Container */
        #thumbnailsContainer {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center; /* Center the thumbnails horizontally */
        }

        #thumbnailsContainer .thumbnail-wrapper {
            position: relative;
            width: 120px;
            height: 120px;
            border-radius: 5px;
            overflow: hidden;
            background-color: #fff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        #thumbnailsContainer img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }


        /* Modal Footer */
        .modal-footer {
            padding: 10px 15px;
            background-color: #f8f9fa;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        /* Footer Buttons */
        .modal-footer button {
            background-color: var(--company-color);
            border: none;
            padding: 8px 16px;
            color: white;
            border-radius: 5px;
            font-size: 14px;
            cursor: pointer;
        }

        .modal-footer button:hover {
            background-color: #001F40; /* Slightly darker shade */
        }

        /* Fade-in Animation */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        #samplesTable {
            margin-top: 20px;
            width: 100%;
            border-collapse: collapse;
            /* table-layout: fixed; */  /* This line is now commented out or removed */
        }
        #samplesTable th, #samplesTable td {
            border: 1px solid #DDD; /* Subtle border */
            padding: 6px;
            text-align: center;
            word-wrap: break-word;
            background-color: #FFFFFF; /* White background */
            color: #000000; /* Black text */
        }
        #samplesTable th {
            background-color: #EAF2F8; /* Lighter blue background */
            color: #000000; /* Black text */
        }
        .filter-input {
            border: 1px solid #CCC; /* Light gray border */
            padding: 5px;
            background-color: #FFFFFF; /* White input background */
            color: #000000; /* Black text */
        }

        .filter-input:focus {
            border-color: var(--company-color);
            box-shadow: 0 0 5px rgba(0, 43, 92, 0.5);
        }

        .filter-wrapper {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .filter-wrapper input {
            width: 100%;
            min-width: 40px;
            max-width: 100%;
            box-sizing: border-box;
        }
        .col-select {
            width: 60px; /* Increased width to prevent wrapping */
            white-space: nowrap; /* Prevent content from wrapping */
        }
        .col-id { width: 40px; text-align: center; }
        .col-date {
            width: 120px;       /* Increase the width to accommodate the date */
            white-space: nowrap; /* Prevent the date from wrapping to the next line */
        }
        .col-customer { width: 300px; }
        .col-rsm { width: 120px; }
        .col-opportunity { width: 80px; }
        .col-description { width: auto; }
        .col-location { width: 150px; }
        .col-location select {
            min-width: 135px;
            width: 140px;
            background-color: #FFFFFF; /* White background */
            color: #000000; /* Black text */
        }
        .col-pictures {
            width: 100px; /* Decreased width */
            vertical-align: middle;
        }
        .col-documentation {
            width: 130px; /* Adjust if necessary */
            vertical-align: middle;
            text-align: center; /* Center content horizontally */
        }
        .button-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            justify-content: center;
            margin-bottom: 20px;
        }
        .button-grid .toggle-button {
            width: 130px;
            padding: 10px;
            height: 34px;
            background-color: white;
            border: 2px solid grey;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
        }
        .button-grid .toggle-button.toggled {
            background-color: grey;
            border-color: grey;
        }
        /* Style for group rows */
        .group-row {
            background-color: #e6e6e6;
            font-weight: bold;
        }

        .group-row button.expand-button {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
        }

        /* Indent the grouped rows for better visual hierarchy */
        .grouped-row td {
            padding-left: 20px;
        }

        /* Adjust the colspan to align the table cells correctly */
        .group-row td[colspan="7"] {
            text-align: left;
        }
        .thumbnail-wrapper {
            position: relative;
            display: inline-block;
        }

        .thumbnail-wrapper img {
            display: block;
        }


        #thumbnailsContainer img {
            width: 100px;
            height: 100px;
            object-fit: cover;
            margin: 5px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        /* Center content inside the modal */
        .add-sample-modal {
            text-align: center;
        }

        /* Limit the width of inputs inside the modal */
        .add-sample-modal .form-group input {
            width: 100%;
            max-width: 200px; /* Set a max-width to prevent the input from stretching too much */
        }

        /* Modal-specific styles */
        .add-sample-modal .form-row {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .add-sample-modal .form-group {
            flex: 1;
            display: flex;
            flex-direction: column;
            margin-bottom: 5px;
            text-align: center;
        }

        .add-sample-modal .form-group label {
            margin-bottom: 5px;
            font-size: 14px;
        }

        .add-sample-modal .form-group input {
            padding: 5px;
            font-size: 14px;
            width: 100%;
            max-width: 200px;
        }

        /* General text styling within modals */
        .modal-body p, .modal-body label {
            margin: 0;
            line-height: 1.2;
        }
    </style>
</head>
<body>
    <!-- Include CSRF token and excelData for JavaScript -->
    <script type="text/javascript">
        const csrftoken = '{{ csrf_token }}';
        const excelData = {{ excel_data|safe }};
        const samples = {{ samples|safe }};
        
        // Configuration constants
        const CONFIG = {
            STORAGE_LOCATIONS: [
                "Test Lab Fridge",
                "Test Lab Freezer", 
                "Walk-in Fridge",
                "Walk-in Freezer",
                "Dry Food Storage",
                "Empty Case Storage"
            ],
            SHAREPOINT_BASE_URL: "https://jlsautomation.sharepoint.com/sites/TestEngineering/Test%20Engineering/",
            DEFAULT_LOCATION: "Choose a location",
            POLLING: {
                MAX_ATTEMPTS: 10,
                INTERVAL_TIME: 2000 // milliseconds
            },
            THUMBNAIL: {
                WIDTH: 120,
                GAP: 10,
                MIN_MODAL_WIDTH: 600
            }
        };

        function downloadDocumentation(sampleId) {
            window.location.href = '/download_documentation/' + sampleId + '/';
        }
        
        // Helper function to generate storage location options HTML
        function getStorageLocationOptionsHTML(currentLocation) {
            let html = `<option value="${CONFIG.DEFAULT_LOCATION}" ${!currentLocation || currentLocation === CONFIG.DEFAULT_LOCATION ? "selected" : ""}>${CONFIG.DEFAULT_LOCATION}</option>`;
            CONFIG.STORAGE_LOCATIONS.forEach(location => {
                html += `<option value="${location}" ${currentLocation === location ? "selected" : ""}>${location}</option>`;
            });
            return html;
        }
        
        // Template function for sample table row
        function createSampleRowHTML(sample) {
            return `
                <td class="col-select">
                    <input type="checkbox" name="select_checkbox" value="${sample.unique_id}">
                </td>
                <td class="col-opportunity">${sample.opportunity_number}</td>
                <td class="col-customer">${sample.customer}</td>
                <td class="col-rsm">${sample.rsm}</td>
                <td class="col-date">${sample.date_received}</td>
                <td class="col-description">${sample.description}</td>
                <td class="col-id">${sample.unique_id}</td>
                <td class="col-location">
                    <select class="location-select" data-sample-id="${sample.unique_id}">
                        ${getStorageLocationOptionsHTML(sample.storage_location || sample.location)}
                    </select>
                </td>
                <td class="col-pictures">
                    <button type="button" class="picture-btn" data-sample-id="${sample.unique_id}">Upload/View</button>
                </td>
                <td class="col-documentation">
                    <a href="${CONFIG.SHAREPOINT_BASE_URL}${sample.opportunity_number}" target="_blank">Documentation</a>
                </td>
            `;
        }
        
        // Template function for group header row
        function createGroupRowHTML(oppNum, customer, rsm, count) {
            const sanitizedOppNum = sanitizeOppNum(oppNum);
            return `
                <td class="col-select">
                    <button type="button" class="expand-button" data-opp-num="${sanitizedOppNum}">+</button>
                </td>
                <td class="col-opportunity">${oppNum}</td>
                <td class="col-customer">${customer}</td>
                <td class="col-rsm">${rsm}</td>
                <td colspan="6">(${count} entries)</td>
            `;
        }
        
        // Helper function to clean up empty groups
        function cleanupEmptyGroups(affectedGroups) {
            affectedGroups.forEach(oppNum => {
                const sanitizedOppNum = sanitizeOppNum(oppNum);
                const remainingRows = document.querySelectorAll(`.group-${sanitizedOppNum}`);
                if (remainingRows.length === 0) {
                    const groupRow = document.querySelector(`.group-row[data-opp-num="${sanitizedOppNum}"]`);
                    if (groupRow) {
                        groupRow.parentNode.removeChild(groupRow);
                    }
                }
            });
        }
        
        // Utility function to get selected sample IDs
        function getSelectedSampleIds() {
            const selectedCheckboxes = document.querySelectorAll('input[name="select_checkbox"]:checked');
            return Array.from(selectedCheckboxes).map(checkbox => checkbox.value);
        }
        
        // Utility function to get affected groups from selected checkboxes
        function getAffectedGroups(selectedCheckboxes) {
            const affectedGroups = new Set();
            selectedCheckboxes.forEach(checkbox => {
                const row = checkbox.closest('tr');
                const oppNumCell = row.querySelector('.col-opportunity');
                if (oppNumCell) {
                    const oppNum = oppNumCell.textContent.trim();
                    affectedGroups.add(oppNum);
                }
            });
            return affectedGroups;
        }
        
        // Utility function to create FormData with CSRF token
        function createFormDataWithCSRF(data = {}) {
            const formData = new FormData();
            formData.append('csrfmiddlewaretoken', csrftoken);
            for (const [key, value] of Object.entries(data)) {
                if (typeof value === 'object' && !Array.isArray(value)) {
                    formData.append(key, JSON.stringify(value));
                } else if (Array.isArray(value)) {
                    formData.append(key, JSON.stringify(value));
                } else {
                    formData.append(key, value);
                }
            }
            return formData;
        }
        
        // Utility function for fetch with standard error handling
        function fetchWithErrorHandling(url, options) {
            return fetch(url, {
                ...options,
                headers: {
                    'X-CSRFToken': csrftoken,
                    ...options.headers
                },
                credentials: 'same-origin'
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => { throw err; });
                }
                return response.json();
            });
        }

        function showPrevImage(event) {
            event.stopPropagation(); // Prevent event bubbling
            if (window.currentImageIndex > 0) {
                window.currentImageIndex--;
            } else {
                window.currentImageIndex = window.currentImageDataArray.length - 1; // Loop back to last image
            }
            viewFullSizeImage(window.currentImageIndex);
        }

        function showNextImage(event) {
            event.stopPropagation(); // Prevent event bubbling
            if (window.currentImageIndex < window.currentImageDataArray.length - 1) {
                window.currentImageIndex++;
            } else {
                window.currentImageIndex = 0; // Loop back to first image
            }
            viewFullSizeImage(window.currentImageIndex);
        }

        function handleKeyDown(event) {
            if (event.key === 'ArrowLeft') {
                showPrevImage(event);
            } else if (event.key === 'ArrowRight') {
                showNextImage(event);
            } else if (event.key === 'Escape') {
                closeFullSizeModal(event);
            }
        }
    </script>

    <!-- Full-Size Image Modal -->
    <div id="fullSizeModal" class="modal" style="display: none;">
        <!-- The content will be dynamically generated in JavaScript -->
    </div>

    <form method="POST" id="sampleForm">
        <!-- Include CSRF token in the form -->
        <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
        <div class="form-container">
            <div class="input-group">
                <label for="customer">Customer:</label>
                <select id="customer" name="customer" onchange="filterOptions()">
                    <option value="">Select a Customer</option>
                    {% for customer in unique_customers %}
                    <option value="{{ customer }}">{{ customer }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="input-group">
                <label for="rsm">RSM:</label>
                <select id="rsm" name="rsm" onchange="filterOptions()">
                    <option value="">Select an RSM</option>
                    {% for rsm in unique_rsms %}
                    <option value="{{ rsm }}">{{ rsm }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="input-group">
                <label for="opportunity_number">Opportunity #:</label>
                <select id="opportunity_number" name="opportunity_number" class="opportunity-dropdown" onchange="populateFieldsFromOpportunity()">
                    <option value="">Select an Opportunity</option>
                </select>
            </div>

            <div class="input-group">
                <label for="description">Description:</label>
                <input type="text" id="description" name="description" readonly>
            </div>
            <input type="hidden" id="apps_eng" name="apps_eng" value="">
        </div>
    </form>
    
    <div class="button-container" data-form="sampleForm">
        <button type="button" id="add-sample-button">Add Sample</button>
        <button type="button" id="remove-from-inventory-button">Remove From Inventory</button>
        <button type="button" id="reset-filters-button">Reset</button>
        <button type="button" id="print-all-button">Print</button>
        <button type="button" id="export-all-button">Export</button>
        <button type="button" id="delete-all-button">Delete</button>
    </div>

    <!-- Sticky cloned header container (hidden by default) -->
    <div id="stickyHeaderContainer" class="sticky-header-container" style="display: none;">
        <div id="clonedTableWrapper">
            <!-- Cloned table will be inserted here by JavaScript -->
        </div>
    </div>

    <!-- The Table for displaying samples -->
    <div class="table-responsive">
        <table id="samplesTable" border="1">
        <thead>
            <tr>
                <th class="col-select">Select</th>
                <th class="col-opportunity">Opp Number</th>
                <th class="col-customer">Customer</th>
                <th class="col-rsm">RSM</th>
                <th class="col-date">Date Received</th>
                <th class="col-description">Description</th>
                <th class="col-id">ID</th>
                <th class="col-location">Location</th>
                <th class="col-pictures">Pictures</th>
                <th class="col-documentation">Documentation</th>
            </tr>
            <tr>
                <th class="col-select">
                    <input type="checkbox" id="select-all-select">
                </th>
                <th class="col-opportunity"><div class="filter-wrapper"><input type="text" id="opportunityFilter" placeholder="Filter Opportunity" class="filter-input"></div></th>
                <th class="col-customer"><div class="filter-wrapper"><input type="text" id="customerFilter" placeholder="Filter Customer" class="filter-input"></div></th>
                <th class="col-rsm"><div class="filter-wrapper"><input type="text" id="rsmFilter" placeholder="Filter RSM" class="filter-input"></div></th>
                <th class="col-date"><div class="filter-wrapper"><input type="text" id="dateFilter" placeholder="Filter Date" class="filter-input"></div></th>
                <th class="col-description"><div class="filter-wrapper"><input type="text" id="descriptionFilter" placeholder="Filter Description" class="filter-input"></div></th>
                <th class="col-id"><div class="filter-wrapper"><input type="text" id="idFilter" placeholder="Filter ID" class="filter-input"></div></th>
                <th class="col-location"><div class="filter-wrapper"><input type="text" id="locationFilter" placeholder="Filter Location" class="filter-input"></div></th>
                <th class="col-pictures"></th>
                <th class="col-documentation"></th>
            </tr>
        </thead>
        <tbody>
            <!-- Existing samples will be loaded via JavaScript -->
        </tbody>
        </table>
    </div>

    <!-- The Modal for Adding Samples -->
    <div id="addSampleModal" class="modal add-sample-modal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Add Sample</h2>
                    <span class="close modal-close" data-modal="addSampleModal">&times;</span>
                </div>
                <div class="modal-body add-sample-modal">
                    <form id="addSampleForm" onsubmit="submitForm(event); return false;">
                        <div class="modal-form-row">
                            <div class="modal-form-group">
                                <label for="date_received">Date Received:</label>
                                <input type="text" id="date_received" name="date_received">
                            </div>
                            <div class="modal-form-group quantity-group">
                                <label for="quantity">Quantity:</label>
                                <input type="number" id="quantity" name="quantity" min="0">
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="submit">Submit</button>
                            <button type="button" class="modal-close" data-modal="addSampleModal">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- The Upload/View Modal -->
    <div id="uploadModal" class="modal upload-modal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Upload/View Images</h2>
                    <span class="close modal-close" data-modal="uploadModal">&times;</span>
                </div>
                <div class="modal-body">
                    <!-- Progress Container -->
                    <div id="uploadProgressContainer" style="display: none; margin-bottom: 20px;">
                        <div style="margin-bottom: 10px;">
                            <span id="uploadStatusText">Uploading...</span>
                            <span id="uploadPercentage" style="float: right;">0%</span>
                        </div>
                        <div style="background-color: #f0f0f0; border-radius: 4px; overflow: hidden; height: 20px;">
                            <div id="uploadProgressBar" style="background-color: #4CAF50; height: 100%; width: 0%; transition: width 0.3s ease;"></div>
                        </div>
                        <div id="uploadFileInfo" style="margin-top: 10px; font-size: 14px; color: #666;"></div>
                    </div>
                    <!-- Thumbnails Container -->
                    <div id="thumbnailsContainer"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" id="uploadButton" onclick="selectFiles()">Upload</button>
                    <button type="button" class="modal-close" data-modal="uploadModal">Done</button>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript code -->
    <script>
        function pollForFullSizeImages(sampleId, imageIds) {
            var attempts = 0;
            var maxAttempts = CONFIG.POLLING.MAX_ATTEMPTS;
            var intervalTime = CONFIG.POLLING.INTERVAL_TIME;

            var interval = setInterval(function() {
                attempts++;
                if (attempts > maxAttempts) {
                    clearInterval(interval);
                    return;
                }
                fetch("{% url 'get_sample_images' %}?sample_id=" + sampleId)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        var allFullSizeAvailable = imageIds.every(function(id) {
                            var image = data.images.find(img => img.id === id);
                            return image && image.full_size_url;
                        });
                        if (allFullSizeAvailable) {
                            clearInterval(interval);
                            // Refresh the thumbnails
                            displayThumbnails(data.images);
                        }
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    clearInterval(interval);
                });
            }, intervalTime);
        }

        function viewFullSizeImage(index) {
            console.log('viewFullSizeImage called with index:', index);
            window.currentImageIndex = index;
            const imageDataArray = window.currentImageDataArray;
            const imageData = imageDataArray[index];
            const fullSizeImageUrl = imageData.full_size_url;
            const filename = imageData.filename;
            const fullSizeModal = document.getElementById('fullSizeModal');
            if (fullSizeModal) {
                // Set the innerHTML of the modal
                fullSizeModal.innerHTML = `
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header full-size-modal-header">
                                <h2>${filename}</h2>
                                <span class="close" onclick="closeFullSizeModal()">&times;</span>
                            </div>
                            <div class="modal-body">
                                ${index > 0 ? '<button class="prev-button" onclick="showPrevImage(event)">&#10094;</button>' : ''}
                                <img src="${fullSizeImageUrl}" alt="${filename}">
                                ${index < imageDataArray.length - 1 ? '<button class="next-button" onclick="showNextImage(event)">&#10095;</button>' : ''}
                            </div>
                        </div>
                    </div>
                `;
                // Show the modal
                fullSizeModal.style.display = 'flex';
                // Add this line to attach the keydown event listener
                document.addEventListener('keydown', handleKeyDown);
            }
        }

        function closeFullSizeModal(event) {
            if (event) {
                // Only close if clicked outside the modal content
                const modalContent = document.querySelector('#fullSizeModal .modal-content');
                if (modalContent && modalContent.contains(event.target)) {
                    return;
                }
            }
            const fullSizeModal = document.getElementById('fullSizeModal');
            if (fullSizeModal) {
                fullSizeModal.style.display = 'none';
                fullSizeModal.innerHTML = ''; // Optionally clear the modal content

                // Remove the keydown event listener
                document.removeEventListener('keydown', handleKeyDown);
            } else {
                console.error('Modal container not found in the DOM.');
            }
        }

        function sanitizeOppNum(oppNum) {
            return oppNum.replace(/\s+/g, '_').replace(/[^a-zA-Z0-9_-]/g, '');
        }

        document.addEventListener("DOMContentLoaded", function() {
            // Initialize variables
            const csrftoken = '{{ csrf_token }}';
            const samples = {{ samples|safe }};
            const todayDate = new Date().toISOString().split('T')[0];
            let isPopulating = false; // Flag to prevent recursive triggering
            let currentSampleId = null; // For image uploads
            
            // Get the select all checkbox element
            const selectAllSelectCheckbox = document.getElementById('select-all-select');

            // Initialize Select2 for dropdowns with search capability
            $('#customer, #rsm, #opportunity_number').select2({
                width: 'resolve',
                matcher: matchCustom
            });

            // Custom matcher function for multi-keyword search
            function matchCustom(params, data) {
                if ($.trim(params.term) === '') {
                    return data;
                }
                const terms = params.term.toLowerCase().split(' ');
                const original = data.text.toLowerCase();
                const matches = terms.every(term => original.includes(term));

                if (matches) {
                    return data;
                }
                return null;
            }

            // Event listener for the print button
            document.getElementById('print-all-button').addEventListener('click', function() {
                submitPrint();
            });
            
            // Event listener for the add sample button
            document.getElementById('add-sample-button').addEventListener('click', function() {
                validateAndShowModal();
            });
            
            // Event listener for the remove from inventory button
            document.getElementById('remove-from-inventory-button').addEventListener('click', function() {
                removeFromInventory();
            });
            
            // Event listener for the reset filters button
            document.getElementById('reset-filters-button').addEventListener('click', function() {
                resetFilters();
            });

            // Event listener for the export button
            document.getElementById('export-all-button').addEventListener('click', function() {
                const selectedCheckboxes = document.querySelectorAll('input[name="select_checkbox"]:checked');
                if (selectedCheckboxes.length === 0) {
                    alert('No samples selected for export.');
                    return;
                }

                // Gather distinct opportunity numbers from selected checkboxes
                const oppNums = new Set();
                selectedCheckboxes.forEach(checkbox => {
                    const row = checkbox.closest('tr');
                    const oppCell = row.querySelector('.col-opportunity');
                    if (oppCell) {
                        oppNums.add(oppCell.textContent.trim());
                    }
                });

                // If more than one opp number is found, display alert
                if (oppNums.size > 1) {
                    alert('Only one opportunity can be selected at a time for export.');
                    return;
                }

                const oppNumber = Array.from(oppNums)[0];

                fetch("{% url 'export_documentation' %}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify({
                        'opportunity_number': oppNumber
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert('Export request submitted successfully. A background job is processing your request!');
                    } else {
                        console.error('Export error:', data.error);
                        alert('Export error: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Fetch error:', error);
                });
                console.log('Proceed with export for opportunity:', Array.from(oppNums)[0]);
            });

            // Submit Print function
            window.submitPrint = function() {
                const selectedCheckboxes = document.querySelectorAll('input[name="select_checkbox"]:checked');
                const idsToPrint = getSelectedSampleIds();

                if (idsToPrint.length === 0) {
                    return;
                }

                console.log(`Proceeding to print ${idsToPrint.length} entries.`);

                // Get affected groups for cleanup
                const affectedGroups = getAffectedGroups(selectedCheckboxes);

                fetch("{% url 'handle_print_request' %}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken
                    },
                    body: JSON.stringify({'ids': idsToPrint}),
                    credentials: 'same-origin'  // Include cookies in the request
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => { throw err; });
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.status === 'success') {
                        // Labels have been generated successfully

                        // Here you would send this data to your printer
                        // Clean up any empty groups
                        cleanupEmptyGroups(affectedGroups);

                    } else {
                        console.error('Error generating labels:', data.error);
                    }
                })
                .catch(error => {
                    console.error('Fetch Error:', error);
                });
            };

            // Minimize all groups
            const expandButtons = document.querySelectorAll('.expand-button');
            expandButtons.forEach(button => {
                button.textContent = '+';
                const sanitizedOppNum = button.getAttribute('data-opp-num'); // Already sanitized
                const groupedRows = document.querySelectorAll(`.group-${sanitizedOppNum}`);
                groupedRows.forEach(row => {
                    row.style.display = 'none';
                });
            });

            // Delete selected entries
            document.getElementById('delete-all-button').addEventListener('click', function() {
                const selectedCheckboxes = document.querySelectorAll('input[name="select_checkbox"]:checked');
                const idsToDelete = getSelectedSampleIds();

                if (idsToDelete.length === 0) {
                    alert('No entries selected for deletion.');
                    return;
                }

                if (confirm('Are you sure you want to delete the selected entries?')) {
                    const formData = createFormDataWithCSRF({ ids: idsToDelete });

                    // Get affected groups for cleanup
                    const affectedGroups = getAffectedGroups(selectedCheckboxes);

                    fetch("{% url 'delete_samples' %}", {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-CSRFToken': csrftoken
                        },
                        credentials: 'same-origin'  // Include cookies
                    }).then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            selectedCheckboxes.forEach(checkbox => {
                                const row = checkbox.closest('tr');
                                row.parentNode.removeChild(row); // Remove the row from the table
                            });

                            // Clean up any empty groups
                            cleanupEmptyGroups(affectedGroups);

                            selectAllSelectCheckbox.checked = false; // Clear the "Select All" checkbox
                            console.log('Entries deleted successfully.');
                        } else {
                            console.error('Error deleting entries:', data.error);
                        }
                    });
                }
            });

            // Select All functionality - just check/uncheck boxes and let the change event handle highlighting
            if (selectAllSelectCheckbox) {
                selectAllSelectCheckbox.addEventListener('change', function() {
                    const visibleSampleRows = document.querySelectorAll('#samplesTable tbody tr:not([style*="display: none"]):not(.group-row)');
                    visibleSampleRows.forEach(function(row) {
                        const checkbox = row.querySelector('input[name="select_checkbox"]');
                        if (checkbox) {
                            checkbox.checked = this.checked;
                            // Trigger the change event to handle highlighting
                            checkbox.dispatchEvent(new Event('change', { bubbles: true }));
                        }
                    }, this);
                });
            }

            // Update Sample Location function
            window.updateSampleLocation = function(sampleId, location) {
                // Get all selected checkboxes
                const selectedCheckboxes = document.querySelectorAll('input[name="select_checkbox"]:checked');

                // If there are selected checkboxes, update all of them
                if (selectedCheckboxes.length > 0) {
                    const idsToUpdate = Array.from(selectedCheckboxes).map(checkbox => checkbox.value);

                    const formData = new FormData();
                    formData.append('csrfmiddlewaretoken', csrftoken);
                    formData.append('ids', JSON.stringify(idsToUpdate));
                    formData.append('location', location);

                    fetch("{% url 'update_sample_location' %}", {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-CSRFToken': csrftoken
                        },
                        credentials: 'same-origin'  // Include cookies
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            console.log('Sample locations updated successfully for selected samples.');

                            // Update the dropdowns in real-time
                            idsToUpdate.forEach(id => {
                                const dropdown = document.querySelector(`select[data-sample-id="${id}"]`);
                                if (dropdown) {
                                    dropdown.value = location;
                                }
                            });
                        } else {
                            console.error('Error updating sample locations:', data.error);
                        }
                    })
                    .catch(error => {
                        console.error('Fetch error:', error);
                    });
                } else {
                    // If no checkboxes are selected, update only the single sample whose dropdown was changed
                    const formData = new FormData();
                    formData.append('csrfmiddlewaretoken', csrftoken);
                    formData.append('sample_id', sampleId);
                    formData.append('location', location);

                    fetch("{% url 'update_sample_location' %}", {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-CSRFToken': csrftoken
                        },
                        credentials: 'same-origin'  // Include cookies
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            console.log(`Sample location updated successfully for sample ID: ${sampleId}.`);

                            // Update the dropdown in real-time
                            const dropdown = document.querySelector(`select[data-sample-id="${sampleId}"]`);
                            if (dropdown) {
                                dropdown.value = location;
                            }
                        } else {
                            console.error(`Error updating sample location for sample ID: ${sampleId}:`, data.error);
                        }
                    })
                    .catch(error => {
                        console.error('Fetch error:', error);
                    });
                }
            };

            // Submit Form function
            window.submitForm = function(event) {
                if (event) event.preventDefault();
                const dateReceived = $('#date_received').val();
                const quantity = $('#quantity').val();

                if (quantity === "") {
                    alert("Please enter the quantity.");
                } else {
                    const customer = document.getElementById('customer').value;
                    const rsm = document.getElementById('rsm').value;
                    const opportunityNumber = document.getElementById('opportunity_number').value;
                    const description = document.getElementById('description').value;
                    const location = CONFIG.DEFAULT_LOCATION;

                    const formData = new FormData();
                    formData.append('csrfmiddlewaretoken', csrftoken);
                    formData.append('date_received', dateReceived);
                    formData.append('customer', customer);
                    formData.append('rsm', rsm);
                    formData.append('opportunity_number', opportunityNumber);
                    formData.append('description', description);
                    formData.append('location', location);
                    formData.append('quantity', quantity);
                    formData.append('apps_eng', document.getElementById('apps_eng').value);

                    fetch("{% url 'create_sample' %}", {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-CSRFToken': csrftoken
                        },
                        credentials: 'same-origin'  // Include cookies
                    }).then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            data.created_samples.forEach(sample => {
                                const newRow = document.createElement('tr');
                                newRow.innerHTML = createSampleRowHTML(sample);
                                document.querySelector('#samplesTable tbody').appendChild(newRow);
                            });
                            console.log('Sample saved successfully.');
                        } else {
                            console.error('Error saving sample:', data.error);
                        }
                    });

                    closeAddSampleModal();
                    resetForm();
                }
            };

            // Filter Options function
            window.filterOptions = function() {
                if (isPopulating) return;
                const customer = document.getElementById('customer').value;
                const rsm = document.getElementById('rsm').value;

                const filteredData = excelData.filter(record =>
                    (customer === "" || record['Customer'] === customer) &&
                    (rsm === "" || record['RSM'] === rsm)
                );

                updateSelectOptions(document.getElementById('customer'), 'Customer', filteredData, customer);
                updateSelectOptions(document.getElementById('rsm'), 'RSM', filteredData, rsm);
                updateSelectOptions(document.getElementById('opportunity_number'), 'Opportunity #', filteredData);
            };

            // Populate Fields from Opportunity function
            window.populateFieldsFromOpportunity = function() {
                const opportunityNumber = document.getElementById('opportunity_number').value;
                const selectedData = excelData.find(record => record['Opportunity #'] === parseInt(opportunityNumber));

                if (selectedData) {
                    isPopulating = true; // Set flag to true
                    $('#customer').val(selectedData['Customer']).trigger('change.select2');
                    $('#rsm').val(selectedData['RSM']).trigger('change.select2');
                    document.getElementById('description').value = selectedData['Description'];
                    document.getElementById('apps_eng').value = selectedData['Application Engineer'] || '';
                    isPopulating = false; // Reset flag to false
                } else {
                    document.getElementById('description').value = '';
                }
            };

            // Open Add Sample Modal function
            function openAddSampleModal() {
                // Initialize date picker when modal opens
                $("#date_received").datepicker({ dateFormat: 'yy-mm-dd' }).datepicker("setDate", new Date());

                document.getElementById('addSampleModal').style.display = 'block';

                // Set focus to the quantity field after ensuring the element is rendered
                setTimeout(function() {
                    document.getElementById('quantity').focus();
                }, 0);
            }

            // Close Add Sample Modal function
            window.closeAddSampleModal = function() {
                document.getElementById('addSampleModal').style.display = 'none';
                resetAddSampleForm();
            }

            // Reset Add Sample Form function
            function resetAddSampleForm() {
                document.getElementById('addSampleForm').reset();
            }

            // Validate and Show Modal function
            window.validateAndShowModal = function() {
                const customer = document.getElementById('customer').value;
                const rsm = document.getElementById('rsm').value;
                const opportunityNumber = document.getElementById('opportunity_number').value;

                if (customer === "" || rsm === "" || opportunityNumber === "") {
                    alert("Please complete all selections before adding a sample.");
                } else {
                    openAddSampleModal();
                }
            };

            // Close the modal when clicking outside of it
            window.onclick = function(event) {
                const modal = document.getElementById('addSampleModal');
                if (event.target === modal) {
                    closeAddSampleModal();
                }
            };

            // Reset Filters function
            window.resetFilters = function() {
                // Reset dropdown filters
                document.getElementById('customer').value = "";
                document.getElementById('rsm').value = "";
                document.getElementById('opportunity_number').value = "";
                document.getElementById('description').value = "";

                // Update dropdown options to default
                updateSelectOptions(document.getElementById('customer'), 'Customer', excelData);
                updateSelectOptions(document.getElementById('rsm'), 'RSM', excelData);
                updateSelectOptions(document.getElementById('opportunity_number'), 'Opportunity #', excelData);

                // Reset Select2 elements
                $('#customer, #rsm, #opportunity_number').val(null).trigger('change.select2');

                // Clear text filters in the table
                document.getElementById('idFilter').value = "";
                document.getElementById('dateFilter').value = "";
                document.getElementById('customerFilter').value = "";
                document.getElementById('rsmFilter').value = "";
                document.getElementById('opportunityFilter').value = "";
                document.getElementById('descriptionFilter').value = "";
                document.getElementById('locationFilter').value = "";

                // Uncheck all checkboxes in the table and remove highlighting
                const checkboxes = document.querySelectorAll('input[name="select_checkbox"]');
                checkboxes.forEach(checkbox => {
                    checkbox.checked = false;
                    const row = checkbox.closest('tr');
                    row.classList.remove('selected-row');
                });

                // Clear the "Select All" checkbox
                const selectAllCheckbox = document.getElementById('select-all-select');
                if (selectAllCheckbox) {
                    selectAllCheckbox.checked = false;
                }

                // Reapply filters to clear the table
                filterTable();

                // Collapse all groups
                const expandButtons = document.querySelectorAll('.expand-button');
                expandButtons.forEach(button => {
                    button.textContent = '+';
                    const sanitizedOppNum = button.getAttribute('data-opp-num'); // Already sanitized
                    const groupedRows = document.querySelectorAll(`.group-${sanitizedOppNum}`);
                    groupedRows.forEach(row => {
                        row.style.display = 'none';
                    });
                });
            };

            // Update Select Options function
            function updateSelectOptions(selectElement, key, filteredData, currentValue = "") {
                const uniqueValues = [...new Set(filteredData.map(record => record[key]))];
                uniqueValues.sort((a, b) => {
                    if (key === 'Opportunity #') {
                        return a - b;
                    }
                    return a.localeCompare(b);
                });

                selectElement.innerHTML = '<option value="">Select an option</option>';
                uniqueValues.forEach(value => {
                    if (value) {
                        const option = document.createElement('option');
                        option.value = value;
                        option.textContent = value;
                        if (value === currentValue) {
                            option.selected = true;
                        }
                        selectElement.appendChild(option);
                    }
                });

                // Reinitialize Select2 after updating options
                $(selectElement).select2({
                    width: 'resolve',
                    matcher: matchCustom
                });
            }

            const groupsToShow = new Set();
            window.filterTable = function() {
                // Cache filter values
                const filters = {
                    id: document.getElementById('idFilter').value.toLowerCase(),
                    date: document.getElementById('dateFilter').value.toLowerCase(),
                    customer: document.getElementById('customerFilter').value.toLowerCase(),
                    rsm: document.getElementById('rsmFilter').value.toLowerCase(),
                    opportunity: document.getElementById('opportunityFilter').value.toLowerCase(),
                    description: document.getElementById('descriptionFilter').value.toLowerCase(),
                    location: document.getElementById('locationFilter').value.toLowerCase()
                };

                const filtersApplied = Object.values(filters).some(f => f !== '');

                const table = document.getElementById('samplesTable');
                const tr = table.getElementsByTagName('tr');

                for (let i = 2; i < tr.length; i++) { // Start from 2 to skip header rows
                    const row = tr[i];

                    // Check if the row is a group row
                    if (row.classList.contains('group-row')) {
                        const oppNum = row.querySelector('.col-opportunity').textContent;
                        const sanitizedOppNum = sanitizeOppNum(oppNum);
                        const expandButton = row.querySelector('.expand-button');
                        const isExpanded = expandButton.textContent === '-';

                        // Decide whether to display the group row based on if any of its children match the filter
                        const groupedRows = document.querySelectorAll(`.group-${sanitizedOppNum}`);
                        let groupHasMatch = false;

                        groupedRows.forEach(childRow => {
                            const cells = childRow.getElementsByTagName('td');
                            if (cells.length >= 8) {
                                // Cache cell text content
                                const rowData = {
                                    opportunity: (cells[1].textContent || '').toLowerCase(),
                                    customer: (cells[2].textContent || '').toLowerCase(),
                                    rsm: (cells[3].textContent || '').toLowerCase(),
                                    date: (cells[4].textContent || '').toLowerCase(),
                                    description: (cells[5].textContent || '').toLowerCase(),
                                    id: (cells[6].textContent || '').toLowerCase(),
                                    location: (cells[7].textContent || '').toLowerCase()
                                };

                                // Check if row matches all filters
                                const matches = 
                                    rowData.id.includes(filters.id) &&
                                    rowData.date.includes(filters.date) &&
                                    rowData.customer.includes(filters.customer) &&
                                    rowData.rsm.includes(filters.rsm) &&
                                    rowData.opportunity.includes(filters.opportunity) &&
                                    rowData.description.includes(filters.description) &&
                                    rowData.location.includes(filters.location);

                                if (matches) {
                                    groupHasMatch = true;
                                    childRow.style.display = ''; // Show matching child rows
                                } else {
                                    childRow.style.display = 'none';
                                }
                            }
                        });

                        if (groupHasMatch) {
                            row.style.display = '';
                            const expandButton = row.querySelector('.expand-button');
                            if (filtersApplied) {
                                expandButton.textContent = '-'; // Expand group if filters are applied
                                // Child rows are already properly shown/hidden in the loop above
                            } else {
                                expandButton.textContent = '+';
                                groupedRows.forEach(childRow => {
                                    childRow.style.display = 'none'; // Keep child rows hidden when no filters
                                });
                            }
                        } else {
                            // Hide the group row if no children match the filter
                            row.style.display = 'none';
                        }

                        continue; // Move to the next row
                    }

                    // Process rows that are not part of a group (if any)
                    const cells = row.getElementsByTagName('td');
                    if (cells.length >= 8) {
                        // Cache cell text content
                        const rowData = {
                            opportunity: (cells[1].textContent || '').toLowerCase(),
                            customer: (cells[2].textContent || '').toLowerCase(),
                            rsm: (cells[3].textContent || '').toLowerCase(),
                            date: (cells[4].textContent || '').toLowerCase(),
                            description: (cells[5].textContent || '').toLowerCase(),
                            id: (cells[6].textContent || '').toLowerCase(),
                            location: (cells[7].textContent || '').toLowerCase()
                        };

                        // Check if row matches all filters
                        const matches = 
                            rowData.id.includes(filters.id) &&
                            rowData.date.includes(filters.date) &&
                            rowData.customer.includes(filters.customer) &&
                            rowData.rsm.includes(filters.rsm) &&
                            rowData.opportunity.includes(filters.opportunity) &&
                            rowData.description.includes(filters.description) &&
                            rowData.location.includes(filters.location);

                        if (matches) {
                            row.style.display = '';
                        } else {
                            row.style.display = 'none';
                        }
                    }
                }
            };

            // Reset Form function
            window.resetForm = function() {
                document.getElementById('sampleForm').reset(); // Resets all form fields
                // If you're using Select2, reset it as well
                $('#customer, #rsm, #opportunity_number').val(null).trigger('change.select2');
                document.getElementById('description').value = ''; // Clear the description field
            };

            // Initialize dropdowns with all options
            updateSelectOptions(document.getElementById('customer'), 'Customer', excelData);
            updateSelectOptions(document.getElementById('rsm'), 'RSM', excelData);
            updateSelectOptions(document.getElementById('opportunity_number'), 'Opportunity #', excelData);

            // Load existing samples into the table
            // Group samples by 'opportunity_number'
            const groupedSamples = {};
            samples.forEach(sample => {
                const oppNum = sample.opportunity_number;
                if (!groupedSamples[oppNum]) {
                    groupedSamples[oppNum] = [];
                }
                groupedSamples[oppNum].push(sample);
            });

            // Clear the existing table body
            const tableBody = document.querySelector('#samplesTable tbody');
            tableBody.innerHTML = '';
            
            // Use DocumentFragment for better performance
            const fragment = document.createDocumentFragment();

            // Iterate over each group
            Object.keys(groupedSamples).forEach(oppNum => {
                const group = groupedSamples[oppNum];

                // Define new variables to hold the customer and RSM values from the group
                const groupCustomer = group[0].customer;
                const groupRsm = group[0].rsm;

                if (group.length === 1) {
                    // If only one entry, display it as usual
                    const sample = group[0];
                    const newRow = document.createElement('tr');
                    newRow.innerHTML = createSampleRowHTML(sample);
                    fragment.appendChild(newRow);
                } else {
                    // Create a group row without a select box and with a '+' button
                    const sanitizedOppNum = sanitizeOppNum(oppNum);
                    const groupRow = document.createElement('tr');
                    groupRow.classList.add('group-row');
                    groupRow.setAttribute('data-opp-num', sanitizedOppNum);
                    groupRow.innerHTML = createGroupRowHTML(oppNum, groupCustomer, groupRsm, group.length);
                    fragment.appendChild(groupRow);

                    // Add rows for each sample in the group, initially hidden
                    group.forEach(sample => {
                        const sampleRow = document.createElement('tr');
                        sampleRow.classList.add('grouped-row', `group-${sanitizedOppNum}`);
                        sampleRow.style.display = 'none'; // Initially hidden
                        sampleRow.innerHTML = createSampleRowHTML(sample);
                        fragment.appendChild(sampleRow);
                    });
                }
            });
            
            // Append all rows at once
            tableBody.appendChild(fragment);

            // Consolidated event delegation for all change events
            document.addEventListener('change', function(event) {
                const target = event.target;
                
                // Handle checkbox selection highlighting
                if (target.type === 'checkbox' && target.name === 'select_checkbox') {
                    const row = target.closest('tr');
                    if (row) {
                        if (target.checked) {
                            row.classList.add('selected-row');
                        } else {
                            row.classList.remove('selected-row');
                        }
                    }
                }
                // Handle location select changes
                else if (target.classList.contains('location-select')) {
                    const sampleId = target.dataset.sampleId;
                    updateSampleLocation(sampleId, target.value);
                }
            });
            
            // Event delegation for filter inputs
            document.addEventListener('keyup', function(event) {
                if (event.target.classList.contains('filter-input')) {
                    filterTable();
                }
            });
            
            // Consolidated event delegation for all click events
            document.addEventListener('click', function(event) {
                const target = event.target;
                
                // Handle modal close buttons
                if (target.classList.contains('modal-close')) {
                    const modalId = target.dataset.modal;
                    if (modalId === 'addSampleModal') {
                        closeAddSampleModal();
                    } else if (modalId === 'uploadModal') {
                        closeUploadModal();
                    }
                }
                // Handle picture upload/view buttons
                else if (target.classList.contains('picture-btn')) {
                    event.preventDefault();
                    const sampleId = target.dataset.sampleId;
                    handlePictureUploadView(sampleId);
                }
                // Handle expand/collapse buttons
                else if (target.classList.contains('expand-button')) {
                    const sanitizedOppNum = target.getAttribute('data-opp-num');
                    const groupedRows = document.querySelectorAll(`.group-${sanitizedOppNum}`);
                    const isExpanded = target.textContent === '-';

                    if (isExpanded) {
                        // Collapse
                        target.textContent = '+';
                        groupedRows.forEach(row => {
                            row.style.display = 'none';
                        });
                    } else {
                        // Expand
                        target.textContent = '-';
                        groupedRows.forEach(row => {
                            row.style.display = '';
                        });
                    }
                }
            });
            
            // Handle full-size modal clicks
            document.getElementById('fullSizeModal').addEventListener('click', function(event) {
                // Only close if clicked outside the modal content
                const modalContent = this.querySelector('.modal-content');
                if (modalContent && !modalContent.contains(event.target)) {
                    closeFullSizeModal(event);
                }
            });
        }); // Properly close the DOMContentLoaded function

        // Functions that should be globally accessible
        function removeFromInventory() {
            const selectedCheckboxes = document.querySelectorAll('input[name="select_checkbox"]:checked');
            const idsToRemove = getSelectedSampleIds();

            if (idsToRemove.length === 0) {
                alert('No entries selected to remove from inventory.');
                return;
            }

            if (!confirm('Are you sure you want to remove the selected entries from inventory?')) {
                return;
            }

            const formData = createFormDataWithCSRF({ ids: idsToRemove });

            fetchWithErrorHandling("{% url 'remove_from_inventory' %}", {
                method: 'POST',
                body: formData
            })
            .then(data => {
                if (data.status === 'success') {
                    // Remove the rows from the table
                    selectedCheckboxes.forEach(checkbox => {
                        const row = checkbox.closest('tr');
                        row.parentNode.removeChild(row);
                    });

                    // Update group rows if necessary
                    const affectedGroups = getAffectedGroups(selectedCheckboxes);
                    cleanupEmptyGroups(affectedGroups);

                    // Uncheck the "Select All" checkbox
                    document.getElementById('select-all-select').checked = false;

                    console.log('Entries removed from inventory successfully.');
                } else {
                    console.error('Error removing entries from inventory:', data.error);
                }
            })
            .catch(error => {
                console.error('Fetch error:', error);
            });
        }
        
        function handlePictureUploadView(sampleId) {
            currentSampleId = sampleId;
            // Open the modal
            document.getElementById('uploadModal').style.display = 'block';

            // Clear previous thumbnails
            document.getElementById('thumbnailsContainer').innerHTML = '';

            // Fetch existing images for this sample and display thumbnails
            fetch("{% url 'get_sample_images' %}?sample_id=" + sampleId)
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    displayThumbnails(data.images);
                } else {
                    console.error('Error fetching images:', data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }

        function selectFiles() {
            // Create a hidden file input element
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.multiple = true;
            fileInput.accept = 'image/*';
            fileInput.style.display = 'none';

            // Append the file input to the body
            document.body.appendChild(fileInput);

            // Trigger the file input click event to open the file dialog
            fileInput.click();

            // Handle file selection
            fileInput.addEventListener('change', function() {
                const files = fileInput.files;
                if (files.length > 0) {
                    uploadFiles(files, currentSampleId);
                }
                // Remove the file input after use
                document.body.removeChild(fileInput);
            });
        }

        function uploadFiles(files, sampleId) {
            const formData = new FormData();
            let totalSize = 0;
            for (let i = 0; i < files.length; i++) {
                formData.append('files', files[i]);
                totalSize += files[i].size;
            }
            formData.append('sample_id', sampleId);

            // Show progress container and update file info
            const progressContainer = document.getElementById('uploadProgressContainer');
            const progressBar = document.getElementById('uploadProgressBar');
            const percentageText = document.getElementById('uploadPercentage');
            const statusText = document.getElementById('uploadStatusText');
            const fileInfo = document.getElementById('uploadFileInfo');
            const uploadButton = document.getElementById('uploadButton');
            const thumbnailsContainer = document.getElementById('thumbnailsContainer');
            
            progressContainer.style.display = 'block';
            uploadButton.disabled = true;
            
            // Update file info
            const fileCount = files.length;
            const sizeInMB = (totalSize / (1024 * 1024)).toFixed(2);
            fileInfo.textContent = `Uploading ${fileCount} file${fileCount > 1 ? 's' : ''} (${sizeInMB} MB)`;
            
            // Add loading placeholders for expected thumbnails
            const existingThumbnails = thumbnailsContainer.innerHTML;
            let placeholders = '';
            for (let i = 0; i < fileCount; i++) {
                placeholders += '<div class="thumbnail-placeholder"></div>';
            }
            thumbnailsContainer.innerHTML = existingThumbnails + placeholders;

            // Use XMLHttpRequest for progress tracking
            const xhr = new XMLHttpRequest();
            
            xhr.upload.addEventListener('progress', function(e) {
                if (e.lengthComputable) {
                    const percentComplete = Math.round((e.loaded / e.total) * 100);
                    progressBar.style.width = percentComplete + '%';
                    percentageText.textContent = percentComplete + '%';
                    
                    if (percentComplete === 100) {
                        statusText.textContent = 'Processing thumbnails...';
                    }
                }
            });
            
            xhr.addEventListener('load', function() {
                if (xhr.status === 200) {
                    try {
                        const data = JSON.parse(xhr.responseText);
                        if (data.status === 'success') {
                            statusText.textContent = 'Upload complete!';
                            progressBar.style.backgroundColor = '#4CAF50';
                            
                            // Refresh the view with actual thumbnails
                            setTimeout(() => {
                                progressContainer.style.display = 'none';
                                progressBar.style.width = '0%';
                                percentageText.textContent = '0%';
                                statusText.textContent = 'Uploading...';
                                progressBar.style.backgroundColor = '#4CAF50';
                                uploadButton.disabled = false;
                                
                                handlePictureUploadView(sampleId);
                                // Start polling for full-size images
                                var uploadedImageIds = data.image_ids;
                                pollForFullSizeImages(sampleId, uploadedImageIds);
                            }, 500);
                        } else {
                            throw new Error(data.error || 'Upload failed');
                        }
                    } catch (error) {
                        console.error('Error parsing response:', error);
                        statusText.textContent = 'Upload failed!';
                        progressBar.style.backgroundColor = '#f44336';
                        alert('Error: ' + error.message);
                        uploadButton.disabled = false;
                        // Remove placeholders on error
                        thumbnailsContainer.innerHTML = existingThumbnails;
                    }
                } else {
                    statusText.textContent = 'Upload failed!';
                    progressBar.style.backgroundColor = '#f44336';
                    alert('Upload failed with status: ' + xhr.status);
                    uploadButton.disabled = false;
                    // Remove placeholders on error
                    thumbnailsContainer.innerHTML = existingThumbnails;
                }
            });
            
            xhr.addEventListener('error', function() {
                statusText.textContent = 'Upload failed!';
                progressBar.style.backgroundColor = '#f44336';
                alert('Network error occurred during upload');
                uploadButton.disabled = false;
                // Remove placeholders on error
                thumbnailsContainer.innerHTML = existingThumbnails;
            });
            
            xhr.open('POST', "{% url 'upload_files' %}");
            xhr.setRequestHeader('X-CSRFToken', csrftoken);
            xhr.send(formData);
        }

        function displayThumbnails(imageDataArray) {
            // Store the image data globally
            window.currentImageDataArray = imageDataArray;

            const thumbnailsContainer = document.getElementById('thumbnailsContainer');
            // Clear existing thumbnails
            thumbnailsContainer.innerHTML = '';

            const thumbnailWidth = CONFIG.THUMBNAIL.WIDTH;
            const gap = CONFIG.THUMBNAIL.GAP;
            const maxModalWidth = window.innerWidth * 0.9; // 90% of viewport width as max
            const minModalWidth = CONFIG.THUMBNAIL.MIN_MODAL_WIDTH;

            // Determine the number of thumbnails per row that can fit within maxModalWidth
            const thumbnailsPerRow = Math.floor((maxModalWidth + gap) / (thumbnailWidth + gap)) || 1;
            const totalThumbnails = imageDataArray.length;

            // Calculate the required modal width based on thumbnails
            const columns = Math.min(totalThumbnails, thumbnailsPerRow);
            const calculatedWidth = columns * (thumbnailWidth + gap) - gap; // Subtract extra gap at the end

            // Ensure the modal width is at least the minimum width
            const neededWidth = Math.max(calculatedWidth, minModalWidth);

            // Adjust the modal width
            const modalDialog = document.querySelector('.upload-modal .modal-dialog');
            modalDialog.style.width = neededWidth + 'px';

            imageDataArray.forEach((imageData, index) => {
                const wrapper = document.createElement('div');
                wrapper.classList.add('thumbnail-wrapper');

                // Create an anchor tag linking to the full-size image
                const link = document.createElement('a');
                link.href = imageData.full_size_url || imageData.url;  // Use full_size_url if available
                link.target = '_blank';  // Open in a new tab or modify as needed

                link.addEventListener('click', function(event) {
                    event.preventDefault();
                    if (imageData.full_size_url) {
                        // Pass the index instead of the URL
                        viewFullSizeImage(index);
                    } else {
                        alert('The full-size image is still being processed. Please try again shortly.');
                    }
                });

                const img = document.createElement('img');
                img.src = imageData.url;

                link.appendChild(img);

                const deleteButton = document.createElement('button');
                deleteButton.classList.add('delete-button');
                deleteButton.textContent = '×';

                // Add event listener to delete button
                deleteButton.addEventListener('click', function() {
                    deleteImage(imageData.id, wrapper);
                });

                wrapper.appendChild(link);  // Append the link to the wrapper
                wrapper.appendChild(deleteButton);
                thumbnailsContainer.appendChild(wrapper);
            });
        }

        function deleteImage(imageId, thumbnailElement) {
            const formData = new FormData();
            formData.append('image_id', imageId);

            fetch("{% url 'delete_sample_image' %}", {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': csrftoken
                },
                credentials: 'same-origin'
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // Remove the thumbnail element from the DOM
                    thumbnailElement.parentNode.removeChild(thumbnailElement);
                } else {
                    alert('Error deleting image: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An unexpected error occurred while deleting the image.');
            });
        }

        function closeUploadModal() {
            document.getElementById('uploadModal').style.display = 'none';
            currentSampleId = null;
        }
        
        // Add shadow to sticky button container when scrolled
        window.addEventListener('scroll', function() {
            const buttonContainer = document.querySelector('.button-container');
            if (buttonContainer) {
                if (window.scrollY > 50) {
                    buttonContainer.classList.add('scrolled');
                } else {
                    buttonContainer.classList.remove('scrolled');
                }
            }
        });
        
        // Clone and sync table headers for sticky behavior
        function initializeStickyHeaders() {
            const originalTable = document.getElementById('samplesTable');
            const stickyContainer = document.getElementById('stickyHeaderContainer');
            const clonedWrapper = document.getElementById('clonedTableWrapper');
            
            if (!originalTable || !stickyContainer || !clonedWrapper) return;
            
            // Create a perfect clone of the table structure
            function createPerfectClone() {
                // Clone the table with attributes
                const clonedTable = originalTable.cloneNode(false);
                clonedTable.id = 'clonedHeaderTable';
                
                // Copy all attributes except id
                for (let attr of originalTable.attributes) {
                    if (attr.name !== 'id') {
                        clonedTable.setAttribute(attr.name, attr.value);
                    }
                }
                
                // Clone only the thead
                const originalThead = originalTable.querySelector('thead');
                const clonedThead = originalThead.cloneNode(true);
                clonedTable.appendChild(clonedThead);
                
                // Add empty tbody to maintain table structure
                const emptyTbody = document.createElement('tbody');
                clonedTable.appendChild(emptyTbody);
                
                // Clear wrapper and add cloned table
                clonedWrapper.innerHTML = '';
                clonedWrapper.appendChild(clonedTable);
                
                return clonedTable;
            }
            
            const clonedTable = createPerfectClone();
            
            // Function to sync exact column widths using getComputedStyle
            function syncColumnWidths() {
                const originalCells = originalTable.querySelectorAll('thead tr:first-child th');
                const clonedCells = clonedTable.querySelectorAll('thead tr:first-child th');
                
                // First, copy the table's computed width and ALL styles
                const tableStyle = window.getComputedStyle(originalTable);
                clonedTable.style.width = tableStyle.width;
                clonedTable.style.tableLayout = tableStyle.tableLayout;
                clonedTable.style.borderCollapse = tableStyle.borderCollapse;
                clonedTable.style.borderSpacing = tableStyle.borderSpacing;
                
                // Then copy each cell's exact computed width and ALL relevant styles
                originalCells.forEach((cell, index) => {
                    if (clonedCells[index]) {
                        const cellStyle = window.getComputedStyle(cell);
                        
                        // Copy all sizing and styling
                        clonedCells[index].style.width = cellStyle.width;
                        clonedCells[index].style.minWidth = cellStyle.minWidth;
                        clonedCells[index].style.maxWidth = cellStyle.maxWidth;
                        clonedCells[index].style.padding = cellStyle.padding;
                        clonedCells[index].style.boxSizing = cellStyle.boxSizing;
                        clonedCells[index].style.border = cellStyle.border;
                        clonedCells[index].style.backgroundColor = cellStyle.backgroundColor;
                        clonedCells[index].style.color = cellStyle.color;
                    }
                });
                
                // Also copy styles to filter row cells
                const originalFilterCells = originalTable.querySelectorAll('thead tr:nth-child(2) th');
                const clonedFilterCells = clonedTable.querySelectorAll('thead tr:nth-child(2) th');
                
                originalFilterCells.forEach((cell, index) => {
                    if (clonedFilterCells[index]) {
                        const cellStyle = window.getComputedStyle(cell);
                        clonedFilterCells[index].style.width = originalCells[index] ? window.getComputedStyle(originalCells[index]).width : cellStyle.width;
                        clonedFilterCells[index].style.padding = cellStyle.padding;
                        clonedFilterCells[index].style.backgroundColor = cellStyle.backgroundColor;
                        clonedFilterCells[index].style.border = cellStyle.border;
                    }
                });
                
                // Sync scroll position
                const tableContainer = originalTable.parentElement;
                if (tableContainer && tableContainer.scrollLeft) {
                    stickyContainer.scrollLeft = tableContainer.scrollLeft;
                }
            }
            
            // Sync input values and events between original and cloned headers
            function syncInputs() {
                // Get all filter inputs from both tables
                const originalInputs = originalTable.querySelectorAll('thead input, thead select');
                const clonedInputs = clonedTable.querySelectorAll('thead input, thead select');
                
                originalInputs.forEach((input, index) => {
                    if (clonedInputs[index]) {
                        // Sync initial values
                        clonedInputs[index].value = input.value;
                        
                        // Mirror events from clone to original
                        clonedInputs[index].addEventListener('input', function() {
                            input.value = this.value;
                            // Trigger the input event on the original
                            input.dispatchEvent(new Event('input', { bubbles: true }));
                        });
                        
                        clonedInputs[index].addEventListener('change', function() {
                            if (this.type === 'checkbox') {
                                input.checked = this.checked;
                            } else {
                                input.value = this.value;
                            }
                            input.dispatchEvent(new Event('change', { bubbles: true }));
                        });
                        
                        // Mirror events from original to clone
                        input.addEventListener('input', function() {
                            clonedInputs[index].value = this.value;
                        });
                        
                        input.addEventListener('change', function() {
                            if (this.type === 'checkbox') {
                                clonedInputs[index].checked = this.checked;
                            } else {
                                clonedInputs[index].value = this.value;
                            }
                        });
                    }
                });
            }
            
            // Handle scroll to show/hide sticky header
            function handleStickyHeaderScroll() {
                const thead = originalTable.querySelector('thead');
                const theadRect = thead.getBoundingClientRect();
                const buttonContainer = document.querySelector('.button-container');
                
                if (!buttonContainer || !thead) return;
                
                // Get the actual bottom position of the button container
                const buttonRect = buttonContainer.getBoundingClientRect();
                
                // Show sticky header when the top of the original header meets the bottom of the button container
                // This creates a seamless transition
                if (theadRect.top <= buttonRect.bottom) {
                    if (stickyContainer.style.display !== 'block') {
                        stickyContainer.style.display = 'block';
                        syncColumnWidths(); // Resync widths when showing
                    }
                } else {
                    stickyContainer.style.display = 'none';
                }
            }
            
            // Initialize with a small delay to ensure table is rendered
            setTimeout(function() {
                syncColumnWidths();
                syncInputs();
            }, 100);
            
            // Add scroll listener
            window.addEventListener('scroll', handleStickyHeaderScroll);
            
            // Sync horizontal scroll between original and sticky tables
            const originalContainer = originalTable.parentElement;
            if (originalContainer) {
                originalContainer.addEventListener('scroll', function() {
                    if (stickyContainer.style.display !== 'none') {
                        stickyContainer.scrollLeft = this.scrollLeft;
                    }
                });
                
                stickyContainer.addEventListener('scroll', function() {
                    originalContainer.scrollLeft = this.scrollLeft;
                });
            }
            
            // Resync widths on window resize
            window.addEventListener('resize', function() {
                if (stickyContainer.style.display !== 'none') {
                    syncColumnWidths();
                }
            });
            
            // Also sync when table data changes
            const observer = new MutationObserver(function(mutations) {
                if (stickyContainer.style.display !== 'none') {
                    syncColumnWidths();
                }
            });
            
            // Observe the original table body for changes
            const tbody = originalTable.querySelector('tbody');
            if (tbody) {
                observer.observe(tbody, { childList: true, subtree: true });
            }
        }
        
        // Initialize sticky headers when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeStickyHeaders);
        } else {
            initializeStickyHeaders();
        }
    </script>
</body>
</html>
