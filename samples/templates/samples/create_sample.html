<!DOCTYPE html>
<html>
<head>
    {% load static %}
    <title>Test Lab Samples</title>
    <!-- Include jQuery and other libraries -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.1.0-rc.0/css/select2.min.css" rel="stylesheet" />
    <link rel="icon" href="{% static 'favicon.ico' %}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.1.0-rc.0/js/select2.min.js"></script>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <style>
        body {
            background-color: #FFFFFF; /* Set background to white */
            color: #000000; /* Set text color to black */
            font-family: Arial, sans-serif;
        }

        /* Apply light blue background to the filtering row */
        #samplesTable thead tr:nth-child(2) th {
            background-color: #D6EAF8; /* Light blue background */
        }
        :root {
            --company-color: #002B5C; /* Pantone 289C */
        }
        .form-container {
            border: 2px solid var(--company-color);
            display: flex;
            flex-wrap: wrap;
            align-items: flex-start;
            gap: 20px;
            margin-bottom: 20px;
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 10px;
            background-color: #F9F9F9; /* Light gray background */
            color: #000000; /* Black text */
        }
        label {
            margin-right: 10px;
            font-weight: bold;
        }
        select, input[type="text"] {
            min-width: 200px;
            flex: 1;
            padding: 5px;
            border-radius: 5px;
            border: 1px solid #CCC; /* Light gray border */
            background-color: #EAF3FB; /* Very light blue background */
            color: #000000; /* Black text */
        }
        input[type="text"]:focus,
        select:focus,
        input[type="number"]:focus,
        textarea:focus {
            border-color: var(--company-color);
            outline: none;
            box-shadow: 0 0 5px rgba(0, 43, 92, 0.5); /* Optional shadow effect */
        }

        .selected-row {
            background-color: #b3c7d6; /* Lightened version of the company color */
        }

        .group-row button.expand-button {
            color: var(--company-color);
        }

        .button-container {
            display: flex;
            flex-wrap: nowrap;
            gap: 15px;
            margin-top: 20px;
            justify-content: center;
            width: 100%;
        }
        .button-container button {
            background-color: var(--company-color);
            border: 1px solid var(--company-color);
            min-width: 120px;
            padding: 10px;
            border-radius: 5px;
            color: white;
            font-weight: bold;
            cursor: pointer;
        }
        .button-container button:hover {
            background-color: #001F40; /* Slightly darker shade on hover */
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 2;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            padding-top: 60px;
        }
        .modal-content {
            border: 2px solid var(--company-color);
            background-color: #FFFFFF; /* White background */
            color: #000000; /* Black text */
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 600px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .close {
            color: var(--company-color);
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            align-self: flex-end;
            margin-bottom: 10px;
            cursor: pointer;
        }
        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
        }
        .modal label {
            display: block;
            margin-top: 10px;
            font-weight: bold;
        }
        .modal input {
            width: calc(100% - 22px);
            padding: 10px;
            margin-top: 5px;
            margin-bottom: 20px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        .modal-content button {
            background-color: var(--company-color);
            border: 1px solid var(--company-color);
            width: 130px;
            padding: 10px;
            color: white;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 0 10px;
        }
        .modal-content button:hover {
            background-color: #001F40; /* Slightly darker shade on hover */
        }
        #samplesTable {
            margin-top: 20px;
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
        }
        #samplesTable th, #samplesTable td {
            border: 1px solid #DDD; /* Subtle border */
            padding: 6px;
            text-align: center;
            word-wrap: break-word;
            background-color: #FFFFFF; /* White background */
            color: #000000; /* Black text */
        }
        #samplesTable th {
            background-color: #D6EAF8; /* Light blue background */
            color: #000000; /* Black text */
        }
        .filter-input {
            border: 1px solid #CCC; /* Light gray border */
            padding: 5px;
            background-color: #FFFFFF; /* White input background */
            color: #000000; /* Black text */
        }

        .filter-input:focus {
            border-color: var(--company-color);
            box-shadow: 0 0 5px rgba(0, 43, 92, 0.5);
        }

        .filter-wrapper {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .filter-wrapper input {
            width: 100%;
            min-width: 40px;
            max-width: 100%;
            box-sizing: border-box;
        }
        .selected-row {
            background-color: lightcyan;
        }
        .col-select {
            width: 60px; /* Increased width to prevent wrapping */
            white-space: nowrap; /* Prevent content from wrapping */
        }
        .col-id { width: 40px; text-align: center; }
        .col-date { width: 80px; }
        .col-customer { width: 300px; }
        .col-rsm { width: 120px; }
        .col-opportunity { width: 80px; }
        .col-description { width: auto; }
        .col-location { width: 150px; }
        .col-location select {
            min-width: 135px;
            width: 140px;
        }
        .col-pictures {
            width: 130px;
            vertical-align: middle;
        }
        .button-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            justify-content: center;
            margin-bottom: 20px;
        }
        .button-grid .toggle-button {
            width: 130px;
            padding: 10px;
            height: 34px;
            background-color: white;
            border: 2px solid grey;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
        }
        .button-grid .toggle-button.toggled {
            background-color: grey;
            border-color: grey;
        }
        /* Style for group rows */
        .group-row {
            background-color: #e6e6e6;
            font-weight: bold;
        }

        .group-row button.expand-button {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
        }

        /* Indent the grouped rows for better visual hierarchy */
        .grouped-row td {
            padding-left: 20px;
        }

        /* Adjust the colspan to align the table cells correctly */
        .group-row td[colspan="7"] {
            text-align: left;
        }
        .thumbnail-wrapper {
            position: relative;
            display: inline-block;
        }

        .thumbnail-wrapper img {
            display: block;
        }

        .thumbnail-wrapper .delete-button {
            position: absolute;
            top: 0;
            right: -10px;  /* Shift right by 2 pixels */
            background-color: rgba(255, 0, 0, 0.7);
            color: white;
            border: none;
            border-radius: 50%;
            font-weight: bold;
            width: 20px;
            height: 20px;
            padding: 0;
            text-align: center;
            line-height: 20px; /* Ensure the "x" is vertically centered */
            font-size: 14px;   /* Adjust font-size if necessary */
            cursor: pointer;
        }

        #thumbnailsContainer img {
            width: 100px;
            height: 100px;
            object-fit: cover;
            margin: 5px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <!-- Include CSRF token and excelData for JavaScript -->
    <script type="text/javascript">
        const csrftoken = '{{ csrf_token }}';
        const excelData = {{ excel_data|safe }};
        const samples = {{ samples|safe }};
    </script>

    <form method="POST" id="sampleForm">
        <!-- Include CSRF token in the form -->
        <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
        <div class="form-container">
            <label for="customer">Customer:</label>
            <select id="customer" name="customer" onchange="filterOptions()">
                <option value="">Select a Customer</option>
                {% for customer in unique_customers %}
                <option value="{{ customer }}">{{ customer }}</option>
                {% endfor %}
            </select>

            <label for="rsm">RSM:</label>
            <select id="rsm" name="rsm" onchange="filterOptions()">
                <option value="">Select an RSM</option>
                {% for rsm in unique_rsms %}
                <option value="{{ rsm }}">{{ rsm }}</option>
                {% endfor %}
            </select>

            <label for="opportunity_number">Opportunity #:</label>
            <select id="opportunity_number" name="opportunity_number" class="opportunity-dropdown" onchange="populateFieldsFromOpportunity()">
                <option value="">Select an Opportunity</option>
            </select>

            <label for="description">Description:</label>
            <input type="text" id="description" name="description" readonly>
        </div>

        <div class="button-container">
            <button type="button" onclick="validateAndShowModal()">Add Sample</button>
            <button type="button" onclick="resetFilters()">Reset</button>
            <button type="button" id="print-all-button">Print</button>
            <button type="button" id="delete-all-button">Delete</button>
        </div>
    </form>

    <!-- The Table for displaying samples -->
    <table id="samplesTable" border="1">
        <thead>
            <tr>
                <th class="col-select">Select</th>
                <th class="col-opportunity">Opp Number</th>
                <th class="col-customer">Customer</th>
                <th class="col-rsm">RSM</th>
                <th class="col-date">Date Received</th>
                <th class="col-description">Description</th>
                <th class="col-id">ID</th>
                <th class="col-location">Location</th>
                <th class="col-pictures" rowspan="2">Pictures</th>
            </tr>
            <tr>
                <th class="col-select">
                    <input type="checkbox" id="select-all-select">
                </th>
                <th class="col-opportunity"><div class="filter-wrapper"><input type="text" id="opportunityFilter" placeholder="Filter Opportunity" class="filter-input" onkeyup="filterTable()"></div></th>
                <th class="col-customer"><div class="filter-wrapper"><input type="text" id="customerFilter" placeholder="Filter Customer" class="filter-input" onkeyup="filterTable()"></div></th>
                <th class="col-rsm"><div class="filter-wrapper"><input type="text" id="rsmFilter" placeholder="Filter RSM" class="filter-input" onkeyup="filterTable()"></div></th>
                <th class="col-date"><div class="filter-wrapper"><input type="text" id="dateFilter" placeholder="Filter Date" class="filter-input" onkeyup="filterTable()"></div></th>
                <th class="col-description"><div class="filter-wrapper"><input type="text" id="descriptionFilter" placeholder="Filter Description" class="filter-input" onkeyup="filterTable()"></div></th>
                <th class="col-id"><div class="filter-wrapper"><input type="text" id="idFilter" placeholder="Filter ID" class="filter-input" onkeyup="filterTable()"></div></th>
                <th class="col-location"><div class="filter-wrapper"><input type="text" id="locationFilter" placeholder="Filter Location" class="filter-input" onkeyup="filterTable()"></div></th>
            </tr>
        </thead>
        <tbody>
            <!-- Existing samples will be loaded via JavaScript -->
        </tbody>
    </table>

    <!-- The Modal for Adding Samples -->
    <div id="myModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <label for="date_received">Date Received:</label>
            <input type="text" id="date_received" name="date_received">
            <label for="quantity">Quantity:</label>
            <input type="number" id="quantity" name="quantity" min="1">
            <div style="display: flex; justify-content: space-between;">
                <button type="button" onclick="submitForm()">Submit</button>
                <button type="button" onclick="closeModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- The Upload/View Modal -->
    <div id="uploadModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeUploadModal()">&times;</span>
            <div class="button-container">
                <button type="button" onclick="selectFiles()">Upload</button>
                <button type="button" onclick="closeUploadModal()">Done</button>
            </div>
            <!-- Thumbnails Container -->
            <div id="thumbnailsContainer" style="display: flex; flex-wrap: wrap; margin-top: 20px;"></div>
        </div>
    </div>

    <!-- JavaScript code -->
    <script>
        // Function to sanitize opportunity numbers for use in class names and data attributes
        function sanitizeOppNum(oppNum) {
            return oppNum.replace(/\s+/g, '_').replace(/[^a-zA-Z0-9_-]/g, '');
        }

        // Declare selectAllSelectCheckbox at the global scope
        const selectAllSelectCheckbox = document.getElementById('select-all-select');

        document.addEventListener("DOMContentLoaded", function() {
            // Initialize variables
            const csrftoken = '{{ csrf_token }}';
            const samples = {{ samples|safe }};
            const todayDate = new Date().toISOString().split('T')[0];
            let isPopulating = false; // Flag to prevent recursive triggering
            let currentSampleId = null; // For image uploads

            // Initialize datepicker
            $("#date_received").datepicker({ dateFormat: 'yy-mm-dd' }).val(todayDate);

            // Initialize Select2 for dropdowns with search capability
            $('#customer, #rsm, #opportunity_number').select2({
                width: 'resolve',
                matcher: matchCustom
            });

            // Custom matcher function for multi-keyword search
            function matchCustom(params, data) {
                if ($.trim(params.term) === '') {
                    return data;
                }
                const terms = params.term.toLowerCase().split(' ');
                const original = data.text.toLowerCase();
                const matches = terms.every(term => original.includes(term));

                if (matches) {
                    return data;
                }
                return null;
            }

            // Event listener for the print button
            document.getElementById('print-all-button').addEventListener('click', function() {
                submitPrint();
            });

            // Submit Print function
            window.submitPrint = function() {
                const selectedCheckboxes = document.querySelectorAll('input[name="select_checkbox"]:checked');
                const idsToPrint = Array.from(selectedCheckboxes).map(checkbox => checkbox.value);

                if (idsToPrint.length === 0) {
                    alert('No entries selected for printing.');
                    return;
                }

                const confirmPrint = confirm(`You have selected ${idsToPrint.length} entries to print. Do you want to proceed?`);

                if (confirmPrint) {
                    console.log('Gathering data for selected entries...');

                    fetch("{% url 'handle_print_request' %}", {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrftoken
                        },
                        body: JSON.stringify({'ids': idsToPrint}),
                        credentials: 'same-origin'  // Include cookies in the request
                    })
                    .then(response => {
                        if (!response.ok) {
                            return response.json().then(err => { throw err; });
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.status === 'success') {
                            console.log('Labels to print:', data.labels);

                            data.labels.forEach(label => {
                                console.log(`Label ID: ${label.id}`);
                                console.log(`QR Code: data:image/png;base64,${label.qr_code}`);
                            });

                            // Here you would send this data to your printer
                            // For each affected group, check if any entries remain
                            affectedGroups.forEach(oppNum => {
                                const remainingRows = document.querySelectorAll(`.group-${oppNum}`);
                                if (remainingRows.length === 0) {
                                    // No more entries in the group, remove the group row
                                    const groupRow = document.querySelector(`.group-row[data-opp-num="${sanitizedOppNum}"]`);
                                    if (groupRow) {
                                        groupRow.parentNode.removeChild(groupRow);
                                    }
                                }
                            });
                        } else { 
                            console.error('Error generating labels:', data.error);
                            alert(`Error: ${data.error}`);
                        }
                    })
                    .catch(error => {
                        console.error('Fetch Error:', error);
                        alert('An unexpected error occurred. Please try again.');
                    });
                } else {
                    console.log('Print operation was canceled.');
                }
            };

            // Minimize all groups
            const expandButtons = document.querySelectorAll('.expand-button');
            expandButtons.forEach(button => {
                button.textContent = '+';
                const sanitizedOppNum = button.getAttribute('data-opp-num'); // Already sanitized
                const groupedRows = document.querySelectorAll(`.group-${sanitizedOppNum}`);
                groupedRows.forEach(row => {
                    row.style.display = 'none';
                });
            });

            // Delete selected entries
            document.getElementById('delete-all-button').addEventListener('click', function() {
                const selectedCheckboxes = document.querySelectorAll('input[name="select_checkbox"]:checked');
                const idsToDelete = Array.from(selectedCheckboxes).map(checkbox => checkbox.value);

                if (idsToDelete.length === 0) {
                    alert('No entries selected for deletion.');
                    return;
                }

                if (confirm('Are you sure you want to delete the selected entries?')) {
                    const formData = new FormData();
                    formData.append('csrfmiddlewaretoken', csrftoken);
                    formData.append('ids', JSON.stringify(idsToDelete));

                    fetch("{% url 'delete_samples' %}", {
                        method: 'POST',
                        body: formData,
                        credentials: 'same-origin'  // Include cookies
                    }).then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            selectedCheckboxes.forEach(checkbox => {
                                const row = checkbox.closest('tr');
                                row.parentNode.removeChild(row); // Remove the row from the table
                            });
                            const oppNum = row.querySelector('.col-opportunity').textContent.trim();
                            const sanitizedOppNum = sanitizeOppNum(oppNum); // Sanitize oppNum
                            affectedGroups.add(sanitizedOppNum);
                            selectAllSelectCheckbox.checked = false; // Clear the "Select All" checkbox
                            console.log('Entries deleted successfully.');
                        } else {
                            console.error('Error deleting entries:', data.error);
                        }
                    });
                }
            });

            // Highlight selected rows using event delegation
            document.querySelector('#samplesTable tbody').addEventListener('change', function(event) {
                if (event.target.name === 'select_checkbox') {
                    const row = event.target.closest('tr');
                    if (event.target.checked) {
                        row.classList.add('selected-row');
                    } else {
                        row.classList.remove('selected-row');
                    }
                }
            });

            // Select All functionality with row highlighting
            selectAllSelectCheckbox.addEventListener('change', function() {
                const visibleRows = document.querySelectorAll('#samplesTable tbody tr:not([style*="display: none"])');
                visibleRows.forEach(function(row) {
                    const checkbox = row.querySelector('input[name="select_checkbox"]');
                    if (checkbox) {
                        checkbox.checked = this.checked;
                        if (this.checked) {
                            row.classList.add('selected-row');
                        } else {
                            row.classList.remove('selected-row');
                        }
                    }
                }, this);
            });

            // Update Sample Location function
            window.updateSampleLocation = function(sampleId, location) {
                // Get all selected checkboxes
                const selectedCheckboxes = document.querySelectorAll('input[name="select_checkbox"]:checked');

                // If there are selected checkboxes, update all of them
                if (selectedCheckboxes.length > 0) {
                    const idsToUpdate = Array.from(selectedCheckboxes).map(checkbox => checkbox.value);

                    const formData = new FormData();
                    formData.append('csrfmiddlewaretoken', csrftoken);
                    formData.append('ids', JSON.stringify(idsToUpdate));
                    formData.append('location', location);

                    fetch("{% url 'update_sample_location' %}", {
                        method: 'POST',
                        body: formData,
                        credentials: 'same-origin'  // Include cookies
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            console.log('Sample locations updated successfully for selected samples.');

                            // Update the dropdowns in real-time
                            idsToUpdate.forEach(id => {
                                const dropdown = document.querySelector(`select[data-sample-id="${id}"]`);
                                if (dropdown) {
                                    dropdown.value = location;
                                }
                            });
                        } else {
                            console.error('Error updating sample locations:', data.error);
                        }
                    })
                    .catch(error => {
                        console.error('Fetch error:', error);
                    });
                } else {
                    // If no checkboxes are selected, update only the single sample whose dropdown was changed
                    const formData = new FormData();
                    formData.append('csrfmiddlewaretoken', csrftoken);
                    formData.append('sample_id', sampleId);
                    formData.append('location', location);

                    fetch("{% url 'update_sample_location' %}", {
                        method: 'POST',
                        body: formData,
                        credentials: 'same-origin'  // Include cookies
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            console.log(`Sample location updated successfully for sample ID: ${sampleId}.`);

                            // Update the dropdown in real-time
                            const dropdown = document.querySelector(`select[data-sample-id="${sampleId}"]`);
                            if (dropdown) {
                                dropdown.value = location;
                            }
                        } else {
                            console.error(`Error updating sample location for sample ID: ${sampleId}:`, data.error);
                        }
                    })
                    .catch(error => {
                        console.error('Fetch error:', error);
                    });
                }
            };

            // Submit Form function
            window.submitForm = function() {
                const dateReceived = document.getElementById('date_received').value;
                const quantity = document.getElementById('quantity').value;

                if (quantity === "") {
                    alert("Please enter the quantity.");
                } else {
                    const customer = document.getElementById('customer').value;
                    const rsm = document.getElementById('rsm').value;
                    const opportunityNumber = document.getElementById('opportunity_number').value;
                    const description = document.getElementById('description').value;
                    const location = "Choose a location"; // Default location

                    const formData = new FormData();
                    formData.append('csrfmiddlewaretoken', csrftoken);
                    formData.append('date_received', dateReceived);
                    formData.append('customer', customer);
                    formData.append('rsm', rsm);
                    formData.append('opportunity_number', opportunityNumber);
                    formData.append('description', description);
                    formData.append('location', location);
                    formData.append('quantity', quantity);

                    fetch("{% url 'create_sample' %}", {
                        method: 'POST',
                        body: formData,
                        credentials: 'same-origin'  // Include cookies
                    }).then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            data.created_samples.forEach(sample => {
                                const newRow = document.createElement('tr');
                                newRow.innerHTML = `
                                    <td class="col-select">
                                        <input type="checkbox" name="select_checkbox" value="${sample.unique_id}">
                                    </td>
                                    <td class="col-opportunity">${sample.opportunity_number}</td>
                                    <td class="col-customer">${sample.customer}</td>
                                    <td class="col-rsm">${sample.rsm}</td>
                                    <td class="col-date">${sample.date_received}</td>
                                    <td class="col-description">${sample.description}</td>
                                    <td class="col-id">${sample.unique_id}</td>
                                    <td class="col-location">
                                        <select data-sample-id="${sample.unique_id}" onchange="updateSampleLocation('${sample.unique_id}', this.value)">
                                            <option value="Choose a location" ${sample.location === "Choose a location" ? "selected" : ""}>Choose a location</option>
                                            <option value="Test Lab Fridge">Test Lab Fridge</option>
                                            <option value="Test Lab Freezer">Test Lab Freezer</option>
                                            <option value="Walk-in Fridge">Walk-in Fridge</option>
                                            <option value="Walk-in Freezer">Walk-in Freezer</option>
                                            <option value="Dry Food Storage">Dry Food Storage</option>
                                            <option value="Empty Case Storage">Empty Case Storage</option>
                                        </select>
                                    </td>
                                    <td class="col-pictures">
                                        <button type="button" onclick="handlePictureUploadView('${sample.unique_id}')">Upload/View</button>
                                    </td>
                                `;
                                document.querySelector('#samplesTable tbody').appendChild(newRow);
                            });
                            console.log('Sample saved successfully.');
                        } else {
                            console.error('Error saving sample:', data.error);
                        }
                    });

                    closeModal();
                    resetForm();
                }
            };

            // Filter Options function
            window.filterOptions = function() {
                if (isPopulating) return;
                const customer = document.getElementById('customer').value;
                const rsm = document.getElementById('rsm').value;

                const filteredData = excelData.filter(record =>
                    (customer === "" || record['Customer'] === customer) &&
                    (rsm === "" || record['RSM'] === rsm)
                );

                updateSelectOptions(document.getElementById('customer'), 'Customer', filteredData, customer);
                updateSelectOptions(document.getElementById('rsm'), 'RSM', filteredData, rsm);
                updateSelectOptions(document.getElementById('opportunity_number'), 'Opportunity #', filteredData);
            };

            // Populate Fields from Opportunity function
            window.populateFieldsFromOpportunity = function() {
                const opportunityNumber = document.getElementById('opportunity_number').value;
                const selectedData = excelData.find(record => record['Opportunity #'] === parseInt(opportunityNumber));

                if (selectedData) {
                    isPopulating = true; // Set flag to true
                    $('#customer').val(selectedData['Customer']).trigger('change.select2');
                    $('#rsm').val(selectedData['RSM']).trigger('change.select2');
                    document.getElementById('description').value = selectedData['Description'];
                    isPopulating = false; // Reset flag to false
                } else {
                    document.getElementById('description').value = '';
                }
            };

            // Validate and Show Modal function
            window.validateAndShowModal = function() {
                const customer = document.getElementById('customer').value;
                const rsm = document.getElementById('rsm').value;
                const opportunityNumber = document.getElementById('opportunity_number').value;

                if (customer === "" || rsm === "" || opportunityNumber === "") {
                    alert("Please complete all selections before adding a sample.");
                } else {
                    document.getElementById('myModal').style.display = "block";
                }
            };

            // Close Modal function
            window.closeModal = function() {
                document.getElementById('myModal').style.display = "none";
            };

            // Reset Filters function
            window.resetFilters = function() {
                // Reset dropdown filters
                document.getElementById('customer').value = "";
                document.getElementById('rsm').value = "";
                document.getElementById('opportunity_number').value = "";
                document.getElementById('description').value = "";

                // Update dropdown options to default
                updateSelectOptions(document.getElementById('customer'), 'Customer', excelData);
                updateSelectOptions(document.getElementById('rsm'), 'RSM', excelData);
                updateSelectOptions(document.getElementById('opportunity_number'), 'Opportunity #', excelData);

                // Reset Select2 elements
                $('#customer, #rsm, #opportunity_number').val(null).trigger('change.select2');

                // Clear text filters in the table
                document.getElementById('idFilter').value = "";
                document.getElementById('dateFilter').value = "";
                document.getElementById('customerFilter').value = "";
                document.getElementById('rsmFilter').value = "";
                document.getElementById('opportunityFilter').value = "";
                document.getElementById('descriptionFilter').value = "";
                document.getElementById('locationFilter').value = "";

                // Uncheck all checkboxes in the table and remove highlighting
                const checkboxes = document.querySelectorAll('input[name="select_checkbox"]');
                checkboxes.forEach(checkbox => {
                    checkbox.checked = false;
                    const row = checkbox.closest('tr');
                    row.classList.remove('selected-row');
                });

                // Clear the "Select All" checkbox
                const selectAllCheckbox = document.getElementById('select-all-select');
                if (selectAllCheckbox) {
                    selectAllCheckbox.checked = false;
                }

                // Reapply filters to clear the table
                filterTable();
            };

            // Update Select Options function
            function updateSelectOptions(selectElement, key, filteredData, currentValue = "") {
                const uniqueValues = [...new Set(filteredData.map(record => record[key]))];
                uniqueValues.sort((a, b) => {
                    if (key === 'Opportunity #') {
                        return a - b;
                    }
                    return a.localeCompare(b);
                });

                selectElement.innerHTML = '<option value="">Select an option</option>';
                uniqueValues.forEach(value => {
                    if (value) {
                        const option = document.createElement('option');
                        option.value = value;
                        option.textContent = value;
                        if (value === currentValue) {
                            option.selected = true;
                        }
                        selectElement.appendChild(option);
                    }
                });

                // Reinitialize Select2 after updating options
                $(selectElement).select2({
                    width: 'resolve',
                    matcher: matchCustom
                });
            }

            // Filter Table function
            window.filterTable = function() {
                const groupsToShow = new Set();
                const idFilter = document.getElementById('idFilter').value.toLowerCase();
                const dateFilter = document.getElementById('dateFilter').value.toLowerCase();
                const customerFilter = document.getElementById('customerFilter').value.toLowerCase();
                const rsmFilter = document.getElementById('rsmFilter').value.toLowerCase();
                const opportunityFilter = document.getElementById('opportunityFilter').value.toLowerCase();
                const descriptionFilter = document.getElementById('descriptionFilter').value.toLowerCase();
                const locationFilter = document.getElementById('locationFilter').value.toLowerCase();

                const table = document.getElementById('samplesTable');
                const tr = table.getElementsByTagName('tr');

                for (let i = 2; i < tr.length; i++) { // Start from 2 to skip header rows
                    const row = tr[i];

                    // Check if the row is a group row
                    if (row.classList.contains('group-row')) {
                        const oppNum = row.querySelector('.col-opportunity').textContent;
                        const sanitizedOppNum = sanitizeOppNum(oppNum);
                        const expandButton = row.querySelector('.expand-button');
                        const isExpanded = expandButton.textContent === '-';

                        // Decide whether to display the group row based on if any of its children match the filter
                        const groupedRows = document.querySelectorAll(`.group-${sanitizedOppNum}`);
                        let groupHasMatch = false;

                        groupedRows.forEach(childRow => {
                            const tdOpportunity = childRow.getElementsByTagName('td')[1];
                            const tdCustomer = childRow.getElementsByTagName('td')[2];
                            const tdRsm = childRow.getElementsByTagName('td')[3];
                            const tdDate = childRow.getElementsByTagName('td')[4];
                            const tdDescription = childRow.getElementsByTagName('td')[5];
                            const tdId = childRow.getElementsByTagName('td')[6];
                            const tdLocation = childRow.getElementsByTagName('td')[7];

                            if (tdId && tdDate && tdCustomer && tdRsm && tdOpportunity && tdDescription && tdLocation) {
                                const idValue = tdId.textContent || tdId.innerText;
                                const dateValue = tdDate.textContent || tdDate.innerText;
                                const customerValue = tdCustomer.textContent || tdCustomer.innerText;
                                const rsmValue = tdRsm.textContent || tdRsm.innerText;
                                const opportunityValue = tdOpportunity.textContent || tdOpportunity.innerText;
                                const descriptionValue = tdDescription.textContent || tdDescription.innerText;
                                const locationValue = tdLocation.textContent || tdLocation.innerText;

                                if (
                                    idValue.toLowerCase().indexOf(idFilter) > -1 &&
                                    dateValue.toLowerCase().indexOf(dateFilter) > -1 &&
                                    customerValue.toLowerCase().indexOf(customerFilter) > -1 &&
                                    rsmValue.toLowerCase().indexOf(rsmFilter) > -1 &&
                                    opportunityValue.toLowerCase().indexOf(opportunityFilter) > -1 &&
                                    descriptionValue.toLowerCase().indexOf(descriptionFilter) > -1 &&
                                    locationValue.toLowerCase().indexOf(locationFilter) > -1
                                ) {
                                    groupHasMatch = true;
                                    childRow.style.display = ''; // Show matching child rows
                                } else {
                                    childRow.style.display = 'none';
                                }
                            }
                        });

                        if (groupHasMatch) {
                            row.style.display = '';
                            const expandButton = row.querySelector('.expand-button');
                            expandButton.textContent = '-'; // Automatically expand the group
                        } else {
                            row.style.display = 'none';
                            groupedRows.forEach(childRow => {
                                childRow.style.display = 'none'; // Hide all child rows
                            });
                        }

                        continue; // Move to the next row
                    }

                    // Process rows that are not part of a group (if any)
                    if (!row.classList.contains('grouped-row')) {
                        const tdOpportunity = row.getElementsByTagName('td')[1];
                        const tdCustomer = row.getElementsByTagName('td')[2];
                        const tdRsm = row.getElementsByTagName('td')[3];
                        const tdDate = row.getElementsByTagName('td')[4];
                        const tdDescription = row.getElementsByTagName('td')[5];
                        const tdId = row.getElementsByTagName('td')[6];
                        const tdLocation = row.getElementsByTagName('td')[7];

                        if (tdId && tdDate && tdCustomer && tdRsm && tdOpportunity && tdDescription && tdLocation) {
                            const idValue = tdId.textContent || tdId.innerText;
                            const dateValue = tdDate.textContent || tdDate.innerText;
                            const customerValue = tdCustomer.textContent || tdCustomer.innerText;
                            const rsmValue = tdRsm.textContent || tdRsm.innerText;
                            const opportunityValue = tdOpportunity.textContent || tdOpportunity.innerText;
                            const descriptionValue = tdDescription.textContent || tdDescription.innerText;
                            const locationValue = tdLocation.textContent || tdLocation.innerText;

                            if (
                                idValue.toLowerCase().indexOf(idFilter) > -1 &&
                                dateValue.toLowerCase().indexOf(dateFilter) > -1 &&
                                customerValue.toLowerCase().indexOf(customerFilter) > -1 &&
                                rsmValue.toLowerCase().indexOf(rsmFilter) > -1 &&
                                opportunityValue.toLowerCase().indexOf(opportunityFilter) > -1 &&
                                descriptionValue.toLowerCase().indexOf(descriptionFilter) > -1 &&
                                locationValue.toLowerCase().indexOf(locationFilter) > -1
                            ) {
                                row.style.display = '';
                            } else {
                                row.style.display = 'none';
                            }
                        }
                    }
                }
            };

            // Reset Form function
            window.resetForm = function() {
                document.getElementById('sampleForm').reset(); // Resets all form fields
                // If you're using Select2, reset it as well
                $('#customer, #rsm, #opportunity_number').val(null).trigger('change.select2');
                document.getElementById('description').value = ''; // Clear the description field
            };

            // Initialize dropdowns with all options
            updateSelectOptions(document.getElementById('customer'), 'Customer', excelData);
            updateSelectOptions(document.getElementById('rsm'), 'RSM', excelData);
            updateSelectOptions(document.getElementById('opportunity_number'), 'Opportunity #', excelData);

            // Load existing samples into the table
            // Group samples by 'opportunity_number'
            const groupedSamples = {};
            samples.forEach(sample => {
                const oppNum = sample.opportunity_number;
                if (!groupedSamples[oppNum]) {
                    groupedSamples[oppNum] = [];
                }
                groupedSamples[oppNum].push(sample);
            });

            // Clear the existing table body
            const tableBody = document.querySelector('#samplesTable tbody');
            tableBody.innerHTML = '';

            // Iterate over each group
            Object.keys(groupedSamples).forEach(oppNum => {
                const group = groupedSamples[oppNum];

                // Define new variables to hold the customer and RSM values from the group
                const groupCustomer = group[0].customer;
                const groupRsm = group[0].rsm;

                if (group.length === 1) {
                    // If only one entry, display it as usual
                    const sample = group[0];
                    const newRow = document.createElement('tr'); // Add this line
                    newRow.innerHTML = `
                        <td class="col-select">
                            <input type="checkbox" name="select_checkbox" value="${sample.unique_id}">
                        </td>
                        <td class="col-opportunity">${sample.opportunity_number}</td>
                        <td class="col-customer">${sample.customer}</td>
                        <td class="col-rsm">${sample.rsm}</td>
                        <td class="col-date">${sample.date_received}</td>
                        <td class="col-description">${sample.description}</td>
                        <td class="col-id">${sample.unique_id}</td>
                        <td class="col-location">
                            <select data-sample-id="${sample.unique_id}" onchange="updateSampleLocation(${sample.unique_id}, this.value)">
                                <option value="" ${!sample.storage_location ? "selected" : ""}>Choose a location</option>
                                <option value="Test Lab Fridge" ${sample.storage_location === "Test Lab Fridge" ? "selected" : ""}>Test Lab Fridge</option>
                                <option value="Test Lab Freezer" ${sample.storage_location === "Test Lab Freezer" ? "selected" : ""}>Test Lab Freezer</option>
                                <option value="Walk-in Fridge" ${sample.storage_location === "Walk-in Fridge" ? "selected" : ""}>Walk-in Fridge</option>
                                <option value="Walk-in Freezer" ${sample.storage_location === "Walk-in Freezer" ? "selected" : ""}>Walk-in Freezer</option>
                                <option value="Dry Food Storage" ${sample.storage_location === "Dry Food Storage" ? "selected" : ""}>Dry Food Storage</option>
                                <option value="Empty Case Storage" ${sample.storage_location === "Empty Case Storage" ? "selected" : ""}>Empty Case Storage</option>
                            </select>
                        </td>
                        <td class="col-pictures">
                            <button type="button" onclick="handlePictureUploadView(${sample.unique_id})">Upload/View</button>
                        </td>
                    `;
                    tableBody.appendChild(newRow);
                } else {
                    // Create a group row without a select box and with a '+' button
                    const sanitizedOppNum = sanitizeOppNum(oppNum); // Sanitize oppNum
                    const groupRow = document.createElement('tr');
                    groupRow.classList.add('group-row');
                    groupRow.setAttribute('data-opp-num', sanitizedOppNum); // Use sanitizedOppNum
                    groupRow.innerHTML = `
                        <td class="col-select">
                            <button type="button" class="expand-button" data-opp-num="${sanitizedOppNum}">+</button>
                        </td>
                        <td class="col-opportunity">${oppNum}</td>
                        <td class="col-customer">${groupCustomer}</td>
                        <td class="col-rsm">${groupRsm}</td>
                        <td colspan="5"> <!-- Adjust colspan to span remaining columns -->
                            (${group.length} entries)
                        </td>
                    `;
                    tableBody.appendChild(groupRow);

                    // Add rows for each sample in the group, initially hidden
                    group.forEach(sample => {
                        const sampleRow = document.createElement('tr');
                        sampleRow.classList.add('grouped-row', `group-${sanitizedOppNum}`); // Use sanitizedOppNum
                        sampleRow.style.display = 'none'; // Initially hidden
                        sampleRow.innerHTML = `
                            <td class="col-select">
                                <input type="checkbox" name="select_checkbox" value="${sample.unique_id}">
                            </td>
                            <td class="col-opportunity">${sample.opportunity_number}</td>
                            <td class="col-customer">${sample.customer}</td>
                            <td class="col-rsm">${sample.rsm}</td>
                            <td class="col-date">${sample.date_received}</td>
                            <td class="col-description">${sample.description}</td>
                            <td class="col-id">${sample.unique_id}</td>
                            <td class="col-location">
                                <select data-sample-id="${sample.unique_id}" onchange="updateSampleLocation(${sample.unique_id}, this.value)">
                                    <option value="" ${!sample.storage_location ? "selected" : ""}>Choose a location</option>
                                    <option value="Test Lab Fridge" ${sample.storage_location === "Test Lab Fridge" ? "selected" : ""}>Test Lab Fridge</option>
                                    <option value="Test Lab Freezer" ${sample.storage_location === "Test Lab Freezer" ? "selected" : ""}>Test Lab Freezer</option>
                                    <option value="Walk-in Fridge" ${sample.storage_location === "Walk-in Fridge" ? "selected" : ""}>Walk-in Fridge</option>
                                    <option value="Walk-in Freezer" ${sample.storage_location === "Walk-in Freezer" ? "selected" : ""}>Walk-in Freezer</option>
                                    <option value="Dry Food Storage" ${sample.storage_location === "Dry Food Storage" ? "selected" : ""}>Dry Food Storage</option>
                                    <option value="Empty Case Storage" ${sample.storage_location === "Empty Case Storage" ? "selected" : ""}>Empty Case Storage</option>
                                </select>
                            </td>
                            <td class="col-pictures">
                                <button type="button" onclick="handlePictureUploadView(${sample.unique_id})">Upload/View</button>
                            </td>
                        `;
                        tableBody.appendChild(sampleRow);
                    });
                }
            });
        });

        // Event delegation to handle clicks on expand/collapse buttons
        document.addEventListener('click', function(event) {
            if (event.target.classList.contains('expand-button')) {
                const button = event.target;
                const sanitizedOppNum = button.getAttribute('data-opp-num');
                const isExpanded = button.textContent === '-';

                // Toggle the button text
                button.textContent = isExpanded ? '+' : '-';

                // Show or hide the grouped rows
                const groupedRows = document.querySelectorAll(`.group-${sanitizedOppNum}`);
                groupedRows.forEach(row => {
                    row.style.display = isExpanded ? 'none' : '';
                });
            }
            // Adjust the 'Select All' functionality to exclude group rows
            selectAllSelectCheckbox.addEventListener('change', function() {
                const visibleSampleRows = document.querySelectorAll('#samplesTable tbody tr:not([style*="display: none"]):not(.group-row)');
                visibleSampleRows.forEach(function(row) {
                    const checkbox = row.querySelector('input[name="select_checkbox"]');
                    if (checkbox) {
                        checkbox.checked = this.checked;
                        if (this.checked) {
                            row.classList.add('selected-row');
                        } else {
                            row.classList.remove('selected-row');
                        }
                    }
                }, this);
            });

            // Image Upload and Thumbnails Display Functions
        });

        function handlePictureUploadView(sampleId) {
            currentSampleId = sampleId;
            // Open the modal
            document.getElementById('uploadModal').style.display = 'block';

            // Clear previous thumbnails
            document.getElementById('thumbnailsContainer').innerHTML = '';

            // Fetch existing images for this sample and display thumbnails
            fetch("{% url 'get_sample_images' %}?sample_id=" + sampleId)
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    displayThumbnails(data.images);
                } else {
                    console.error('Error fetching images:', data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }

        function selectFiles() {
            // Create a hidden file input element
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.multiple = true;
            fileInput.accept = 'image/*';
            fileInput.style.display = 'none';

            // Append the file input to the body
            document.body.appendChild(fileInput);

            // Trigger the file input click event to open the file dialog
            fileInput.click();

            // Handle file selection
            fileInput.addEventListener('change', function() {
                const files = fileInput.files;
                if (files.length > 0) {
                    uploadFiles(files, currentSampleId);
                }
                // Remove the file input after use
                document.body.removeChild(fileInput);
            });
        }

        function uploadFiles(files, sampleId) {
            const formData = new FormData();
            for (let i = 0; i < files.length; i++) {
                formData.append('files', files[i]);
            }
            formData.append('sample_id', sampleId);

            fetch("{% url 'upload_files' %}", {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': csrftoken
                },
                credentials: 'same-origin'  // Include cookies in the request
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => { throw err; });
                }
                return response.json();
            })
            .then(data => {
                if (data.status === 'success') {
                    // The files were uploaded successfully; no alert needed.
                    handlePictureUploadView(sampleId);
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                if (error.error) {
                    alert('Error: ' + error.error);
                } else {
                    alert('An unexpected error occurred.');
                }
            });
        }

        function displayThumbnails(imageDataArray) {
            const thumbnailsContainer = document.getElementById('thumbnailsContainer');
            // Clear existing thumbnails
            thumbnailsContainer.innerHTML = '';
            imageDataArray.forEach(imageData => {
                const wrapper = document.createElement('div');
                wrapper.classList.add('thumbnail-wrapper');

                const img = document.createElement('img');
                img.src = imageData.url;

                const deleteButton = document.createElement('button');
                deleteButton.classList.add('delete-button');
                deleteButton.textContent = '×';

                // Add event listener to delete button
                deleteButton.addEventListener('click', function() {
                    deleteImage(imageData.id, wrapper);
                });

                wrapper.appendChild(img);
                wrapper.appendChild(deleteButton);
                thumbnailsContainer.appendChild(wrapper);
            });
        }

        function deleteImage(imageId, thumbnailElement) {
            const formData = new FormData();
            formData.append('image_id', imageId);

            fetch("{% url 'delete_sample_image' %}", {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': csrftoken
                },
                credentials: 'same-origin'
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // Remove the thumbnail element from the DOM
                    thumbnailElement.parentNode.removeChild(thumbnailElement);
                } else {
                    alert('Error deleting image: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An unexpected error occurred while deleting the image.');
            });
        }

        function closeUploadModal() {
            document.getElementById('uploadModal').style.display = 'none';
            currentSampleId = null;
        }
    </script>
</body>
</html>
