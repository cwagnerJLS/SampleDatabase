<!DOCTYPE html>
<html>
<head>
    {% load static %}
    <title>Test Lab Samples</title>
    <!-- Include jQuery and other libraries -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.1.0-rc.0/css/select2.min.css" rel="stylesheet" />
    <link rel="icon" href="{% static 'favicon.ico' %}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.1.0-rc.0/js/select2.min.js"></script>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <style>
        body {
            background-color: #FFFFFF; /* Set background to white */
            color: #000000; /* Set text color to black */
            font-family: Arial, sans-serif;
            width: 100%;
            margin-left: 0;
            margin-right: 0;
            margin: 0;   /* Remove default margin */
            padding: 0;  /* Remove default padding */
            background-color: #FFFFFF; /* Set background to white */
            color: #000000; /* Set text color to black */
            font-family: Arial, sans-serif;
            width: 100%;
        }

        /* Adjust margin for the Download and Upload buttons in the Documentation column */
        .doc-buttons .download-button,
        .doc-buttons .upload-button {
            margin: 0; /* Removes all margins */
        }

        .doc-buttons {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* Optional hover effects */
        .doc-buttons .download-button:hover,
        .doc-buttons .upload-button:hover {
            background-color: #001F40; /* Slightly darker shade on hover */
        }

        /* Style the container to arrange child elements horizontally */
        .doc-buttons {
            display: flex;
            justify-content: center; /* Center the buttons horizontally */
            align-items: center;     /* Center the buttons vertically */
            gap: 2px;                /* Reduced gap */
            width: 100%;             /* Ensure the container uses full column width */
        }

        /* Optional: Ensure buttons have consistent styling */

        /* Navigation Buttons */
        .modal-body .prev-button,
        .modal-body .next-button {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            font-size: 24px;
            font-weight: bold;
            padding: 0;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            user-select: none;
            z-index: 2;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0;
        }

        .modal-body .prev-button {
            left: 10px;
        }

        .modal-body .next-button {
            right: 10px;
        }

        .modal-body img {
            max-width: 100%;
            max-height: 80vh;
            display: block;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }

        /* Ensure that navigation buttons appear over the image */
        .modal-body {
            position: relative;
            overflow: hidden;
        }

        /* Adjust modal content to accommodate arrows */
        #fullSizeModal .modal-content {
            position: relative;
        }

        /* Limit the modal content height */
        #fullSizeModal .modal-dialog {
            max-height: 90vh;
            margin: auto;
            display: flex;
            align-items: center;
        }

        #fullSizeModal .modal-content {
            display: flex;
            flex-direction: column;
            width: auto;                  /* Adjust width based on content */
            height: auto;                 /* Adjust height based on content */
            max-width: 90vw;              /* Constrain to 90% of viewport width */
            max-height: 90vh;             /* Constrain to 90% of viewport height */
            overflow: hidden;             /* Prevent content overflow */
        }

        /* Ensure the modal header displays the filename properly */
        #fullSizeModal .modal-header h2 {
            margin: 0;
            font-size: 18px;
            max-width: 80%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* Modal Overlay */
        #fullSizeModal {
            display: flex;
            align-items: center;         /* Center vertically */
            justify-content: center;     /* Center horizontally */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: auto;              /* Allow scrolling if content exceeds viewport */
            z-index: 9999;
            background-color: rgba(0, 0, 0, 0.5);
        }

        /* Modal Dialog */
        #fullSizeModal .modal-dialog {
            max-width: 90vw;
            max-height: 90vh;
            margin: auto;
            display: flex;
            flex-direction: column;
            height: auto;        /* Allow height to adjust automatically */
        }

        /* Modal Content */
        #fullSizeModal .modal-content {
            display: flex;
            flex-direction: column;
            width: auto;                  /* Adjust width based on content */
            height: auto;                 /* Adjust height based on content */
            max-width: 90vw;              /* Constrain to 90% of viewport width */
            max-height: 90vh;             /* Constrain to 90% of viewport height */
            overflow: hidden;             /* Prevent content overflow */
        }

        /* Modal Header */
        #fullSizeModal .modal-header {
            flex-shrink: 0;
            padding: 10px;
            background-color: var(--company-color);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Modal Body */
        #fullSizeModal .modal-body {
            flex: none;                   /* Prevent flex resizing */
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;                  /* Prevent scrolling inside modal body */
            padding: 0;
            max-height: 100%;                  /* Ensure the body doesn't exceed parent height */
        }

        /* Image Styling */
        #fullSizeModal .modal-body img {
            width: auto;
            height: auto;
            max-width: 90vw;              /* Constrain image width */
            max-height: 90vh;             /* Constrain image height */
        }

        @media (max-width: 600px) {
            .form-container {
                padding: 10px;
            }

            .input-group {
                min-width: 100%;    /* Make input groups take full width on small screens */
            }
        }
        /* Lower the quantity field slightly */
        .add-sample-modal .modal-form-group.quantity-group {
            margin-top: 10px; /* Adjust this value to move the field further down or up */
        }
        .selected-row {
            background-color: #baf7ba; /* Light green color */
        }

        /* Apply light blue background to the filtering row */
        #samplesTable thead tr:nth-child(2) th {
            background-color: #EAF2F8; /* Lighter blue background */
        }
        :root {
            --company-color: #002B5C; /* Pantone 289C */
        }
        .form-container {
            display: flex;
            flex-wrap: wrap;       /* Ensure items wrap to the next line if they don't fit */
            justify-content: center; /* Center the content horizontally */
            gap: 20px;
            margin: 0 auto 20px auto; /* Center the container and set bottom margin */
            padding: 20px;
            max-width: none;      /* Allows the form to expand fully */
            margin: 0 20px;       /* Adds 20px margin on left and right */
            border: 2px solid var(--company-color);
            border-radius: 10px;
            background-color: #EAF2F8;
            color: #000000;
        }

        .input-group {
            flex: 1 1 200px;       /* Grow and shrink with a basis of 200px */
            min-width: 200px;      /* Ensure a minimum width */
            display: flex;
            flex-direction: column;
        }

        .input-group label {
            margin-bottom: 5px;
            font-weight: bold;
        }

        .input-group select,
        .input-group input[type="text"] {
            width: 100%;           /* Make the inputs take the full width of the container */
            padding: 5px;
            border-radius: 5px;
            border: 1px solid #CCC;
            background-color: #FFFFFF;
            color: #000000;
            box-sizing: border-box; /* Include padding and border in the element's total width */
        }

        /* Modal-specific label styles */
        .add-sample-modal label {
            margin-right: 0; /* Override margin-right */
            margin-bottom: 5px;
            font-size: 14px;
        }
        select, input[type="text"] {
            min-width: 200px;
            flex: 1;
            padding: 5px;
            border-radius: 5px;
            border: 1px solid #CCC; /* Light gray border */
            background-color: #FFFFFF; /* White background */
            color: #000000; /* Black text */
        }
        input[type="text"]:focus,
        select:focus,
        input[type="number"]:focus,
        textarea:focus {
            border-color: var(--company-color);
            outline: none;
            box-shadow: 0 0 5px rgba(0, 43, 92, 0.5); /* Optional shadow effect */
        }

        .group-row button.expand-button {
            color: var(--company-color);
        }

        .button-container {
            display: flex;
            flex-wrap: wrap;          /* Allow buttons to wrap to the next line if necessary */
            gap: 15px;
            margin-top: 20px;
            justify-content: center;  /* Center the buttons horizontally */
            width: 100%;
        }

        .button-container button {
            flex: 1 1 120px;          /* Make buttons flexible with a minimum width */
            max-width: 200px;         /* Optional: set a maximum width */
            background-color: var(--company-color);
            border: 1px solid var(--company-color);
            padding: 10px;
            border-radius: 5px;
            color: white;
            font-weight: bold;
            cursor: pointer;
        }
        .button-container button:hover {
            background-color: #001F40; /* Slightly darker shade on hover */
        }
        /* Modal Overlay */
        .modal {
            display: none;
            position: fixed;
            z-index: 10;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5); /* Darker overlay for better focus */
        }

        /* Modal Dialog */
        /* Styles for Add Sample Modal */
        .add-sample-modal .modal-dialog {
            position: relative;
            margin: 5% auto;
            max-width: 400px;
            width: 80%;
        }

        /* Styles for Upload/View Modal */
        body .upload-modal .modal-dialog {
            position: relative;
            margin: 5% auto;
            width: auto;           /* Allow the width to adjust automatically */
            min-width: 600px;      /* Set the desired minimum width */
            max-width: 90%;        /* Set the maximum width (90% of viewport) */
        }

        /* Modal Content */
        .modal-content {
            display: block;     /* Ensure it behaves like a block element */
            width: 100%;        /* Make it fill the parent container's width */
            background-color: #fff;
            border-radius: 8px;
            overflow: hidden;
            animation: fadeIn 0.3s ease;
        }

        /* Modal Header */
        .modal-header {
            padding: 10px;
            background-color: var(--company-color);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 20px;
        }

        /* Close Button */
        .modal-header .close {
            color: white;
            font-size: 22px;
            font-weight: bold;
            cursor: pointer;
        }

        /* Modal Body */
        .modal-body {
            padding: 15px;
            background-color: #f8f9fa;
        }

        /* Thumbnails Container */
        #thumbnailsContainer {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center; /* Center the thumbnails horizontally */
        }

        #thumbnailsContainer .thumbnail-wrapper {
            position: relative;
            width: 120px;
            height: 120px;
            border-radius: 5px;
            overflow: hidden;
            background-color: #fff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        #thumbnailsContainer img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Delete Button on Thumbnails */
        .thumbnail-wrapper .delete-button {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: rgba(220, 53, 69, 0.9); /* Bootstrap danger color */
            color: white;
            border: none;
            border-radius: 50%;
            font-weight: bold;
            width: 25px;
            height: 25px;
            padding: 0;
            text-align: center;
            line-height: 25px;
            font-size: 16px;
            cursor: pointer;
        }

        /* Modal Footer */
        .modal-footer {
            padding: 10px 15px;
            background-color: #f8f9fa;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        /* Footer Buttons */
        .modal-footer button {
            background-color: var(--company-color);
            border: none;
            padding: 8px 16px;
            color: white;
            border-radius: 5px;
            font-size: 14px;
            cursor: pointer;
        }

        .modal-footer button:hover {
            background-color: #001F40; /* Slightly darker shade */
        }

        /* Fade-in Animation */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        #samplesTable {
            margin-top: 20px;
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
        }
        #samplesTable th, #samplesTable td {
            border: 1px solid #DDD; /* Subtle border */
            padding: 6px;
            text-align: center;
            word-wrap: break-word;
            background-color: #FFFFFF; /* White background */
            color: #000000; /* Black text */
        }
        #samplesTable th {
            background-color: #EAF2F8; /* Lighter blue background */
            color: #000000; /* Black text */
        }
        .filter-input {
            border: 1px solid #CCC; /* Light gray border */
            padding: 5px;
            background-color: #FFFFFF; /* White input background */
            color: #000000; /* Black text */
        }

        .filter-input:focus {
            border-color: var(--company-color);
            box-shadow: 0 0 5px rgba(0, 43, 92, 0.5);
        }

        .filter-wrapper {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .filter-wrapper input {
            width: 100%;
            min-width: 40px;
            max-width: 100%;
            box-sizing: border-box;
        }
        .col-select {
            width: 60px; /* Increased width to prevent wrapping */
            white-space: nowrap; /* Prevent content from wrapping */
        }
        .col-id { width: 40px; text-align: center; }
        .col-date {
            width: 120px;       /* Increase the width to accommodate the date */
            white-space: nowrap; /* Prevent the date from wrapping to the next line */
        }
        .col-customer { width: 300px; }
        .col-rsm { width: 120px; }
        .col-opportunity { width: 80px; }
        .col-description { width: auto; }
        .col-location { width: 150px; }
        .col-location select {
            min-width: 135px;
            width: 140px;
            background-color: #FFFFFF; /* White background */
            color: #000000; /* Black text */
        }
        .col-pictures {
            width: 100px; /* Decreased width */
            vertical-align: middle;
        }
        .col-documentation {
            width: 130px; /* Adjust if necessary */
            vertical-align: middle;
            text-align: center; /* Center content horizontally */
        }
        .button-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            justify-content: center;
            margin-bottom: 20px;
        }
        .button-grid .toggle-button {
            width: 130px;
            padding: 10px;
            height: 34px;
            background-color: white;
            border: 2px solid grey;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
        }
        .button-grid .toggle-button.toggled {
            background-color: grey;
            border-color: grey;
        }
        /* Style for group rows */
        .group-row {
            background-color: #e6e6e6;
            font-weight: bold;
        }

        .group-row button.expand-button {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
        }

        /* Indent the grouped rows for better visual hierarchy */
        .grouped-row td {
            padding-left: 20px;
        }

        /* Adjust the colspan to align the table cells correctly */
        .group-row td[colspan="7"] {
            text-align: left;
        }
        .thumbnail-wrapper {
            position: relative;
            display: inline-block;
        }

        .thumbnail-wrapper img {
            display: block;
        }

        .thumbnail-wrapper .delete-button {
            position: absolute;
            top: 0;
            right: 0px;  /* Shift right by 2 pixels */
            background-color: rgba(255, 0, 0, 0.7);
            color: white;
            border: none;
            border-radius: 50%;
            font-weight: bold;
            width: 20px;
            height: 20px;
            padding: 0;
            text-align: center;
            line-height: 20px; /* Ensure the "x" is vertically centered */
            font-size: 14px;   /* Adjust font-size if necessary */
            cursor: pointer;
        }

        #thumbnailsContainer img {
            width: 100px;
            height: 100px;
            object-fit: cover;
            margin: 5px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        /* Center content inside the modal */
        .add-sample-modal {
            text-align: center;
        }

        /* Limit the width of inputs inside the modal */
        .add-sample-modal .form-group input {
            width: 100%;
            max-width: 200px; /* Set a max-width to prevent the input from stretching too much */
        }

        /* Modal-specific styles */
        .add-sample-modal .form-row {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .add-sample-modal .form-group {
            flex: 1;
            display: flex;
            flex-direction: column;
            margin-bottom: 5px;
            text-align: center;
        }

        .add-sample-modal .form-group label {
            margin-bottom: 5px;
            font-size: 14px;
        }

        .add-sample-modal .form-group input {
            padding: 5px;
            font-size: 14px;
            width: 100%;
            max-width: 200px;
        }

        /* General text styling within the modal */
        .modal-content {
            line-height: 1.2;
        }

        .modal-body p, .modal-body label {
            margin: 0;
        }
    </style>
</head>
<body>
    <!-- Include CSRF token and excelData for JavaScript -->
    <script type="text/javascript">
        const csrftoken = '{{ csrf_token }}';
        const excelData = {{ excel_data|safe }};
        const samples = {{ samples|safe }};
        function downloadDocumentation(sampleId) {
            window.location.href = '/download_documentation/' + sampleId + '/';
        }

        function showPrevImage(event) {
            event.stopPropagation(); // Prevent event bubbling
            if (window.currentImageIndex > 0) {
                window.currentImageIndex--;
            } else {
                window.currentImageIndex = window.currentImageDataArray.length - 1; // Loop back to last image
            }
            viewFullSizeImage(window.currentImageIndex);
        }

        function showNextImage(event) {
            event.stopPropagation(); // Prevent event bubbling
            if (window.currentImageIndex < window.currentImageDataArray.length - 1) {
                window.currentImageIndex++;
            } else {
                window.currentImageIndex = 0; // Loop back to first image
            }
            viewFullSizeImage(window.currentImageIndex);
        }

        function handleKeyDown(event) {
            if (event.key === 'ArrowLeft') {
                showPrevImage(event);
            } else if (event.key === 'ArrowRight') {
                showNextImage(event);
            } else if (event.key === 'Escape') {
                closeFullSizeModal(event);
            }
        }
        function uploadDocumentation(sampleId) {
            // Create a hidden file input element
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.xlsm,.xlsx'; // Accept Excel files
            fileInput.style.display = 'none';

            // Append to the body
            document.body.appendChild(fileInput);

            // Trigger the file dialog
            fileInput.click();

            // Handle file selection
            fileInput.addEventListener('change', function() {
                const file = fileInput.files[0];
                if (file) {
                    // Validate file type (optional but recommended)
                    const allowedExtensions = /(\.xlsm|\.xlsx)$/i;
                    if (!allowedExtensions.exec(file.name)) {
                        alert('Please upload a valid Excel file (.xlsm or .xlsx).');
                        document.body.removeChild(fileInput);
                        return;
                    }

                    // Convert sampleId to an integer
                    const sampleIdInt = parseInt(sampleId, 10);

                    // Fetch sample data from the samples array
                    const sample = samples.find(s => s.unique_id === sampleIdInt);
                    if (!sample) {
                        alert('Sample data not found.');
                        document.body.removeChild(fileInput);
                        return;
                    }

                    // Construct the expected filename
                    const expectedFilename = `Documentation_${sample.opportunity_number}_${sample.date_received.replace(/-/g, '')}.xlsm`;
            
                    // Compare filenames (case-insensitive)
                    if (file.name.toLowerCase() !== expectedFilename.toLowerCase()) {
                        alert(`Invalid filename. Expected filename: ${expectedFilename}`);
                        document.body.removeChild(fileInput);
                        return;
                    }
                    const formData = new FormData();
                    formData.append('file', file);
                    formData.append('sample_id', sampleId);

                    // Send the file via AJAX to the server
                    fetch('{% url "upload_documentation" %}', {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': csrftoken
                        },
                        body: formData
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            alert('Documentation uploaded successfully.');
                        } else {
                            alert('Error uploading documentation: ' + data.error);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('An unexpected error occurred during upload.');
                    });
                }
                // Clean up
                document.body.removeChild(fileInput);
            });
        }
    </script>

    <!-- Full-Size Image Modal -->
    <div id="fullSizeModal" class="modal" style="display: none;" onclick="closeFullSizeModal(event)">
        <!-- The content will be dynamically generated in JavaScript -->
    </div>

    <form method="POST" id="sampleForm">
        <!-- Include CSRF token in the form -->
        <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
        <div class="form-container">
            <div class="input-group">
                <label for="customer">Customer:</label>
                <select id="customer" name="customer" onchange="filterOptions()">
                    <option value="">Select a Customer</option>
                    {% for customer in unique_customers %}
                    <option value="{{ customer }}">{{ customer }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="input-group">
                <label for="rsm">RSM:</label>
                <select id="rsm" name="rsm" onchange="filterOptions()">
                    <option value="">Select an RSM</option>
                    {% for rsm in unique_rsms %}
                    <option value="{{ rsm }}">{{ rsm }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="input-group">
                <label for="opportunity_number">Opportunity #:</label>
                <select id="opportunity_number" name="opportunity_number" class="opportunity-dropdown" onchange="populateFieldsFromOpportunity()">
                    <option value="">Select an Opportunity</option>
                </select>
            </div>

            <div class="input-group">
                <label for="description">Description:</label>
                <input type="text" id="description" name="description" readonly>
            </div>
        </div>

        <div class="button-container">
            <button type="button" onclick="validateAndShowModal()">Add Sample</button>
            <button type="button" onclick="resetFilters()">Reset</button>
            <button type="button" id="print-all-button">Print</button>
            <button type="button" id="delete-all-button">Delete</button>
        </div>
    </form>

    <!-- The Table for displaying samples -->
    <table id="samplesTable" border="1">
        <thead>
            <tr>
                <th class="col-select">Select</th>
                <th class="col-opportunity">Opp Number</th>
                <th class="col-customer">Customer</th>
                <th class="col-rsm">RSM</th>
                <th class="col-date">Date Received</th>
                <th class="col-description">Description</th>
                <th class="col-id">ID</th>
                <th class="col-location">Location</th>
                <th class="col-pictures" rowspan="2">Pictures</th>
                <th class="col-documentation" rowspan="2">Documentation</th>
            </tr>
            <tr>
                <th class="col-select">
                    <input type="checkbox" id="select-all-select">
                </th>
                <th class="col-opportunity"><div class="filter-wrapper"><input type="text" id="opportunityFilter" placeholder="Filter Opportunity" class="filter-input" onkeyup="filterTable()"></div></th>
                <th class="col-customer"><div class="filter-wrapper"><input type="text" id="customerFilter" placeholder="Filter Customer" class="filter-input" onkeyup="filterTable()"></div></th>
                <th class="col-rsm"><div class="filter-wrapper"><input type="text" id="rsmFilter" placeholder="Filter RSM" class="filter-input" onkeyup="filterTable()"></div></th>
                <th class="col-date"><div class="filter-wrapper"><input type="text" id="dateFilter" placeholder="Filter Date" class="filter-input" onkeyup="filterTable()"></div></th>
                <th class="col-description"><div class="filter-wrapper"><input type="text" id="descriptionFilter" placeholder="Filter Description" class="filter-input" onkeyup="filterTable()"></div></th>
                <th class="col-id"><div class="filter-wrapper"><input type="text" id="idFilter" placeholder="Filter ID" class="filter-input" onkeyup="filterTable()"></div></th>
                <th class="col-location"><div class="filter-wrapper"><input type="text" id="locationFilter" placeholder="Filter Location" class="filter-input" onkeyup="filterTable()"></div></th>
            </tr>
        </thead>
        <tbody>
            <!-- Existing samples will be loaded via JavaScript -->
        </tbody>
    </table>

    <!-- The Modal for Adding Samples -->
    <div id="addSampleModal" class="modal add-sample-modal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Add Sample</h2>
                    <span class="close" onclick="closeAddSampleModal()">&times;</span>
                </div>
                <div class="modal-body add-sample-modal">
                    <form id="addSampleForm" onsubmit="submitForm(event); return false;">
                        <div class="modal-form-row">
                            <div class="modal-form-group">
                                <label for="date_received">Date Received:</label>
                                <input type="text" id="date_received" name="date_received">
                            </div>
                            <div class="modal-form-group quantity-group">
                                <label for="quantity">Quantity:</label>
                                <input type="number" id="quantity" name="quantity" min="1">
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="submit">Submit</button>
                            <button type="button" onclick="closeAddSampleModal()">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- The Upload/View Modal -->
    <div id="uploadModal" class="modal upload-modal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Upload/View Images</h2>
                    <span class="close" onclick="closeUploadModal()">&times;</span>
                </div>
                <div class="modal-body">
                    <!-- Thumbnails Container -->
                    <div id="thumbnailsContainer"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" onclick="selectFiles()">Upload</button>
                    <button type="button" onclick="closeUploadModal()">Done</button>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript code -->
    <script>
        function pollForFullSizeImages(sampleId, imageIds) {
            var attempts = 0;
            var maxAttempts = 10; // Number of polling attempts
            var intervalTime = 2000; // Interval between attempts in milliseconds (2 seconds)

            var interval = setInterval(function() {
                attempts++;
                if (attempts > maxAttempts) {
                    clearInterval(interval);
                    return;
                }
                fetch("{% url 'get_sample_images' %}?sample_id=" + sampleId)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        var allFullSizeAvailable = imageIds.every(function(id) {
                            var image = data.images.find(img => img.id === id);
                            return image && image.full_size_url;
                        });
                        if (allFullSizeAvailable) {
                            clearInterval(interval);
                            // Refresh the thumbnails
                            displayThumbnails(data.images);
                        }
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    clearInterval(interval);
                });
            }, intervalTime);
        }

        function viewFullSizeImage(index) {
            console.log('viewFullSizeImage called with index:', index);
            window.currentImageIndex = index;
            const imageDataArray = window.currentImageDataArray;
            const imageData = imageDataArray[index];
            const fullSizeImageUrl = imageData.full_size_url;
            const filename = imageData.filename;
            const fullSizeModal = document.getElementById('fullSizeModal');
            if (fullSizeModal) {
                // Set the innerHTML of the modal
                fullSizeModal.innerHTML = `
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header full-size-modal-header">
                                <h2>${filename}</h2>
                                <span class="close" onclick="closeFullSizeModal()">&times;</span>
                            </div>
                            <div class="modal-body">
                                ${index > 0 ? '<button class="prev-button" onclick="showPrevImage(event)">&#10094;</button>' : ''}
                                <img src="${fullSizeImageUrl}" alt="${filename}">
                                ${index < imageDataArray.length - 1 ? '<button class="next-button" onclick="showNextImage(event)">&#10095;</button>' : ''}
                            </div>
                        </div>
                    </div>
                `;
                // Show the modal
                fullSizeModal.style.display = 'flex';
                // Add this line to attach the keydown event listener
                document.addEventListener('keydown', handleKeyDown);
            }
        }

        function closeFullSizeModal(event) {
            if (event) {
                // Only close if clicked outside the modal content
                const modalContent = document.querySelector('#fullSizeModal .modal-content');
                if (modalContent && modalContent.contains(event.target)) {
                    return;
                }
            }
            const fullSizeModal = document.getElementById('fullSizeModal');
            if (fullSizeModal) {
                fullSizeModal.style.display = 'none';
                fullSizeModal.innerHTML = ''; // Optionally clear the modal content
            }
        }

        function closeFullSizeModal(event) {
            if (event) {
                // Only close if clicked outside the modal content
                const modalContent = document.querySelector('#fullSizeModal .modal-content');
                if (modalContent && modalContent.contains(event.target)) {
                    return;
                }
            }
            const fullSizeModal = document.getElementById('fullSizeModal');
            if (fullSizeModal) {
                fullSizeModal.style.display = 'none';
                fullSizeModal.innerHTML = ''; // Optionally clear the modal content

                // Add this line to remove the keydown event listener
                document.removeEventListener('keydown', handleKeyDown);
            } else {
                console.error('Modal container not found in the DOM.');
            }
        }

        function sanitizeOppNum(oppNum) {
            return oppNum.replace(/\s+/g, '_').replace(/[^a-zA-Z0-9_-]/g, '');
        }

        // Declare selectAllSelectCheckbox at the global scope
        const selectAllSelectCheckbox = document.getElementById('select-all-select');

        document.addEventListener("DOMContentLoaded", function() {
            // Initialize variables
            const csrftoken = '{{ csrf_token }}';
            const samples = {{ samples|safe }};
            const todayDate = new Date().toISOString().split('T')[0];
            let isPopulating = false; // Flag to prevent recursive triggering
            let currentSampleId = null; // For image uploads

            // Initialize Select2 for dropdowns with search capability
            $('#customer, #rsm, #opportunity_number').select2({
                width: 'resolve',
                matcher: matchCustom
            });

            // Custom matcher function for multi-keyword search
            function matchCustom(params, data) {
                if ($.trim(params.term) === '') {
                    return data;
                }
                const terms = params.term.toLowerCase().split(' ');
                const original = data.text.toLowerCase();
                const matches = terms.every(term => original.includes(term));

                if (matches) {
                    return data;
                }
                return null;
            }

            // Event listener for the print button
            document.getElementById('print-all-button').addEventListener('click', function() {
                submitPrint();
            });

            // Submit Print function
            window.submitPrint = function() {
                const selectedCheckboxes = document.querySelectorAll('input[name="select_checkbox"]:checked');
                const idsToPrint = Array.from(selectedCheckboxes).map(checkbox => checkbox.value);

                if (idsToPrint.length === 0) {
                    return;
                }

                console.log(`Proceeding to print ${idsToPrint.length} entries.`);

                // Define affectedGroups as a Set to keep track of affected opportunity numbers
                const affectedGroups = new Set();
                // Collect the opportunity numbers of the selected samples
                selectedCheckboxes.forEach(checkbox => {
                    const row = checkbox.closest('tr');
                    const oppNumCell = row.querySelector('.col-opportunity');
                    if (oppNumCell) {
                        const oppNum = oppNumCell.textContent.trim();
                        affectedGroups.add(oppNum);
                    }
                });

                fetch("{% url 'handle_print_request' %}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken
                    },
                    body: JSON.stringify({'ids': idsToPrint}),
                    credentials: 'same-origin'  // Include cookies in the request
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => { throw err; });
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.status === 'success') {
                        // Labels have been generated successfully

                        // Here you would send this data to your printer
                        // For each affected group, check if any entries remain
                        affectedGroups.forEach(oppNum => {
                            const sanitizedOppNum = sanitizeOppNum(oppNum);
                            const remainingRows = document.querySelectorAll(`.group-${sanitizedOppNum}`);
                            if (remainingRows.length === 0) {
                                // No more entries in the group, remove the group row
                                const groupRow = document.querySelector(`.group-row[data-opp-num="${sanitizedOppNum}"]`);
                                if (groupRow) {
                                    groupRow.parentNode.removeChild(groupRow);
                                }
                            }
                        });

                    } else {
                        console.error('Error generating labels:', data.error);
                    }
                })
                .catch(error => {
                    console.error('Fetch Error:', error);
                });
            };

            // Minimize all groups
            const expandButtons = document.querySelectorAll('.expand-button');
            expandButtons.forEach(button => {
                button.textContent = '+';
                const sanitizedOppNum = button.getAttribute('data-opp-num'); // Already sanitized
                const groupedRows = document.querySelectorAll(`.group-${sanitizedOppNum}`);
                groupedRows.forEach(row => {
                    row.style.display = 'none';
                });
            });

            // Delete selected entries
            document.getElementById('delete-all-button').addEventListener('click', function() {
                const selectedCheckboxes = document.querySelectorAll('input[name="select_checkbox"]:checked');
                const idsToDelete = Array.from(selectedCheckboxes).map(checkbox => checkbox.value);

                if (idsToDelete.length === 0) {
                    alert('No entries selected for deletion.');
                    return;
                }

                if (confirm('Are you sure you want to delete the selected entries?')) {
                    const formData = new FormData();
                    formData.append('csrfmiddlewaretoken', csrftoken);
                    formData.append('ids', JSON.stringify(idsToDelete));

                    // Define affectedGroups
                    const affectedGroups = new Set();

                    selectedCheckboxes.forEach(checkbox => {
                        const row = checkbox.closest('tr');
                        const oppNumCell = row.querySelector('.col-opportunity');
                        if (oppNumCell) {
                            const oppNum = oppNumCell.textContent.trim();
                            affectedGroups.add(oppNum);
                        }
                    });

                    fetch("{% url 'delete_samples' %}", {
                        method: 'POST',
                        body: formData,
                        credentials: 'same-origin'  // Include cookies
                    }).then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            selectedCheckboxes.forEach(checkbox => {
                                const row = checkbox.closest('tr');
                                row.parentNode.removeChild(row); // Remove the row from the table
                            });

                            // For each affected group, check if any entries remain
                            affectedGroups.forEach(oppNum => {
                                const sanitizedOppNum = sanitizeOppNum(oppNum);
                                const remainingRows = document.querySelectorAll(`.group-${sanitizedOppNum}`);
                                if (remainingRows.length === 0) {
                                    // No more entries in the group, remove the group row
                                    const groupRow = document.querySelector(`.group-row[data-opp-num="${sanitizedOppNum}"]`);
                                    if (groupRow) {
                                        groupRow.parentNode.removeChild(groupRow);
                                    }
                                }
                            });

                            selectAllSelectCheckbox.checked = false; // Clear the "Select All" checkbox
                            console.log('Entries deleted successfully.');
                        } else {
                            console.error('Error deleting entries:', data.error);
                        }
                    });
                }
            });

            // Select All functionality with row highlighting
            selectAllSelectCheckbox.addEventListener('change', function() {
                const visibleSampleRows = document.querySelectorAll('#samplesTable tbody tr:not([style*="display: none"]):not(.group-row)');
                visibleSampleRows.forEach(function(row) {
                    const checkbox = row.querySelector('input[name="select_checkbox"]');
                    if (checkbox) {
                        checkbox.checked = this.checked;
                        if (this.checked) {
                            row.classList.add('selected-row');
                        } else {
                            row.classList.remove('selected-row');
                        }
                    }
                }, this);
            });

            // Update Sample Location function
            window.updateSampleLocation = function(sampleId, location) {
                // Get all selected checkboxes
                const selectedCheckboxes = document.querySelectorAll('input[name="select_checkbox"]:checked');

                // If there are selected checkboxes, update all of them
                if (selectedCheckboxes.length > 0) {
                    const idsToUpdate = Array.from(selectedCheckboxes).map(checkbox => checkbox.value);

                    const formData = new FormData();
                    formData.append('csrfmiddlewaretoken', csrftoken);
                    formData.append('ids', JSON.stringify(idsToUpdate));
                    formData.append('location', location);

                    fetch("{% url 'update_sample_location' %}", {
                        method: 'POST',
                        body: formData,
                        credentials: 'same-origin'  // Include cookies
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            console.log('Sample locations updated successfully for selected samples.');

                            // Update the dropdowns in real-time
                            idsToUpdate.forEach(id => {
                                const dropdown = document.querySelector(`select[data-sample-id="${id}"]`);
                                if (dropdown) {
                                    dropdown.value = location;
                                }
                            });
                        } else {
                            console.error('Error updating sample locations:', data.error);
                        }
                    })
                    .catch(error => {
                        console.error('Fetch error:', error);
                    });
                } else {
                    // If no checkboxes are selected, update only the single sample whose dropdown was changed
                    const formData = new FormData();
                    formData.append('csrfmiddlewaretoken', csrftoken);
                    formData.append('sample_id', sampleId);
                    formData.append('location', location);

                    fetch("{% url 'update_sample_location' %}", {
                        method: 'POST',
                        body: formData,
                        credentials: 'same-origin'  // Include cookies
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            console.log(`Sample location updated successfully for sample ID: ${sampleId}.`);

                            // Update the dropdown in real-time
                            const dropdown = document.querySelector(`select[data-sample-id="${sampleId}"]`);
                            if (dropdown) {
                                dropdown.value = location;
                            }
                        } else {
                            console.error(`Error updating sample location for sample ID: ${sampleId}:`, data.error);
                        }
                    })
                    .catch(error => {
                        console.error('Fetch error:', error);
                    });
                }
            };

            // Submit Form function
            window.submitForm = function(event) {
                if (event) event.preventDefault();
                const dateReceived = $('#date_received').val();
                const quantity = $('#quantity').val();

                if (quantity === "") {
                    alert("Please enter the quantity.");
                } else {
                    const customer = document.getElementById('customer').value;
                    const rsm = document.getElementById('rsm').value;
                    const opportunityNumber = document.getElementById('opportunity_number').value;
                    const description = document.getElementById('description').value;
                    const location = "Choose a location"; // Default location

                    const formData = new FormData();
                    formData.append('csrfmiddlewaretoken', csrftoken);
                    formData.append('date_received', dateReceived);
                    formData.append('customer', customer);
                    formData.append('rsm', rsm);
                    formData.append('opportunity_number', opportunityNumber);
                    formData.append('description', description);
                    formData.append('location', location);
                    formData.append('quantity', quantity);

                    fetch("{% url 'create_sample' %}", {
                        method: 'POST',
                        body: formData,
                        credentials: 'same-origin'  // Include cookies
                    }).then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            data.created_samples.forEach(sample => {
                                const newRow = document.createElement('tr');
                                newRow.innerHTML = `
                                    <td class="col-select">
                                        <input type="checkbox" name="select_checkbox" value="${sample.unique_id}">
                                    </td>
                                    <td class="col-opportunity">${sample.opportunity_number}</td>
                                    <td class="col-customer">${sample.customer}</td>
                                    <td class="col-rsm">${sample.rsm}</td>
                                    <td class="col-date">${sample.date_received}</td>
                                    <td class="col-description">${sample.description}</td>
                                    <td class="col-id">${sample.unique_id}</td>
                                    <td class="col-location">
                                        <select data-sample-id="${sample.unique_id}" onchange="updateSampleLocation('${sample.unique_id}', this.value)">
                                            <option value="Choose a location" ${sample.location === "Choose a location" ? "selected" : ""}>Choose a location</option>
                                            <option value="Test Lab Fridge">Test Lab Fridge</option>
                                            <option value="Test Lab Freezer">Test Lab Freezer</option>
                                            <option value="Walk-in Fridge">Walk-in Fridge</option>
                                            <option value="Walk-in Freezer">Walk-in Freezer</option>
                                            <option value="Dry Food Storage">Dry Food Storage</option>
                                            <option value="Empty Case Storage">Empty Case Storage</option>
                                        </select>
                                    </td>
                                    <td class="col-pictures">
                                        <button type="button" onclick="handlePictureUploadView('${sample.unique_id}')">Upload/View</button>
                                    </td>
                                    </td>
                                    <td class="col-documentation">
                                        <div class="doc-buttons">
                                            <button type="button" onclick="downloadDocumentation('${sample.unique_id}')" class="upload-view-button download-button">Download</button>
                                            <button type="button" onclick="uploadDocumentation('${sample.unique_id}')" class="upload-view-button upload-button">Upload</button>
                                        </div>
                                    </td>
                                `;
                                document.querySelector('#samplesTable tbody').appendChild(newRow);
                            });
                            console.log('Sample saved successfully.');
                        } else {
                            console.error('Error saving sample:', data.error);
                        }
                    });

                    closeAddSampleModal();
                    resetForm();
                }
            };

            // Filter Options function
            window.filterOptions = function() {
                if (isPopulating) return;
                const customer = document.getElementById('customer').value;
                const rsm = document.getElementById('rsm').value;

                const filteredData = excelData.filter(record =>
                    (customer === "" || record['Customer'] === customer) &&
                    (rsm === "" || record['RSM'] === rsm)
                );

                updateSelectOptions(document.getElementById('customer'), 'Customer', filteredData, customer);
                updateSelectOptions(document.getElementById('rsm'), 'RSM', filteredData, rsm);
                updateSelectOptions(document.getElementById('opportunity_number'), 'Opportunity #', filteredData);
            };

            // Populate Fields from Opportunity function
            window.populateFieldsFromOpportunity = function() {
                const opportunityNumber = document.getElementById('opportunity_number').value;
                const selectedData = excelData.find(record => record['Opportunity #'] === parseInt(opportunityNumber));

                if (selectedData) {
                    isPopulating = true; // Set flag to true
                    $('#customer').val(selectedData['Customer']).trigger('change.select2');
                    $('#rsm').val(selectedData['RSM']).trigger('change.select2');
                    document.getElementById('description').value = selectedData['Description'];
                    isPopulating = false; // Reset flag to false
                } else {
                    document.getElementById('description').value = '';
                }
            };

            // Open Add Sample Modal function
            function openAddSampleModal() {
                // Initialize date picker when modal opens
                $("#date_received").datepicker({ dateFormat: 'yy-mm-dd' }).datepicker("setDate", new Date());

                document.getElementById('addSampleModal').style.display = 'block';

                // Set focus to the quantity field after ensuring the element is rendered
                setTimeout(function() {
                    document.getElementById('quantity').focus();
                }, 0);
            }

            // Close Add Sample Modal function
            window.closeAddSampleModal = function() {
                document.getElementById('addSampleModal').style.display = 'none';
                resetAddSampleForm();
            }

            // Validate and Show Modal function
            window.validateAndShowModal = function() {
                const customer = document.getElementById('customer').value;
                const rsm = document.getElementById('rsm').value;
                const opportunityNumber = document.getElementById('opportunity_number').value;

                if (customer === "" || rsm === "" || opportunityNumber === "") {
                    alert("Please complete all selections before adding a sample.");
                } else {
                    openAddSampleModal();
                }
            };

            // Close the modal when clicking outside of it
            window.onclick = function(event) {
                const modal = document.getElementById('addSampleModal');
                if (event.target === modal) {
                    closeAddSampleModal();
                }
            };

            // Reset Filters function
            window.resetFilters = function() {
                // Reset dropdown filters
                document.getElementById('customer').value = "";
                document.getElementById('rsm').value = "";
                document.getElementById('opportunity_number').value = "";
                document.getElementById('description').value = "";

                // Update dropdown options to default
                updateSelectOptions(document.getElementById('customer'), 'Customer', excelData);
                updateSelectOptions(document.getElementById('rsm'), 'RSM', excelData);
                updateSelectOptions(document.getElementById('opportunity_number'), 'Opportunity #', excelData);

                // Reset Select2 elements
                $('#customer, #rsm, #opportunity_number').val(null).trigger('change.select2');

                // Clear text filters in the table
                document.getElementById('idFilter').value = "";
                document.getElementById('dateFilter').value = "";
                document.getElementById('customerFilter').value = "";
                document.getElementById('rsmFilter').value = "";
                document.getElementById('opportunityFilter').value = "";
                document.getElementById('descriptionFilter').value = "";
                document.getElementById('locationFilter').value = "";

                // Uncheck all checkboxes in the table and remove highlighting
                const checkboxes = document.querySelectorAll('input[name="select_checkbox"]');
                checkboxes.forEach(checkbox => {
                    checkbox.checked = false;
                    const row = checkbox.closest('tr');
                    row.classList.remove('selected-row');
                });

                // Clear the "Select All" checkbox
                const selectAllCheckbox = document.getElementById('select-all-select');
                if (selectAllCheckbox) {
                    selectAllCheckbox.checked = false;
                }

                // Reapply filters to clear the table
                filterTable();

                // Collapse all groups
                const expandButtons = document.querySelectorAll('.expand-button');
                expandButtons.forEach(button => {
                    button.textContent = '+';
                    const sanitizedOppNum = button.getAttribute('data-opp-num'); // Already sanitized
                    const groupedRows = document.querySelectorAll(`.group-${sanitizedOppNum}`);
                    groupedRows.forEach(row => {
                        row.style.display = 'none';
                    });
                });
            };

            // Update Select Options function
            function updateSelectOptions(selectElement, key, filteredData, currentValue = "") {
                const uniqueValues = [...new Set(filteredData.map(record => record[key]))];
                uniqueValues.sort((a, b) => {
                    if (key === 'Opportunity #') {
                        return a - b;
                    }
                    return a.localeCompare(b);
                });

                selectElement.innerHTML = '<option value="">Select an option</option>';
                uniqueValues.forEach(value => {
                    if (value) {
                        const option = document.createElement('option');
                        option.value = value;
                        option.textContent = value;
                        if (value === currentValue) {
                            option.selected = true;
                        }
                        selectElement.appendChild(option);
                    }
                });

                // Reinitialize Select2 after updating options
                $(selectElement).select2({
                    width: 'resolve',
                    matcher: matchCustom
                });
            }

            const groupsToShow = new Set();
            window.filterTable = function() {
                const idFilter = document.getElementById('idFilter').value.toLowerCase();
                const dateFilter = document.getElementById('dateFilter').value.toLowerCase();
                const customerFilter = document.getElementById('customerFilter').value.toLowerCase();
                const rsmFilter = document.getElementById('rsmFilter').value.toLowerCase();
                const opportunityFilter = document.getElementById('opportunityFilter').value.toLowerCase();
                const descriptionFilter = document.getElementById('descriptionFilter').value.toLowerCase();
                const locationFilter = document.getElementById('locationFilter').value.toLowerCase();

                const filtersApplied = idFilter || dateFilter || customerFilter || rsmFilter || opportunityFilter || descriptionFilter || locationFilter;

                const table = document.getElementById('samplesTable');
                const tr = table.getElementsByTagName('tr');

                for (let i = 2; i < tr.length; i++) { // Start from 2 to skip header rows
                    const row = tr[i];

                    // Check if the row is a group row
                    if (row.classList.contains('group-row')) {
                        const oppNum = row.querySelector('.col-opportunity').textContent;
                        const sanitizedOppNum = sanitizeOppNum(oppNum);
                        const expandButton = row.querySelector('.expand-button');
                        const isExpanded = expandButton.textContent === '-';

                        // Decide whether to display the group row based on if any of its children match the filter
                        const groupedRows = document.querySelectorAll(`.group-${sanitizedOppNum}`);
                        let groupHasMatch = false;

                        groupedRows.forEach(childRow => {
                            const tdOpportunity = childRow.getElementsByTagName('td')[1];
                            const tdCustomer = childRow.getElementsByTagName('td')[2];
                            const tdRsm = childRow.getElementsByTagName('td')[3];
                            const tdDate = childRow.getElementsByTagName('td')[4];
                            const tdDescription = childRow.getElementsByTagName('td')[5];
                            const tdId = childRow.getElementsByTagName('td')[6];
                            const tdLocation = childRow.getElementsByTagName('td')[7];

                            if (tdId && tdDate && tdCustomer && tdRsm && tdOpportunity && tdDescription && tdLocation) {
                                const idValue = tdId.textContent || tdId.innerText;
                                const dateValue = tdDate.textContent || tdDate.innerText;
                                const customerValue = tdCustomer.textContent || tdCustomer.innerText;
                                const rsmValue = tdRsm.textContent || tdRsm.innerText;
                                const opportunityValue = tdOpportunity.textContent || tdOpportunity.innerText;
                                const descriptionValue = tdDescription.textContent || tdDescription.innerText;
                                const locationValue = tdLocation.textContent || tdLocation.innerText;

                                if (
                                    idValue.toLowerCase().indexOf(idFilter) > -1 &&
                                    dateValue.toLowerCase().indexOf(dateFilter) > -1 &&
                                    customerValue.toLowerCase().indexOf(customerFilter) > -1 &&
                                    rsmValue.toLowerCase().indexOf(rsmFilter) > -1 &&
                                    opportunityValue.toLowerCase().indexOf(opportunityFilter) > -1 &&
                                    descriptionValue.toLowerCase().indexOf(descriptionFilter) > -1 &&
                                    locationValue.toLowerCase().indexOf(locationFilter) > -1
                                ) {
                                    groupHasMatch = true;
                                    childRow.style.display = ''; // Show matching child rows
                                } else {
                                    childRow.style.display = 'none';
                                }
                            }
                        });

                        if (groupHasMatch) {
                            row.style.display = '';
                            const expandButton = row.querySelector('.expand-button');
                            if (filtersApplied) {
                                expandButton.textContent = '-'; // Expand group if filters are applied
                                groupedRows.forEach(childRow => {
                                    childRow.style.display = ''; // Show matching child rows
                                });
                            } else {
                                expandButton.textContent = '+';
                                groupedRows.forEach(childRow => {
                                    childRow.style.display = 'none'; // Keep child rows hidden when no filters
                                });
                            }
                        }

                        continue; // Move to the next row
                    }

                    // Process rows that are not part of a group (if any)
                    const tdOpportunity = row.getElementsByTagName('td')[1];
                    const tdCustomer = row.getElementsByTagName('td')[2];
                    const tdRsm = row.getElementsByTagName('td')[3];
                    const tdDate = row.getElementsByTagName('td')[4];
                    const tdDescription = row.getElementsByTagName('td')[5];
                    const tdId = row.getElementsByTagName('td')[6];
                    const tdLocation = row.getElementsByTagName('td')[7];

                    if (tdId && tdDate && tdCustomer && tdRsm && tdOpportunity && tdDescription && tdLocation) {
                        const idValue = tdId.textContent || tdId.innerText;
                        const dateValue = tdDate.textContent || tdDate.innerText;
                        const customerValue = tdCustomer.textContent || tdCustomer.innerText;
                        const rsmValue = tdRsm.textContent || tdRsm.innerText;
                        const opportunityValue = tdOpportunity.textContent || tdOpportunity.innerText;
                        const descriptionValue = tdDescription.textContent || tdDescription.innerText;
                        const locationValue = tdLocation.textContent || tdLocation.innerText;

                        if (
                            idValue.toLowerCase().indexOf(idFilter) > -1 &&
                            dateValue.toLowerCase().indexOf(dateFilter) > -1 &&
                            customerValue.toLowerCase().indexOf(customerFilter) > -1 &&
                            rsmValue.toLowerCase().indexOf(rsmFilter) > -1 &&
                            opportunityValue.toLowerCase().indexOf(opportunityFilter) > -1 &&
                            descriptionValue.toLowerCase().indexOf(descriptionFilter) > -1 &&
                            locationValue.toLowerCase().indexOf(locationFilter) > -1
                        ) {
                            row.style.display = '';
                        } else {
                            row.style.display = 'none';
                        }
                    }
                }
            };

            // Reset Form function
            window.resetForm = function() {
                document.getElementById('sampleForm').reset(); // Resets all form fields
                // If you're using Select2, reset it as well
                $('#customer, #rsm, #opportunity_number').val(null).trigger('change.select2');
                document.getElementById('description').value = ''; // Clear the description field
            };

            // Initialize dropdowns with all options
            updateSelectOptions(document.getElementById('customer'), 'Customer', excelData);
            updateSelectOptions(document.getElementById('rsm'), 'RSM', excelData);
            updateSelectOptions(document.getElementById('opportunity_number'), 'Opportunity #', excelData);

            // Load existing samples into the table
            // Group samples by 'opportunity_number'
            const groupedSamples = {};
            samples.forEach(sample => {
                const oppNum = sample.opportunity_number;
                if (!groupedSamples[oppNum]) {
                    groupedSamples[oppNum] = [];
                }
                groupedSamples[oppNum].push(sample);
            });

            // Clear the existing table body
            const tableBody = document.querySelector('#samplesTable tbody');
            tableBody.innerHTML = '';

            // Iterate over each group
            Object.keys(groupedSamples).forEach(oppNum => {
                const group = groupedSamples[oppNum];

                // Define new variables to hold the customer and RSM values from the group
                const groupCustomer = group[0].customer;
                const groupRsm = group[0].rsm;

                if (group.length === 1) {
                    // If only one entry, display it as usual
                    const sample = group[0];
                    const newRow = document.createElement('tr');
                    newRow.innerHTML = `
                        <td class="col-select">
                            <input type="checkbox" name="select_checkbox" value="${sample.unique_id}">
                        </td>
                        <td class="col-opportunity">${sample.opportunity_number}</td>
                        <td class="col-customer">${sample.customer}</td>
                        <td class="col-rsm">${sample.rsm}</td>
                        <td class="col-date">${sample.date_received}</td>
                        <td class="col-description">${sample.description}</td>
                        <td class="col-id">${sample.unique_id}</td>
                        <td class="col-location">
                            <select data-sample-id="${sample.unique_id}" onchange="updateSampleLocation(${JSON.stringify(sample.unique_id)}, this.value)">
                                <option value="" ${!sample.storage_location ? "selected" : ""}>Choose a location</option>
                                <option value="Test Lab Fridge" ${sample.storage_location === "Test Lab Fridge" ? "selected" : ""}>Test Lab Fridge</option>
                                <option value="Test Lab Freezer" ${sample.storage_location === "Test Lab Freezer" ? "selected" : ""}>Test Lab Freezer</option>
                                <option value="Walk-in Fridge" ${sample.storage_location === "Walk-in Fridge" ? "selected" : ""}>Walk-in Fridge</option>
                                <option value="Walk-in Freezer" ${sample.storage_location === "Walk-in Freezer" ? "selected" : ""}>Walk-in Freezer</option>
                                <option value="Dry Food Storage" ${sample.storage_location === "Dry Food Storage" ? "selected" : ""}>Dry Food Storage</option>
                                <option value="Empty Case Storage" ${sample.storage_location === "Empty Case Storage" ? "selected" : ""}>Empty Case Storage</option>
                            </select>
                        </td>
                        <td class="col-pictures">
                            <button type="button" onclick="handlePictureUploadView(${JSON.stringify(sample.unique_id)})">Upload/View</button>
                        </td>
                        <td class="col-documentation">
                            <div class="doc-buttons">
                                <button type="button" onclick="downloadDocumentation('${sample.unique_id}')" class="upload-view-button download-button">Download</button>
                                <button type="button" onclick="uploadDocumentation('${sample.unique_id}')" class="upload-view-button upload-button">Upload</button>
                            </div>
                        </td>
                    `;
                    tableBody.appendChild(newRow);
                } else {
                    // Create a group row without a select box and with a '+' button
                    const sanitizedOppNum = sanitizeOppNum(oppNum); // Sanitize oppNum
                    const groupRow = document.createElement('tr');
                    groupRow.classList.add('group-row');
                    groupRow.setAttribute('data-opp-num', sanitizedOppNum); // Use sanitizedOppNum
                    groupRow.innerHTML = `
                        <td class="col-select">
                            <button type="button" class="expand-button" data-opp-num="${sanitizedOppNum}">+</button>
                        </td>
                        <td class="col-opportunity">${oppNum}</td>
                        <td class="col-customer">${groupCustomer}</td>
                        <td class="col-rsm">${groupRsm}</td>
                        <td colspan="6"> <!-- Increased colspan by 1 -->
                            (${group.length} entries)
                        </td>
                    `;
                    tableBody.appendChild(groupRow);

                    // Add rows for each sample in the group, initially hidden
                    group.forEach(sample => {
                        const sampleRow = document.createElement('tr');
                        sampleRow.classList.add('grouped-row', `group-${sanitizedOppNum}`); // Use sanitizedOppNum
                        sampleRow.style.display = 'none'; // Initially hidden
                        sampleRow.innerHTML = `
                            <td class="col-select">
                                <input type="checkbox" name="select_checkbox" value="${sample.unique_id}">
                            </td>
                            <td class="col-opportunity">${sample.opportunity_number}</td>
                            <td class="col-customer">${sample.customer}</td>
                            <td class="col-rsm">${sample.rsm}</td>
                            <td class="col-date">${sample.date_received}</td>
                            <td class="col-description">${sample.description}</td>
                            <td class="col-id">${sample.unique_id}</td>
                            <td class="col-location">
                                <select data-sample-id="${sample.unique_id}" onchange="updateSampleLocation(${JSON.stringify(sample.unique_id)}, this.value)">
                                    <option value="" ${!sample.storage_location ? "selected" : ""}>Choose a location</option>
                                    <option value="Test Lab Fridge" ${sample.storage_location === "Test Lab Fridge" ? "selected" : ""}>Test Lab Fridge</option>
                                    <option value="Test Lab Freezer" ${sample.storage_location === "Test Lab Freezer" ? "selected" : ""}>Test Lab Freezer</option>
                                    <option value="Walk-in Fridge" ${sample.storage_location === "Walk-in Fridge" ? "selected" : ""}>Walk-in Fridge</option>
                                    <option value="Walk-in Freezer" ${sample.storage_location === "Walk-in Freezer" ? "selected" : ""}>Walk-in Freezer</option>
                                    <option value="Dry Food Storage" ${sample.storage_location === "Dry Food Storage" ? "selected" : ""}>Dry Food Storage</option>
                                    <option value="Empty Case Storage" ${sample.storage_location === "Empty Case Storage" ? "selected" : ""}>Empty Case Storage</option>
                                </select>
                            </td>
                            <td class="col-pictures">
                                <button type="button" onclick="handlePictureUploadView(${JSON.stringify(sample.unique_id)})">Upload/View</button>
                            </td>
                            <td class="col-documentation">
                                <div class="doc-buttons">
                                    <button type="button" onclick="downloadDocumentation('${sample.unique_id}')" class="upload-view-button download-button">Download</button>
                                    <button type="button" onclick="uploadDocumentation('${sample.unique_id}')" class="upload-view-button upload-button">Upload</button>
                                </div>
                            </td>
                        `;
                        tableBody.appendChild(sampleRow);
                    });
                }
            });

            // Add event listener for expand/collapse buttons
            document.querySelectorAll('.expand-button').forEach(button => {
                button.addEventListener('click', function() {
                    const sanitizedOppNum = this.getAttribute('data-opp-num');
                    const groupedRows = document.querySelectorAll(`.group-${sanitizedOppNum}`);
                    const isExpanded = this.textContent === '-';

                    if (isExpanded) {
                        // Collapse
                        this.textContent = '+';
                        groupedRows.forEach(row => {
                            row.style.display = 'none';
                        });
                    } else {
                        // Expand
                        this.textContent = '-';
                        groupedRows.forEach(row => {
                            row.style.display = '';
                        });
                    }
                });
            });
        }); // Properly close the DOMContentLoaded function

        // Functions that should be globally accessible
        function handlePictureUploadView(sampleId) {
            currentSampleId = sampleId;
            // Open the modal
            document.getElementById('uploadModal').style.display = 'block';

            // Clear previous thumbnails
            document.getElementById('thumbnailsContainer').innerHTML = '';

            // Fetch existing images for this sample and display thumbnails
            fetch("{% url 'get_sample_images' %}?sample_id=" + sampleId)
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    displayThumbnails(data.images);
                } else {
                    console.error('Error fetching images:', data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }

        function selectFiles() {
            // Create a hidden file input element
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.multiple = true;
            fileInput.accept = 'image/*';
            fileInput.style.display = 'none';

            // Append the file input to the body
            document.body.appendChild(fileInput);

            // Trigger the file input click event to open the file dialog
            fileInput.click();

            // Handle file selection
            fileInput.addEventListener('change', function() {
                const files = fileInput.files;
                if (files.length > 0) {
                    uploadFiles(files, currentSampleId);
                }
                // Remove the file input after use
                document.body.removeChild(fileInput);
            });
        }

        function uploadFiles(files, sampleId) {
            const formData = new FormData();
            for (let i = 0; i < files.length; i++) {
                formData.append('files', files[i]);
            }
            formData.append('sample_id', sampleId);

            fetch("{% url 'upload_files' %}", {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': csrftoken
                },
                credentials: 'same-origin'  // Include cookies in the request
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => { throw err; });
                }
                return response.json();
            })
            .then(data => {
                if (data.status === 'success') {
                    // The files were uploaded successfully; no alert needed.
                    handlePictureUploadView(sampleId);
                    // Start polling for full-size images
                    var uploadedImageIds = data.image_ids;
                    pollForFullSizeImages(sampleId, uploadedImageIds);
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                if (error.error) {
                    alert('Error: ' + error.error);
                } else {
                    alert('An unexpected error occurred.');
                }
            });
        }

        function displayThumbnails(imageDataArray) {
            // Store the image data globally
            window.currentImageDataArray = imageDataArray;

            const thumbnailsContainer = document.getElementById('thumbnailsContainer');
            // Clear existing thumbnails
            thumbnailsContainer.innerHTML = '';

            const thumbnailWidth = 120; // Width of each thumbnail including padding/margin
            const gap = 10;             // Gap between thumbnails
            const maxModalWidth = window.innerWidth * 0.9; // 90% of viewport width as max
            const minModalWidth = 600;  // Set your desired minimum modal width here

            // Determine the number of thumbnails per row that can fit within maxModalWidth
            const thumbnailsPerRow = Math.floor((maxModalWidth + gap) / (thumbnailWidth + gap)) || 1;
            const totalThumbnails = imageDataArray.length;

            // Calculate the required modal width based on thumbnails
            const columns = Math.min(totalThumbnails, thumbnailsPerRow);
            const calculatedWidth = columns * (thumbnailWidth + gap) - gap; // Subtract extra gap at the end

            // Ensure the modal width is at least the minimum width
            const neededWidth = Math.max(calculatedWidth, minModalWidth);

            // Adjust the modal width
            const modalDialog = document.querySelector('.upload-modal .modal-dialog');
            modalDialog.style.width = neededWidth + 'px';

            imageDataArray.forEach((imageData, index) => {
                const wrapper = document.createElement('div');
                wrapper.classList.add('thumbnail-wrapper');

                // Create an anchor tag linking to the full-size image
                const link = document.createElement('a');
                link.href = imageData.full_size_url || imageData.url;  // Use full_size_url if available
                link.target = '_blank';  // Open in a new tab or modify as needed

                link.addEventListener('click', function(event) {
                    event.preventDefault();
                    if (imageData.full_size_url) {
                        // Pass the index instead of the URL
                        viewFullSizeImage(index);
                    } else {
                        alert('The full-size image is still being processed. Please try again shortly.');
                    }
                });

                const img = document.createElement('img');
                img.src = imageData.url;

                link.appendChild(img);

                const deleteButton = document.createElement('button');
                deleteButton.classList.add('delete-button');
                deleteButton.textContent = '×';

                // Add event listener to delete button
                deleteButton.addEventListener('click', function() {
                    deleteImage(imageData.id, wrapper);
                });

                wrapper.appendChild(link);  // Append the link to the wrapper
                wrapper.appendChild(deleteButton);
                thumbnailsContainer.appendChild(wrapper);
            });
        }

        function deleteImage(imageId, thumbnailElement) {
            const formData = new FormData();
            formData.append('image_id', imageId);

            fetch("{% url 'delete_sample_image' %}", {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': csrftoken
                },
                credentials: 'same-origin'
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // Remove the thumbnail element from the DOM
                    thumbnailElement.parentNode.removeChild(thumbnailElement);
                } else {
                    alert('Error deleting image: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An unexpected error occurred while deleting the image.');
            });
        }

        function closeUploadModal() {
            document.getElementById('uploadModal').style.display = 'none';
            currentSampleId = null;
        }
    </script>
</body>
</html>
