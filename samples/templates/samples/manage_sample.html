<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Manage Sample {{ sample.unique_id }}</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 0;
        }
        
        .container {
            background: white;
            min-height: 100vh;
            max-width: 500px;
            margin: 0 auto;
            box-shadow: 0 0 40px rgba(0,0,0,0.2);
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
            font-weight: 600;
        }
        
        .sample-id {
            background: rgba(255,255,255,0.2);
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 18px;
            font-weight: 500;
            margin-top: 10px;
        }
        
        .status-message {
            margin: 0;
            padding: 15px 20px;
            text-align: center;
            display: none;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .status-message.success {
            background-color: #d4edda;
            color: #155724;
        }
        
        .status-message.error {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .audit-status {
            margin: 0;
            padding: 20px;
            text-align: center;
            font-weight: 600;
            display: none;
            animation: slideDown 0.3s ease;
        }
        
        .audit-status.warning {
            background: linear-gradient(135deg, #fff3cd 0%, #ffe8a1 100%);
            color: #856404;
            border-bottom: 2px solid #ffc107;
        }
        
        .audit-status.overdue {
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
            color: #721c24;
            border-bottom: 2px solid #dc3545;
            animation: pulse 2s infinite;
        }
        
        .audit-status.ok {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            color: #155724;
            border-bottom: 2px solid #28a745;
        }
        
        .audit-status-title {
            font-size: 18px;
            margin-bottom: 5px;
        }
        
        .audit-status-detail {
            font-size: 14px;
            font-weight: 400;
            opacity: 0.9;
        }
        
        @keyframes slideDown {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.02);
            }
        }
        
        .content {
            padding: 20px;
        }
        
        .info-section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
        }
        
        .info-group {
            margin-bottom: 18px;
        }
        
        .info-group:last-child {
            margin-bottom: 0;
        }
        
        .info-label {
            font-size: 12px;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 5px;
            font-weight: 600;
        }
        
        .info-value {
            font-size: 16px;
            color: #2c3e50;
            line-height: 1.4;
        }
        
        .action-section {
            margin-top: 30px;
        }
        
        .action-group {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
        }
        
        .action-group.active {
            border-color: #667eea;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.1);
        }
        
        .action-label {
            font-size: 14px;
            color: #495057;
            font-weight: 600;
            margin-bottom: 12px;
            display: block;
        }
        
        select {
            width: 100%;
            padding: 14px;
            font-size: 16px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            background: white;
            color: #2c3e50;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 14px center;
            background-size: 20px;
            padding-right: 45px;
            transition: all 0.3s ease;
        }
        
        select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .toggle-button {
            width: 100%;
            padding: 16px;
            font-size: 18px;
            font-weight: 600;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            background: white;
            color: #6c757d;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .toggle-button:active {
            transform: scale(0.98);
        }
        
        .toggle-button.toggled {
            background: #28a745;
            color: white;
            border-color: #28a745;
        }
        
        .toggle-button.toggled::after {
            content: '✓';
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 20px;
        }
        
        .danger-zone {
            margin-top: 40px;
            padding-top: 30px;
            border-top: 2px solid #f8f9fa;
        }
        
        .danger-zone-header {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .danger-zone-title {
            font-size: 14px;
            color: #dc3545;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .remove-btn {
            width: 100%;
            padding: 18px;
            font-size: 16px;
            font-weight: 600;
            border: 2px solid #dc3545;
            border-radius: 8px;
            background: white;
            color: #dc3545;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .remove-btn:hover {
            background: #dc3545;
            color: white;
        }
        
        .remove-btn:active {
            transform: scale(0.98);
        }
        
        .remove-btn.confirm-mode {
            background: #dc3545;
            color: white;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(220, 53, 69, 0); }
            100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); }
        }
        
        .confirm-text {
            display: none;
            margin-top: 10px;
            padding: 10px;
            background: #fff5f5;
            border: 1px solid #feb2b2;
            border-radius: 8px;
            color: #c53030;
            font-size: 14px;
            text-align: center;
        }
        
        .confirm-text.visible {
            display: block;
            animation: slideDown 0.3s ease;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .updating {
            pointer-events: none;
            opacity: 0.7;
        }
        
        .updating::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.8);
            z-index: 9999;
        }
        
        .loading-spinner {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 10000;
        }
        
        .updating .loading-spinner {
            display: block;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @media (max-width: 500px) {
            .container {
                box-shadow: none;
            }
        }
        
        /* Image Section Styles */
        .image-section {
            margin-bottom: 25px;
        }
        
        .image-container {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
        }
        
        .image-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .image-label {
            font-size: 14px;
            color: #495057;
            font-weight: 600;
        }
        
        .upload-btn {
            padding: 8px 16px;
            font-size: 14px;
            font-weight: 600;
            border: 2px solid #667eea;
            border-radius: 8px;
            background: white;
            color: #667eea;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .upload-btn:hover {
            background: #667eea;
            color: white;
        }
        
        .upload-btn:active {
            transform: scale(0.98);
        }
        
        .upload-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Scrollable Thumbnail Container */
        .thumbnail-scroll-container {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding: 10px 0;
            min-height: 120px;
            align-items: center;
            transition: background-color 0.3s ease;
        }
        
        .thumbnail-scroll-container.selecting {
            background: rgba(102, 126, 234, 0.05);
            border-radius: 8px;
            padding: 10px;
        }
        
        .thumbnail-scroll-container::-webkit-scrollbar {
            height: 8px;
        }
        
        .thumbnail-scroll-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        .thumbnail-scroll-container::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        
        .thumbnail-scroll-container::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        .thumbnail-wrapper {
            position: relative;
            flex-shrink: 0;
            width: 100px;
            height: 100px;
            -webkit-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
        }
        
        /* Selection mode styles */
        .thumbnail-wrapper.selected::after {
            content: '✓';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(102, 126, 234, 0.8);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            font-weight: bold;
            border-radius: 8px;
            pointer-events: none;
        }
        
        .selecting .thumbnail-wrapper {
            cursor: pointer;
        }
        
        .selecting .thumbnail-wrapper:active {
            transform: scale(0.95);
        }
        
        /* Hide hover delete button in selection mode */
        .selecting .delete-image-btn {
            display: none !important;
        }
        
        .thumbnail-wrapper img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 8px;
            cursor: pointer;
            -webkit-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
            pointer-events: auto;
            transition: transform 0.2s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .thumbnail-wrapper img:hover {
            transform: scale(1.05);
        }
        
        .thumbnail-wrapper .delete-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(220, 53, 69, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        
        .thumbnail-wrapper:hover .delete-btn {
            display: flex;
        }
        
        .thumbnail-wrapper .delete-btn:hover {
            background: #dc3545;
            transform: scale(1.1);
        }
        
        .no-images-message {
            color: #6c757d;
            font-style: italic;
            text-align: center;
            padding: 20px;
        }
        
        /* Selection controls */
        .selection-controls {
            display: none;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
        }
        
        .selection-controls.active {
            display: flex;
        }
        
        .selection-info {
            flex: 1;
            font-size: 14px;
            color: #495057;
            font-weight: 600;
        }
        
        .selection-btn {
            padding: 8px 16px;
            font-size: 14px;
            font-weight: 600;
            border-radius: 8px;
            border: 2px solid;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .delete-selected-btn {
            background: white;
            color: #dc3545;
            border-color: #dc3545;
        }
        
        .delete-selected-btn:hover {
            background: #dc3545;
            color: white;
        }
        
        .cancel-selection-btn {
            background: white;
            color: #6c757d;
            border-color: #6c757d;
        }
        
        .cancel-selection-btn:hover {
            background: #6c757d;
            color: white;
        }
        
        .selection-btn:active {
            transform: scale(0.98);
        }
        
        /* Loading placeholder for uploads */
        .thumbnail-placeholder {
            width: 100px;
            height: 100px;
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: 8px;
            flex-shrink: 0;
        }
        
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        /* Upload Progress Bar */
        .upload-progress {
            display: none;
            margin-top: 10px;
        }
        
        .progress-bar-container {
            background: #f0f0f0;
            border-radius: 4px;
            overflow: hidden;
            height: 20px;
            margin-top: 5px;
        }
        
        .progress-bar {
            background: #667eea;
            height: 100%;
            width: 0;
            transition: width 0.3s ease;
        }
        
        .progress-text {
            font-size: 12px;
            color: #6c757d;
            margin-top: 5px;
        }
        
        /* Full-size Image Modal */
        .image-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 10001;
            align-items: center;
            justify-content: center;
        }
        
        .image-modal-content {
            position: relative;
            max-width: 90vw;
            max-height: 90vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .image-modal-content img {
            max-width: 100%;
            max-height: 90vh;
            object-fit: contain;
        }
        
        .image-modal-close {
            position: absolute;
            top: 20px;
            right: 40px;
            color: white;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
            z-index: 10002;
        }
        
        .image-modal-close:hover {
            color: #ccc;
        }
        
        .image-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            color: white;
            font-size: 30px;
            font-weight: bold;
            cursor: pointer;
            padding: 10px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 4px;
            user-select: none;
        }
        
        .image-nav:hover {
            background: rgba(0, 0, 0, 0.8);
        }
        
        .image-nav.prev {
            left: 20px;
        }
        
        .image-nav.next {
            right: 20px;
        }
        
        .image-modal-filename {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px 20px;
            border-radius: 4px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Manage Sample</h1>
            <div class="sample-id">{{ sample.unique_id }}</div>
        </div>
        
        <div id="status-message" class="status-message"></div>
        
        <!-- Audit Status Display -->
        <div id="audit-status" class="audit-status">
            <div class="audit-status-title">Audit Required</div>
            <div class="audit-status-detail">This item needs to be audited</div>
        </div>
        
        <div class="content">
            <div class="info-section">
                <div class="info-group">
                    <div class="info-label">Date Received</div>
                    <div class="info-value">{{ sample.date_received }}</div>
                </div>
                
                <div class="info-group">
                    <div class="info-label">Customer</div>
                    <div class="info-value">{{ sample.customer }}</div>
                </div>
                
                <div class="info-group">
                    <div class="info-label">RSM</div>
                    <div class="info-value">{{ sample.rsm }}</div>
                </div>
                
                <div class="info-group">
                    <div class="info-label">Opportunity Number</div>
                    <div class="info-value">{{ sample.opportunity_number }}</div>
                </div>
                
                <div class="info-group">
                    <div class="info-label">Description</div>
                    <div class="info-value">{{ sample.description }}</div>
                </div>
                
                {% if sample.storage_location %}
                <div class="info-group">
                    <div class="info-label">Current Location</div>
                    <div class="info-value">{{ sample.storage_location }}</div>
                </div>
                
                {% if sample.location_assigned_date %}
                <div class="info-group">
                    <div class="info-label">In Location Since</div>
                    <div class="info-value">{{ sample.location_assigned_date|date:"M d, Y g:i A" }}</div>
                </div>
                {% endif %}
                
                {% if sample.audit_due_date %}
                <div class="info-group">
                    <div class="info-label">Audit Due</div>
                    <div class="info-value">{{ sample.audit_due_date|date:"M d, Y" }}</div>
                </div>
                {% endif %}
                
                {% if sample.last_audit_date %}
                <div class="info-group">
                    <div class="info-label">Last Audited</div>
                    <div class="info-value">{{ sample.last_audit_date|date:"M d, Y g:i A" }}</div>
                </div>
                {% endif %}
                {% endif %}
            </div>
            
            <div class="action-section">
                <form method="POST" action="" id="sample-form">
                    {% csrf_token %}
                    
                    <!-- Image Section -->
                    <div class="image-section">
                        <div class="image-container">
                            <div class="image-header" id="normal-header">
                                <label class="image-label">Sample Images</label>
                                <button type="button" id="upload-btn" class="upload-btn" onclick="selectFiles()">Upload</button>
                                <input type="file" id="file-input" accept="image/*" multiple style="display: none;">
                            </div>
                            <div class="selection-controls" id="selection-controls">
                                <span class="selection-info" id="selection-info">0 selected</span>
                                <button type="button" class="selection-btn delete-selected-btn" onclick="deleteSelected()">Delete</button>
                                <button type="button" class="selection-btn cancel-selection-btn" onclick="cancelSelection()">Cancel</button>
                            </div>
                            <div id="thumbnail-container" class="thumbnail-scroll-container">
                                <!-- Thumbnails will be loaded here -->
                                <div class="no-images-message">No images uploaded yet</div>
                            </div>
                            <div id="upload-progress" class="upload-progress">
                                <div class="progress-text">Uploading...</div>
                                <div class="progress-bar-container">
                                    <div id="progress-bar" class="progress-bar"></div>
                                </div>
                                <div id="progress-percent" class="progress-text">0%</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="action-group">
                        <label class="action-label" for="location">Storage Location</label>
                        <select id="location" name="location">
                            <option value="Choose a Location" {% if not sample.storage_location or sample.storage_location == "Choose a Location" %}selected{% endif %}>Choose a Location</option>
                            <option value="Cooler #2" {% if sample.storage_location == "Cooler #2" or sample.storage_location == "Test Lab Fridge" %}selected{% endif %}>Cooler #2</option>
                            <option value="Freezer #5" {% if sample.storage_location == "Freezer #5" or sample.storage_location == "Test Lab Freezer" %}selected{% endif %}>Freezer #5</option>
                            <option value="Freezer #9" {% if sample.storage_location == "Freezer #9" %}selected{% endif %}>Freezer #9</option>
                            <option value="Walk-in Fridge" {% if sample.storage_location == "Walk-in Fridge" %}selected{% endif %}>Walk-in Fridge</option>
                            <option value="Walk-in Freezer" {% if sample.storage_location == "Walk-in Freezer" %}selected{% endif %}>Walk-in Freezer</option>
                            <option value="Dry Food Storage" {% if sample.storage_location == "Dry Food Storage" %}selected{% endif %}>Dry Food Storage</option>
                            <option value="Empty Case Storage" {% if sample.storage_location == "Empty Case Storage" %}selected{% endif %}>Empty Case Storage</option>
                        </select>
                    </div>
                    
                    <div class="action-group">
                        <label class="action-label" for="audit-toggle">Audit Status</label>
                        <button type="button" id="audit-toggle" class="toggle-button" aria-pressed="false">
                            <span class="button-text">Mark as Audited</span>
                        </button>
                        <input type="hidden" id="audit" name="audit" value="false">
                    </div>
                    
                    <div class="danger-zone">
                        <button type="button" id="remove-from-inventory" class="remove-btn">
                            Remove from Inventory
                        </button>
                        <div id="confirm-text" class="confirm-text">
                            Click again to confirm removal. This action cannot be undone.
                        </div>
                    </div>
                </form>
            </div>
        </div>
        
        <div class="loading-spinner">
            <div class="spinner"></div>
        </div>
    </div>
    
    <!-- Full-size Image Modal -->
    <div id="imageModal" class="image-modal">
        <span class="image-modal-close" onclick="closeImageModal()">&times;</span>
        <div class="image-modal-content">
            <span class="image-nav prev" onclick="showPrevImage()">&#10094;</span>
            <img id="modal-image" src="" alt="">
            <span class="image-nav next" onclick="showNextImage()">&#10095;</span>
        </div>
        <div class="image-modal-filename" id="modal-filename"></div>
    </div>

    <script>
        // Global variables for image handling
        let currentImages = [];
        let currentImageIndex = 0;
        
        // Selection mode variables
        let isSelectionMode = false;
        let selectedImages = new Set();
        let longPressTimer = null;
        let touchStartTime = 0;
        
        document.addEventListener("DOMContentLoaded", function() {
            const auditToggle = document.getElementById('audit-toggle');
            const auditInput = document.getElementById('audit');
            const locationSelect = document.getElementById('location');
            const statusMessage = document.getElementById('status-message');
            const auditStatusDiv = document.getElementById('audit-status');
            const removeBtn = document.getElementById('remove-from-inventory');
            const confirmText = document.getElementById('confirm-text');
            const sampleId = '{{ sample.unique_id }}';
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            let removeClickCount = 0;
            let removeTimeout;
            
            // Audit status data from Django
            const auditDueDate = {% if sample.audit_due_date %}"{{ sample.audit_due_date|date:'Y-m-d' }}"{% else %}null{% endif %};
            const daysUntilAudit = {% if sample.days_until_audit is not None %}{{ sample.days_until_audit }}{% else %}null{% endif %};
            
            // Function to update audit status display
            function updateAuditStatus() {
                if (!auditDueDate || !locationSelect.value || locationSelect.value === 'Choose a Location') {
                    auditStatusDiv.style.display = 'none';
                    return;
                }
                
                const titleElement = auditStatusDiv.querySelector('.audit-status-title');
                const detailElement = auditStatusDiv.querySelector('.audit-status-detail');
                
                if (daysUntilAudit !== null) {
                    if (daysUntilAudit < 0) {
                        // Overdue
                        auditStatusDiv.className = 'audit-status overdue';
                        titleElement.textContent = '⚠️ Audit Overdue';
                        const daysOverdue = Math.abs(daysUntilAudit);
                        detailElement.textContent = `This item is ${daysOverdue} day${daysOverdue !== 1 ? 's' : ''} overdue for audit`;
                        auditStatusDiv.style.display = 'block';
                    } else if (daysUntilAudit <= 7) {
                        // Warning - due soon
                        auditStatusDiv.className = 'audit-status warning';
                        titleElement.textContent = '⏰ Audit Due Soon';
                        detailElement.textContent = `Audit due in ${daysUntilAudit} day${daysUntilAudit !== 1 ? 's' : ''} (${new Date(auditDueDate).toLocaleDateString()})`;
                        auditStatusDiv.style.display = 'block';
                    } else {
                        // OK - not due yet
                        auditStatusDiv.className = 'audit-status ok';
                        titleElement.textContent = '✓ Audit Status OK';
                        detailElement.textContent = `Next audit due: ${new Date(auditDueDate).toLocaleDateString()} (${daysUntilAudit} days)`;
                        auditStatusDiv.style.display = 'block';
                    }
                }
            }
            
            // Initialize audit status display
            updateAuditStatus();

            // Function to show status message
            function showStatus(message, type) {
                statusMessage.textContent = message;
                statusMessage.className = 'status-message ' + type;
                statusMessage.style.display = 'block';
                
                // Auto-hide after 3 seconds
                setTimeout(() => {
                    statusMessage.style.display = 'none';
                }, 3000);
            }

            // Function to update sample via AJAX
            function updateSample(data) {
                document.body.classList.add('updating');
                
                fetch(`/manage_sample/${sampleId}/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfToken,
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams(data)
                })
                .then(response => {
                    if (response.ok) {
                        showStatus('Updated successfully', 'success');
                        
                        // Add active effect to changed element
                        if (data.location) {
                            locationSelect.parentElement.classList.add('active');
                            setTimeout(() => {
                                locationSelect.parentElement.classList.remove('active');
                            }, 500);
                        }
                    } else {
                        showStatus('Update failed', 'error');
                    }
                })
                .catch(error => {
                    showStatus('Connection error', 'error');
                    console.error('Error:', error);
                })
                .finally(() => {
                    document.body.classList.remove('updating');
                });
            }

            // Handle location change
            locationSelect.addEventListener('change', function() {
                updateSample({
                    'location': this.value,
                    'audit': auditInput.value
                });
                // Reload page after a short delay to get new audit dates
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            });

            // Handle audit toggle
            auditToggle.addEventListener('click', function() {
                auditToggle.classList.toggle('toggled');
                const isToggled = auditToggle.classList.contains('toggled');
                auditInput.value = isToggled ? 'true' : 'false';
                auditToggle.setAttribute('aria-pressed', isToggled);
                
                // Update button text
                const buttonText = auditToggle.querySelector('.button-text');
                buttonText.textContent = isToggled ? 'Audited' : 'Mark as Audited';
                
                // Add active effect
                auditToggle.parentElement.classList.add('active');
                setTimeout(() => {
                    auditToggle.parentElement.classList.remove('active');
                }, 500);
                
                // Update immediately when toggled
                updateSample({
                    'location': locationSelect.value,
                    'audit': auditInput.value
                });
                
                // Reload page if marking as audited to get new audit dates
                if (isToggled) {
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                }
            });

            // Set the audit button state based on the initial value
            const auditInitialValue = "{{ sample.audit|yesno:'true,false'|escapejs }}";
            const isInitiallyToggled = (auditInitialValue === 'true');
            if (isInitiallyToggled) {
                auditToggle.classList.add('toggled');
                auditToggle.querySelector('.button-text').textContent = 'Audited';
            }
            auditInput.value = isInitiallyToggled ? 'true' : 'false';
            auditToggle.setAttribute('aria-pressed', isInitiallyToggled);

            // Handle Remove from Inventory with two-step confirmation
            removeBtn.addEventListener('click', function() {
                removeClickCount++;
                
                if (removeClickCount === 1) {
                    // First click - show confirmation
                    removeBtn.classList.add('confirm-mode');
                    removeBtn.textContent = 'Click Again to Confirm';
                    confirmText.classList.add('visible');
                    
                    // Reset after 5 seconds if no second click
                    removeTimeout = setTimeout(() => {
                        resetRemoveButton();
                    }, 5000);
                } else if (removeClickCount === 2) {
                    // Second click - perform removal
                    clearTimeout(removeTimeout);
                    
                    document.body.classList.add('updating');
                    
                    const formData = new FormData();
                    formData.append('ids', JSON.stringify([sampleId]));
                    formData.append('csrfmiddlewaretoken', csrfToken);

                    fetch('/remove_from_inventory/', {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            showStatus('Sample removed from inventory', 'success');
                            removeBtn.textContent = 'Removed';
                            removeBtn.disabled = true;
                            setTimeout(() => {
                                window.location.href = '/';
                            }, 1500);
                        } else {
                            showStatus('Failed to remove sample', 'error');
                            document.body.classList.remove('updating');
                            resetRemoveButton();
                        }
                    })
                    .catch(error => {
                        showStatus('Connection error', 'error');
                        console.error('Error:', error);
                        document.body.classList.remove('updating');
                        resetRemoveButton();
                    });
                }
            });
            
            function resetRemoveButton() {
                removeClickCount = 0;
                removeBtn.classList.remove('confirm-mode');
                removeBtn.textContent = 'Remove from Inventory';
                confirmText.classList.remove('visible');
                clearTimeout(removeTimeout);
            }
            
            // Reset remove button if user clicks elsewhere
            document.addEventListener('click', function(event) {
                if (removeClickCount === 1 && !removeBtn.contains(event.target)) {
                    resetRemoveButton();
                }
            });
            
            // Load images on page load
            loadImages();
        });
        
        // Image handling functions
        function loadImages() {
            fetch('/get_sample_images/?sample_id=' + '{{ sample.unique_id }}')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        displayThumbnails(data.images);
                    } else {
                        console.error('Error fetching images:', data.error);
                    }
                })
                .catch(error => {
                    console.error('Error loading images:', error);
                });
        }
        
        function displayThumbnails(images) {
            currentImages = images;
            const container = document.getElementById('thumbnail-container');
            
            if (images.length === 0) {
                container.innerHTML = '<div class="no-images-message">No images uploaded yet</div>';
                cancelSelection(); // Exit selection mode if no images
                return;
            }
            
            container.innerHTML = '';
            
            images.forEach((image, index) => {
                const wrapper = document.createElement('div');
                wrapper.className = 'thumbnail-wrapper';
                wrapper.dataset.imageId = image.id;
                
                const img = document.createElement('img');
                img.src = image.url;
                img.alt = image.filename;
                
                // Add long press detection
                wrapper.addEventListener('touchstart', (e) => handleTouchStart(e, wrapper, image.id));
                wrapper.addEventListener('touchend', (e) => handleTouchEnd(e, wrapper, image.id));
                wrapper.addEventListener('touchcancel', handleTouchCancel);
                
                // Prevent context menu on long press
                wrapper.addEventListener('contextmenu', (e) => e.preventDefault());
                
                // Mouse events for desktop
                wrapper.addEventListener('mousedown', (e) => handleMouseDown(e, wrapper, image.id));
                wrapper.addEventListener('mouseup', handleMouseUp);
                wrapper.addEventListener('mouseleave', handleMouseLeave);
                
                // Click handling depends on selection mode
                wrapper.addEventListener('click', (e) => {
                    if (isSelectionMode) {
                        e.preventDefault();
                        e.stopPropagation();
                        toggleSelection(wrapper, image.id);
                    } else if (!e.target.classList.contains('delete-btn')) {
                        openImageModal(index);
                    }
                });
                
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-btn';
                deleteBtn.innerHTML = '×';
                deleteBtn.onclick = (e) => {
                    e.stopPropagation();
                    deleteImage(image.id, wrapper);
                };
                
                wrapper.appendChild(img);
                wrapper.appendChild(deleteBtn);
                container.appendChild(wrapper);
            });
        }
        
        function selectFiles() {
            document.getElementById('file-input').click();
        }
        
        // File input change handler
        document.getElementById('file-input').addEventListener('change', function(e) {
            const files = e.target.files;
            if (files.length > 0) {
                uploadFiles(files);
            }
        });
        
        function uploadFiles(files) {
            const formData = new FormData();
            formData.append('sample_id', '{{ sample.unique_id }}');
            
            let totalSize = 0;
            for (let file of files) {
                formData.append('files', file);
                totalSize += file.size;
            }
            
            const progressContainer = document.getElementById('upload-progress');
            const progressBar = document.getElementById('progress-bar');
            const progressPercent = document.getElementById('progress-percent');
            const uploadBtn = document.getElementById('upload-btn');
            const container = document.getElementById('thumbnail-container');
            
            progressContainer.style.display = 'block';
            uploadBtn.disabled = true;
            
            // Add loading placeholders
            const existingContent = container.innerHTML;
            if (container.querySelector('.no-images-message')) {
                container.innerHTML = '';
            }
            for (let i = 0; i < files.length; i++) {
                const placeholder = document.createElement('div');
                placeholder.className = 'thumbnail-placeholder';
                container.appendChild(placeholder);
            }
            
            const xhr = new XMLHttpRequest();
            
            xhr.upload.addEventListener('progress', function(e) {
                if (e.lengthComputable) {
                    const percentComplete = Math.round((e.loaded / e.total) * 100);
                    progressBar.style.width = percentComplete + '%';
                    progressPercent.textContent = percentComplete + '%';
                }
            });
            
            xhr.addEventListener('load', function() {
                if (xhr.status === 200) {
                    const response = JSON.parse(xhr.responseText);
                    if (response.status === 'success') {
                        // Reload all images
                        loadImages();
                        progressContainer.style.display = 'none';
                        progressBar.style.width = '0%';
                        progressPercent.textContent = '0%';
                    } else {
                        alert('Upload failed: ' + (response.error || 'Unknown error'));
                        // Remove placeholders and restore original content
                        container.innerHTML = existingContent;
                    }
                } else {
                    alert('Upload failed with status: ' + xhr.status);
                    container.innerHTML = existingContent;
                }
                uploadBtn.disabled = false;
                // Clear file input
                document.getElementById('file-input').value = '';
            });
            
            xhr.addEventListener('error', function() {
                alert('Network error occurred during upload');
                container.innerHTML = existingContent;
                uploadBtn.disabled = false;
                progressContainer.style.display = 'none';
            });
            
            xhr.open('POST', '/upload_files/');
            xhr.setRequestHeader('X-CSRFToken', csrfToken);
            xhr.send(formData);
        }
        
        function deleteImage(imageId, thumbnailElement) {
            if (!confirm('Are you sure you want to delete this image?')) {
                return;
            }
            
            const formData = new FormData();
            formData.append('image_id', imageId);
            
            fetch('/delete_sample_image/', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': csrfToken
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    thumbnailElement.remove();
                    // Update currentImages array
                    currentImages = currentImages.filter(img => img.id !== imageId);
                    // Check if container is empty
                    const container = document.getElementById('thumbnail-container');
                    if (container.children.length === 0) {
                        container.innerHTML = '<div class="no-images-message">No images uploaded yet</div>';
                    }
                } else {
                    alert('Failed to delete image: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                alert('Error deleting image');
                console.error('Error:', error);
            });
        }
        
        // Selection mode functions
        function handleTouchStart(e, wrapper, imageId) {
            touchStartTime = Date.now();
            longPressTimer = setTimeout(() => {
                if (!isSelectionMode) {
                    enterSelectionMode();
                    toggleSelection(wrapper, imageId);
                    // Haptic feedback if available
                    if (navigator.vibrate) {
                        navigator.vibrate(50);
                    }
                }
            }, 500); // 500ms for long press
        }
        
        function handleTouchEnd(e, wrapper, imageId) {
            const touchDuration = Date.now() - touchStartTime;
            if (longPressTimer) {
                clearTimeout(longPressTimer);
                longPressTimer = null;
            }
            
            // If it was a long press, prevent the click from opening modal
            if (touchDuration >= 500) {
                e.preventDefault();
                e.stopPropagation();
            }
        }
        
        function handleTouchCancel() {
            if (longPressTimer) {
                clearTimeout(longPressTimer);
                longPressTimer = null;
            }
        }
        
        function handleMouseDown(e, wrapper, imageId) {
            // Only respond to left click
            if (e.button !== 0) return;
            
            longPressTimer = setTimeout(() => {
                if (!isSelectionMode) {
                    enterSelectionMode();
                    toggleSelection(wrapper, imageId);
                }
            }, 500);
        }
        
        function handleMouseUp() {
            if (longPressTimer) {
                clearTimeout(longPressTimer);
                longPressTimer = null;
            }
        }
        
        function handleMouseLeave() {
            if (longPressTimer) {
                clearTimeout(longPressTimer);
                longPressTimer = null;
            }
        }
        
        function enterSelectionMode() {
            isSelectionMode = true;
            // Don't clear selected images - keep any that were just selected
            
            const container = document.getElementById('thumbnail-container');
            container.classList.add('selecting');
            
            document.getElementById('normal-header').style.display = 'none';
            document.getElementById('selection-controls').classList.add('active');
            
            updateSelectionInfo();
        }
        
        function cancelSelection() {
            isSelectionMode = false;
            selectedImages.clear();
            
            const container = document.getElementById('thumbnail-container');
            container.classList.remove('selecting');
            
            // Remove selected class from all thumbnails
            document.querySelectorAll('.thumbnail-wrapper.selected').forEach(wrapper => {
                wrapper.classList.remove('selected');
            });
            
            document.getElementById('normal-header').style.display = 'flex';
            document.getElementById('selection-controls').classList.remove('active');
        }
        
        function toggleSelection(wrapper, imageId) {
            if (selectedImages.has(imageId)) {
                selectedImages.delete(imageId);
                wrapper.classList.remove('selected');
            } else {
                selectedImages.add(imageId);
                wrapper.classList.add('selected');
            }
            updateSelectionInfo();
        }
        
        function updateSelectionInfo() {
            const info = document.getElementById('selection-info');
            const count = selectedImages.size;
            info.textContent = count === 1 ? '1 selected' : `${count} selected`;
            
            // Update delete button text
            const deleteBtn = document.querySelector('.delete-selected-btn');
            if (deleteBtn) {
                deleteBtn.textContent = count > 0 ? `Delete (${count})` : 'Delete';
            }
        }
        
        function deleteSelected() {
            const count = selectedImages.size;
            if (count === 0) return;
            
            const message = count === 1 
                ? 'Are you sure you want to delete this image?' 
                : `Are you sure you want to delete ${count} images?`;
                
            if (!confirm(message)) {
                return;
            }
            
            // Delete all selected images
            const deletePromises = Array.from(selectedImages).map(imageId => {
                const formData = new FormData();
                formData.append('image_id', imageId);
                
                return fetch('/delete_sample_image/', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': csrfToken
                    }
                });
            });
            
            Promise.all(deletePromises)
                .then(responses => Promise.all(responses.map(r => r.json())))
                .then(results => {
                    // Remove deleted thumbnails
                    selectedImages.forEach(imageId => {
                        const wrapper = document.querySelector(`[data-image-id="${imageId}"]`);
                        if (wrapper) wrapper.remove();
                        // Update currentImages array
                        currentImages = currentImages.filter(img => img.id !== imageId);
                    });
                    
                    // Check if any images remain
                    const container = document.getElementById('thumbnail-container');
                    if (container.children.length === 0) {
                        container.innerHTML = '<div class="no-images-message">No images uploaded yet</div>';
                    }
                    
                    // Exit selection mode
                    cancelSelection();
                })
                .catch(error => {
                    console.error('Error deleting images:', error);
                    alert('Failed to delete some images');
                });
        }
        
        // Add keyboard shortcut to exit selection mode
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && isSelectionMode) {
                cancelSelection();
            }
        });
        
        // Full-size image modal functions
        function openImageModal(index) {
            currentImageIndex = index;
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('modal-image');
            const filenameDiv = document.getElementById('modal-filename');
            const image = currentImages[index];
            
            // Use full-size URL if available, otherwise use thumbnail
            modalImg.src = image.full_size_url || image.url;
            filenameDiv.textContent = image.filename;
            
            modal.style.display = 'flex';
            
            // Update navigation buttons visibility
            document.querySelector('.image-nav.prev').style.display = index > 0 ? 'block' : 'none';
            document.querySelector('.image-nav.next').style.display = index < currentImages.length - 1 ? 'block' : 'none';
        }
        
        function closeImageModal() {
            document.getElementById('imageModal').style.display = 'none';
        }
        
        function showPrevImage() {
            if (currentImageIndex > 0) {
                openImageModal(currentImageIndex - 1);
            }
        }
        
        function showNextImage() {
            if (currentImageIndex < currentImages.length - 1) {
                openImageModal(currentImageIndex + 1);
            }
        }
        
        // Keyboard navigation for image modal
        document.addEventListener('keydown', function(e) {
            const modal = document.getElementById('imageModal');
            if (modal.style.display === 'flex') {
                if (e.key === 'ArrowLeft') {
                    showPrevImage();
                } else if (e.key === 'ArrowRight') {
                    showNextImage();
                } else if (e.key === 'Escape') {
                    closeImageModal();
                }
            }
        });
        
        // Close modal when clicking outside the image
        document.getElementById('imageModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeImageModal();
            }
        });
    </script>
</body>
</html>